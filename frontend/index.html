<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場分析報告系統 - 即時黃金價格</title>
    <link rel="icon" type="image/x-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📈</text></svg>">
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chartjs-adapter-moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <script>
        // 確保註解插件正確載入
        if (typeof Chart !== 'undefined') {
            console.log('✅ Chart.js 已載入');
            console.log('Chart.js 版本:', Chart.version);
        }
        // 檢查註解插件是否正確載入
        if (typeof Chart !== 'undefined' && Chart.registry && Chart.registry.getController) {
            console.log('✅ Chart.js 註解插件已載入');
        } else {
            console.warn('⚠️ Chart.js 註解插件未載入');
        }
    </script>
    <script>
        // 確保 Chart.js 時間適配器正確載入
        if (typeof Chart !== 'undefined') {
            Chart.defaults.locale = 'zh-TW';
        }
    </script>
</head>

<body>
    <div class="background-animation">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
        <div class="floating-shape shape-4"></div>
        <div class="floating-shape shape-5"></div>
    </div>

    <div class="container">
        <nav class="navigation">
            <div class="nav-brand">
                <div class="brand-logo">
                    <span class="logo-emoji">📈</span>
                </div>
                <span>市場分析系統</span>
            </div>
            <div class="nav-links">
                <a href="/mail" class="nav-link mail-link">
                    <i class="fas fa-envelope"></i>
                    郵件發送
                </a>
                <a href="/api/docs" class="nav-link docs-link" target="_blank">
                    <i class="fas fa-book"></i>
                    API 文檔
                </a>
                <div class="system-time" id="system-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                </div>
            </div>
        </nav>

        <header class="page-header">
            <div class="header-icon">
                <div class="header-logo">
                    <span class="header-emoji">📈</span>
                </div>
            </div>
            <h1>市場分析報告系統</h1>
            <p>智能情感分析 • 即時黃金價格 • 自動化報告</p>
        </header>

        <div class="main-layout">
            <!-- 左邊快速操作欄位 -->
            <div class="sidebar">
                <div class="quick-actions-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <h3>快速操作</h3>
                    </div>
                    <div class="card-content">
                        <div class="action-buttons-vertical">
                            <a href="/mail" class="action-btn primary">
                                <i class="fas fa-paper-plane"></i>
                                <span>發送郵件報告</span>
                            </a>
                            <button onclick="refreshAllData()" class="action-btn secondary" id="refresh-btn">
                                <i class="fas fa-sync"></i>
                                <span>刷新數據</span>
                            </button>
                            <button onclick="scrollToSentiment()" class="action-btn info">
                                <i class="fas fa-brain"></i>
                                <span>市場情感分析</span>
                            </button>
                            <button onclick="scrollToGoldPrice()" class="action-btn gold">
                                <i class="fas fa-coins"></i>
                                <span>黃金期貨價格</span>
                            </button>
                            <button onclick="scrollToDataDetails()" class="action-btn secondary"
                                id="quick-details-toggle">
                                <i class="fas fa-database"></i>
                                <span>詳細數據日誌</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主要內容區域 -->
            <div class="main-content">
                <!-- 市場情感分析卡片 -->
                <div class="card data-card" id="sentiment-section">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h2>市場情感分析</h2>
                        <div class="status-indicator" id="status-indicator">
                            <span class="indicator-dot"></span>
                            <span class="indicator-text">載入中...</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="market-data-display">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                                <span>正在載入市場數據...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 黃金價格卡片 -->
                <div class="card gold-price-card" id="gold-price-section">
                    <div class="card-header">
                        <div class="card-icon gold-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <h2>黃金期貨價格 (GC=F)</h2>
                        <div class="price-controls">
                            <div class="price-status" id="price-status">
                                <span class="status-dot"></span>
                                <span class="status-text">載入中...</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="price-display" id="price-display">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                                <span>正在載入黃金價格...</span>
                            </div>
                        </div>

                        <div id="gold-last-updated" class="last-updated"
                            style="text-align: right; margin-top: 1rem; font-size: 0.9em; color: var(--text-muted);">
                            <i class="fas fa-sync"></i>
                            <span>--</span>
                        </div>

                        <div class="technical-indicators" id="technical-indicators" style="display: block;">
                            <h3><i class="fas fa-chart-line"></i> 技術指標</h3>
                            <div class="indicators-grid">
                                <div class="indicator-item">
                                    <span class="indicator-label">MA5</span>
                                    <span class="indicator-value" id="ma5-value">--</span>
                                </div>
                                <div class="indicator-item">
                                    <span class="indicator-label">MA20</span>
                                    <span class="indicator-value" id="ma20-value">--</span>
                                </div>
                                <div class="indicator-item">
                                    <span class="indicator-label">MA50</span>
                                    <span class="indicator-value" id="ma50-value">--</span>
                                </div>
                                <div class="indicator-item">
                                    <span class="indicator-label">RSI</span>
                                    <span class="indicator-value" id="rsi-value">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- 增強的交易訊號監測 -->
                        <div class="enhanced-signal-display" id="enhanced-signal-display" style="display: block;">
                            <h3 style="margin-bottom: 1.2em;"><i class="fas fa-signal"></i> 交易訊號監測</h3>
                            <div class="signal-grid" style="gap: 1.2em;">
                                <div class="signal-item" id="ma-cross-signal" style="margin-bottom: 1em;">
                                    <div class="signal-header" style="margin-bottom: 0.4em;">
                                        <span class="signal-label" style="margin-right: 0.6em;">MA5/MA20 交叉</span>
                                        <span class="signal-status" id="ma-cross-status">--</span>
                                    </div>
                                    <div class="signal-description" id="ma-cross-description"
                                        style="color: var(--text-muted);">
                                        檢測是否出現黃金交叉/死亡交叉
                                    </div>
                                </div>

                                <div class="signal-item" id="rsi-signal" style="margin-bottom: 1em;">
                                    <div class="signal-header" style="margin-bottom: 0.4em;">
                                        <span class="signal-label" style="margin-right: 0.6em;">RSI 區間</span>
                                        <span class="signal-status" id="rsi-status">--</span>
                                    </div>
                                    <div class="signal-description" id="rsi-description"
                                        style="color: var(--text-muted);">
                                        RSI &gt; 70 過熱，RSI &lt; 30 過冷
                                    </div>
                                </div>


                            </div>
                        </div>

                        <div class="chart-section">
                            <div class="chart-header">
                                <h3><i class="fas fa-chart-area"></i> 價格走勢圖</h3>
                                <div class="chart-controls">
                                    <div class="line-controls">
                                        <label class="line-toggle">
                                            <input type="checkbox" id="show-ma5" checked>
                                            <span class="toggle-label">MA5</span>
                                        </label>
                                        <label class="line-toggle">
                                            <input type="checkbox" id="show-ma20" checked>
                                            <span class="toggle-label">MA20</span>
                                        </label>
                                        <label class="line-toggle">
                                            <input type="checkbox" id="show-ma125" checked>
                                            <span class="toggle-label">MA125</span>
                                        </label>
                                        <label class="line-toggle">
                                            <input type="checkbox" id="show-quarterly" checked>
                                            <span class="toggle-label">轉折點</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" id="chart-container">
                                <canvas id="goldChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 詳細數據日誌 - Accordion收合結構 -->
                <div class="card data-details-card" id="data-logs-section" style="margin-top: 2rem;">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <h2>詳細數據日誌</h2>
                        <button onclick="toggleDataDetails()" class="action-btn secondary" id="details-toggle">
                            <i class="fas fa-eye"></i>
                            <span>顯示詳情</span>
                        </button>
                    </div>
                    <div class="card-content" id="data-details" style="display: block;">
                        <div class="accordion-container">
                            <div class="accordion-item" id="system-info-accordion">
                                <div class="accordion-header" onclick="toggleAccordion('system-info-accordion')">
                                    <span><i class="fas fa-info-circle"></i> 系統資訊</span>
                                    <i class="fas fa-plus accordion-icon"></i>
                                </div>
                                <div class="accordion-content" id="system-info-content">
                                    <div class="accordion-placeholder">
                                        <span>點擊上方按鈕或使用"顯示詳情"查看系統資訊</span>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item" id="gold-price-accordion">
                                <div class="accordion-header" onclick="toggleAccordion('gold-price-accordion')">
                                    <span><i class="fas fa-coins"></i> 黃金價格詳情</span>
                                    <i class="fas fa-plus accordion-icon"></i>
                                </div>
                                <div class="accordion-content" id="gold-price-content">
                                    <div class="accordion-placeholder">
                                        <span>點擊上方按鈕或使用"顯示詳情"查看黃金價格詳情</span>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item" id="technical-indicators-accordion">
                                <div class="accordion-header"
                                    onclick="toggleAccordion('technical-indicators-accordion')">
                                    <span><i class="fas fa-chart-line"></i> 技術指標詳情</span>
                                    <i class="fas fa-plus accordion-icon"></i>
                                </div>
                                <div class="accordion-content" id="technical-indicators-content">
                                    <div class="accordion-placeholder">
                                        <span>點擊上方按鈕或使用"顯示詳情"查看技術指標詳情</span>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item" id="market-sentiment-accordion">
                                <div class="accordion-header" onclick="toggleAccordion('market-sentiment-accordion')">
                                    <span><i class="fas fa-brain"></i> 市場情感分析詳情</span>
                                    <i class="fas fa-plus accordion-icon"></i>
                                </div>
                                <div class="accordion-content" id="market-sentiment-content">
                                    <div class="accordion-placeholder">
                                        <span>點擊上方按鈕或使用"顯示詳情"查看市場情感分析詳情</span>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item" id="chart-data-accordion">
                                <div class="accordion-header" onclick="toggleAccordion('chart-data-accordion')">
                                    <span><i class="fas fa-database"></i> 圖表數據樣本</span>
                                    <i class="fas fa-plus accordion-icon"></i>
                                </div>
                                <div class="accordion-content" id="chart-data-content">
                                    <div class="accordion-placeholder">
                                        <span>點擊上方按鈕或使用"顯示詳情"查看圖表數據樣本</span>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item" id="yearly-stats-accordion">
                                <div class="accordion-header" onclick="toggleAccordion('yearly-stats-accordion')">
                                    <span><i class="fas fa-chart-bar"></i> 完整年度數據統計</span>
                                    <i class="fas fa-plus accordion-icon"></i>
                                </div>
                                <div class="accordion-content" id="yearly-stats-content">
                                    <div class="accordion-placeholder">
                                        <span>點擊上方按鈕或使用"顯示詳情"查看完整年度數據統計</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="page-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>市場分析報告系統</h3>
                    <p>AI 驅動的智能市場分析與報告生成平台</p>
                </div>
                <div class="footer-stats">
                    <div class="stat-item">
                        <span class="stat-label">系統版本</span>
                        <span class="stat-value">v2.1.4</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">數據來源</span>
                        <span class="stat-value">Yahoo Finance</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">下次更新</span>
                        <span class="stat-value" id="next-update">--</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ===== 全域變數 =====
        let goldChart = null;
        let goldPriceData = null;
        let marketData = null;
        let currentPeriod = '1y'; // 固定為一年
        let autoRefreshInterval = null;
        let detailsVisible = false;
        let showMA5 = true;
        let showMA20 = true;
        let showMA125 = true;
        let showQuarterly = true;

        // ===== 初始化 =====
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 市場分析系統載入中...');

            // 檢查Chart.js是否載入
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js 未載入，請檢查網路連接');
            } else {
                console.log('✅ Chart.js 已載入');
                console.log('Chart.js 版本:', Chart.version);
            }

            // 開始載入數據
            initializeSystem();

            // 設定事件監聽
            setupEventListeners();

            // 啟動時間更新
            updateSystemTime();
            setInterval(updateSystemTime, 1000);

            // 設定自動刷新（每5分鐘）
            autoRefreshInterval = setInterval(refreshAllData, 60000);

            // 監聽視窗大小改變
            window.addEventListener('resize', () => {
                if (goldChart && goldPriceData) {
                    setTimeout(() => {
                        createGoldChart(goldPriceData);
                    }, 100);
                }
            });

            console.log('✅ 系統初始化完成');
        });

        // ===== 系統初始化 =====
        async function initializeSystem() {
            console.log('📊 開始載入所有數據...');

            // 並行載入數據
            await Promise.all([
                loadMarketData(),
                loadGoldPrice(currentPeriod, true)
            ]);

            console.log('✅ 所有數據載入完成');
        }

        // ===== 事件監聽設定 =====
        function setupEventListeners() {
            // 線條顯示控制
            const lineToggles = document.querySelectorAll('.line-toggle input');
            lineToggles.forEach(toggle => {
                toggle.addEventListener('change', function () {
                    const lineType = this.id.replace('show-', '');
                    console.log(`📈 切換線條顯示: ${lineType} = ${this.checked}`);

                    if (lineType === 'ma5') showMA5 = this.checked;
                    if (lineType === 'ma20') showMA20 = this.checked;
                    if (lineType === 'ma125') showMA125 = this.checked;
                    if (lineType === 'quarterly') showQuarterly = this.checked;

                    if (goldPriceData) {
                        createGoldChart(goldPriceData);
                    }
                });
            });

            console.log('🎯 事件監聽器設定完成');
        }

        // ===== 時間更新 =====
        function updateSystemTime() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('zh-TW');
            }
        }

        // ===== 載入市場數據 =====
        async function loadMarketData() {
            try {
                console.log('📈 開始載入市場情感分析數據...');
                updateMarketStatus('loading', '載入中...');

                const response = await fetch('/api/current-data');
                const result = await response.json();

                console.log('📥 市場數據API回應:', result);

                if (response.ok && result.status === 'success') {
                    if (result.data && typeof result.data === 'object' && Object.keys(result.data).length > 0) {
                        marketData = result.data;
                        console.log('✅ 成功接收市場數據:', marketData);
                        displayMarketData(marketData);
                        updateMarketStatus('connected', '已連接');


                    } else {
                        console.log('⚠️ 市場數據為空');
                        displayNoMarketData();
                        updateMarketStatus('waiting', '等待數據...');
                    }
                } else {
                    throw new Error(result.message || `HTTP 錯誤: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ 載入市場數據失敗:', error);
                displayMarketError('無法載入市場數據: ' + error.message);
                updateMarketStatus('error', '連接錯誤');
            }
        }

        // ===== 載入黃金價格數據 =====
        async function loadGoldPrice(period = currentPeriod, showLoading = true) {
            try {
                if (showLoading) {
                    updatePriceStatus('loading', '載入中...');
                    showPriceLoading();
                }

                console.log(`🔍 正在獲取黃金期貨數據 - 期間: ${period}`);
                const response = await fetch(`/api/gold-price?period=${period}&interval=1d`);
                const result = await response.json();

                console.log('💰 黃金價格API回應:', result);

                if (response.ok && result.status === 'success' && result.data) {
                    goldPriceData = result.data;
                    console.log('✅ 成功獲取黃金價格數據:');
                    console.log(`   價格: $${result.data.current_price}`);
                    console.log(`   變化: ${result.data.change} (${result.data.change_percent}%)`);
                    console.log(`   數據點數量: ${result.data.chart_data?.length || 0}`);

                    displayGoldPrice(result.data);
                    updateTechnicalIndicators(result.data.technical_indicators || {});
                    updateEnhancedSignalDisplay(result.data);

                    // 檢查圖表數據
                    console.log('📊 準備創建圖表，數據檢查:');
                    console.log('chart_data 存在:', !!result.data.chart_data);
                    console.log('chart_data 類型:', typeof result.data.chart_data);
                    console.log('chart_data 長度:', result.data.chart_data?.length);
                    if (result.data.chart_data && result.data.chart_data.length > 0) {
                        console.log('第一個數據點:', result.data.chart_data[0]);
                    }

                    // 檢查MA線數據
                    console.log('MA5 數據存在:', !!result.data.ma_lines?.ma_5);
                    console.log('MA20 數據存在:', !!result.data.ma_lines?.ma_20);
                    console.log('月平均線數據存在:', !!result.data.monthly_average_line);
                    console.log('年平均價格線數據存在:', !!result.data.yearly_average_line);
                    if (result.data.ma_lines?.ma_5) {
                        console.log('MA5 數據點數:', result.data.ma_lines.ma_5.length);
                    }
                    if (result.data.ma_lines?.ma_20) {
                        console.log('MA20 數據點數:', result.data.ma_lines.ma_20.length);
                    }
                    if (result.data.monthly_average_line) {
                        console.log('月平均線數據點數:', result.data.monthly_average_line.length);
                    }
                    if (result.data.yearly_average_line) {
                        console.log('年平均價格線數據點數:', result.data.yearly_average_line.length);
                    }

                    // 延遲創建圖表，確保DOM完全載入
                    setTimeout(() => {
                        createGoldChart(result.data);
                    }, 500);

                    updatePriceStatus('connected', '即時更新');

                    if (result.next_update) {
                        document.getElementById('next-update').textContent =
                            new Date(result.next_update).toLocaleTimeString('zh-TW');
                    }

                    if (result.data.last_updated_formatted) {
                        updateGoldLastUpdated(`最後更新: ${result.data.last_updated_formatted}`);
                    } else if (result.data.last_updated) {
                        const lastUpdated = new Date(result.data.last_updated);
                        updateGoldLastUpdated(`最後更新: ${lastUpdated.toLocaleString('zh-TW')}`);
                    }

                    // 更新詳細日誌
                    updateDetailedLogs(result);

                } else {
                    throw new Error(result.message || `HTTP 錯誤: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ 載入黃金價格失敗:', error);
                displayPriceError('無法載入黃金價格: ' + error.message);
                updatePriceStatus('error', '連接錯誤');
            }
        }

        // ===== 顯示市場數據 =====
        function displayMarketData(data) {
            console.log('🎨 顯示市場數據:', data);

            // 獲取 score
            let score = 0;

            // 從 raw_data 中獲取 score
            if (data.raw_data && data.raw_data.score !== undefined) {
                score = data.raw_data.score;
            } else if (data.average_sentiment_score !== undefined) {
                score = data.average_sentiment_score;
            }

            // 將 -1 到 1 的範圍轉換為 0 到 100 的範圍
            // 0 = 極度恐慌, 100 = 極度貪婪
            if (score >= -1 && score <= 1) {
                score = Math.round(((score + 1) / 2) * 100);
            }

            // 獲取摘要內容
            const summaryContent = getSummaryContent(data);

            const sentimentClass = getSentimentClass(score);
            const sentimentText = getSentimentText(score);
            const sentimentEmoji = getSentimentEmoji(score);

            // 處理emailReport內容（用於郵件發送）
            let emailReportContent = '';
            if (data.email_report) {
                emailReportContent = data.email_report;
                console.log('📧 找到emailReport內容，長度:', emailReportContent.length);
            } else if (data.raw_data && data.raw_data.emailReport) {
                emailReportContent = data.raw_data.emailReport;
                console.log('📧 從raw_data找到emailReport內容，長度:', emailReportContent.length);
            }

            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="market-data">
                    <div class="data-row sentiment-highlight">
                        <div class="data-label">
                            <i class="fas fa-heart-pulse"></i>
                            市場情緒指數
                        </div>
                        <div class="data-value">
                            <span class="sentiment-score sentiment-${sentimentClass}">
                                ${sentimentEmoji} ${sentimentText} (${score}/100)
                            </span>
                        </div>
                    </div>

                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-calendar-day"></i>
                            市場日期
                        </div>
                        <div class="data-value">${data.market_date || '未知'}</div>
                    </div>

                    <div class="data-row full-width">
                        <div class="data-label">
                            <i class="fas fa-newspaper"></i>
                            市場情緒摘要
                        </div>
                        <div class="market-content" id="market-content">
                            ${summaryContent || '無摘要內容'}
                        </div>
                        ${(summaryContent && summaryContent.length > 200)
                    ? '<button class="expand-btn" onclick="toggleMarketContent()">展開全文</button>'
                    : ''}
                    </div>

                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-clock"></i>
                            接收時間
                        </div>
                        <div class="data-value">${data.received_time || '未知'}</div>
                    </div>
                </div>
            `;
        }

        // ===== 顯示黃金價格 =====
        function displayGoldPrice(data) {
            console.log('💰 顯示黃金價格數據:', data);

            const priceChangeClass = data.change >= 0 ? 'positive' : 'negative';
            const priceChangeIcon = data.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="gold-price-info">
                    <div class="price-main">
                        <div class="current-price">
                            <span class="price-value">$${data.current_price?.toFixed(2) || 'N/A'}</span>
                            <span class="price-unit">${data.unit || 'USD/oz'} (USD)</span>
                        </div>
                        <div class="price-change ${priceChangeClass}">
                            <i class="fas ${priceChangeIcon}"></i>
                            <span>${data.change >= 0 ? '+' : ''}${data.change?.toFixed(2) || 'N/A'}</span>
                            <span>(${data.change_percent >= 0 ? '+' : ''}${data.change_percent?.toFixed(2) || 'N/A'}%)</span>
                        </div>
                    </div>

                    <div class="price-statistics">
                        <div class="stat-grid">
                            <div class="stat-item">
                                <span class="stat-label">當日高</span>
                                <span class="stat-value">$${data.today_high?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">當日低</span>
                                <span class="stat-value">$${data.today_low?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">年平均價格</span>
                                <span class="stat-value">$${data.avg_price?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">年標準差</span>
                                <span class="stat-value">${data.volatility?.toFixed(2) || 'N/A'}</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">市場狀態</span>
                                <span class="stat-value market-${data.market_status}">${getMarketStatusText(data.market_status)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== 創建黃金價格圖表 =====
        function createGoldChart(data) {
            console.log('🎨 開始創建黃金價格圖表...');
            console.log('接收到的數據:', data);

            const canvas = document.getElementById('goldChart');
            const container = document.getElementById('chart-container');

            if (!canvas) {
                console.error('❌ 找不到 Canvas 元素: goldChart');
                return;
            }

            if (!container) {
                console.error('❌ 找不到圖表容器: chart-container');
                return;
            }

            // 檢查容器是否可見
            const containerStyle = window.getComputedStyle(container);
            console.log('容器顯示狀態:', containerStyle.display);
            console.log('容器可見性:', containerStyle.visibility);

            // 確保容器可見
            if (containerStyle.display === 'none') {
                container.style.display = 'block';
            }

            // 重要：正確銷毀現有圖表
            if (goldChart) {
                console.log('🗑️ 銷毀現有圖表');
                goldChart.destroy();
                goldChart = null;
            }

            // 重新設置 Canvas 尺寸
            canvas.width = container.offsetWidth || 800;
            canvas.height = container.offsetHeight || 400;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            console.log('Canvas 尺寸:', canvas.width, 'x', canvas.height);
            console.log('容器尺寸:', container.offsetWidth, 'x', container.offsetHeight);

            if (!data.chart_data || !Array.isArray(data.chart_data) || data.chart_data.length === 0) {
                console.warn('⚠️ 圖表數據為空或無效，不渲染圖表');
                console.log('數據詳情:', data.chart_data);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            console.log(`📊 創建圖表，數據點: ${data.chart_data.length}`);
            console.log('原始數據樣本:', data.chart_data.slice(0, 3));

            const chartData = data.chart_data;

            // 簡化數據處理，使用字符串日期
            const labels = chartData.map(d => d.time);
            const prices = chartData.map(d => parseFloat(d.price) || 0);

            console.log('處理後的標籤:', labels.slice(0, 5));
            console.log('處理後的價格:', prices.slice(0, 5));
            console.log('標籤總數:', labels.length);
            console.log('價格總數:', prices.length);
            console.log('有效價格數量:', prices.filter(p => p > 0).length);

            // 準備數據集 - 使用簡單的數組格式
            const validPrices = prices.filter(p => p > 0);
            const validLabels = labels.slice(0, validPrices.length);

            console.log('有效價格數量:', validPrices.length);
            console.log('有效標籤數量:', validLabels.length);
            console.log('有效標籤樣本:', validLabels.slice(0, 5));
            console.log('主數據時間格式樣本:', validLabels.slice(0, 3).map(label => {
                const date = new Date(label);
                return {
                    original: label,
                    date: date.toISOString().split('T')[0]
                };
            }));

            const datasets = [{
                label: '黃金價格 (USD/oz)',
                data: validPrices,
                borderColor: '#FFD700',
                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                spanGaps: true
            }];

            console.log('主數據格式檢查:', {
                validPricesLength: validPrices.length,
                validPricesSample: validPrices.slice(0, 3),
                validLabelsLength: validLabels.length,
                validLabelsSample: validLabels.slice(0, 3)
            });

            // 添加MA5線
            if (showMA5 && data.ma_lines && data.ma_lines.ma_5) {
                console.log('🔍 處理MA5數據...');
                // 創建MA5數據映射
                const ma5Map = {};
                data.ma_lines.ma_5.forEach(d => {
                    ma5Map[d.time] = parseFloat(d.price) || 0;
                });

                console.log('MA5映射樣本:', Object.keys(ma5Map).slice(0, 5));

                // 對齊到主數據的時間軸
                const ma5Prices = validLabels.map(label => ma5Map[label] || null);
                const validMa5Prices = ma5Prices.filter(p => p !== null && p > 0);

                // 確保數據長度與主數據一致
                const alignedMa5Prices = validLabels.map(label => ma5Map[label] || null);

                console.log('MA5對齊數據點數:', alignedMa5Prices.filter(p => p !== null).length);

                if (alignedMa5Prices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'MA5',
                        data: alignedMa5Prices,
                        borderColor: '#FF6B6B',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        spanGaps: true
                    });
                }
            }

            // 添加MA20線
            if (showMA20 && data.ma_lines && data.ma_lines.ma_20) {
                console.log('🔍 處理MA20數據...');
                // 創建MA20數據映射
                const ma20Map = {};
                data.ma_lines.ma_20.forEach(d => {
                    ma20Map[d.time] = parseFloat(d.price) || 0;
                });

                console.log('MA20映射樣本:', Object.keys(ma20Map).slice(0, 5));

                // 對齊到主數據的時間軸
                const ma20Prices = validLabels.map(label => ma20Map[label] || null);
                const validMa20Prices = ma20Prices.filter(p => p !== null && p > 0);

                // 確保數據長度與主數據一致
                const alignedMa20Prices = validLabels.map(label => ma20Map[label] || null);

                console.log('MA20對齊數據點數:', alignedMa20Prices.filter(p => p !== null).length);

                if (alignedMa20Prices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'MA20',
                        data: alignedMa20Prices,
                        borderColor: '#4ECDC4',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        spanGaps: true
                    });
                }
            }

            // 添加MA125線
            if (showMA125 && data.ma_125_line && data.ma_125_line.length > 0) {
                console.log('🔍 處理MA125數據...');
                console.log('MA125原始數據:', data.ma_125_line);

                // 創建MA125數據映射
                const ma125Map = {};
                data.ma_125_line.forEach(d => {
                    ma125Map[d.time] = parseFloat(d.price) || 0;
                });

                console.log('MA125映射樣本:', Object.keys(ma125Map).slice(0, 5));
                console.log('MA125映射值樣本:', Object.values(ma125Map).slice(0, 5));

                // 對齊到主數據的時間軸
                const alignedMA125Prices = validLabels.map(label => {
                    return ma125Map[label] || null;
                });

                console.log('MA125對齊數據點數:', alignedMA125Prices.filter(p => p !== null).length);
                console.log('MA125對齊數據樣本:', alignedMA125Prices.slice(0, 10));

                if (alignedMA125Prices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'MA125',
                        data: alignedMA125Prices,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderDash: [6, 3],
                        spanGaps: true
                    });
                } else {
                    console.log('⚠️ MA125沒有有效數據點');
                }
            } else {
                console.log('⚠️ MA125數據不存在或為空');
                console.log('showMA125:', showMA125);
                console.log('data.ma_125_line 存在:', !!data.ma_125_line);
                console.log('data.ma_125_line 長度:', data.ma_125_line?.length);
            }

            // 添加轉折點線
            if (showQuarterly && data.pivot_points && data.pivot_points.length > 0) {
                console.log('🔍 處理轉折點數據...');
                console.log('轉折點原始數據:', data.pivot_points);

                // 修正：創建獨立的轉折點數據集，確保能連成一條折線圖
                const pivotLabels = data.pivot_points.map(d => d.time);
                const pivotPrices = data.pivot_points.map(d => parseFloat(d.price) || 0);

                console.log('轉折點標籤:', pivotLabels);
                console.log('轉折點價格:', pivotPrices);

                if (pivotPrices.length > 0) {
                    // 修正：創建對齊到主數據時間軸的轉折點數據集
                    const pivotMap = {};
                    data.pivot_points.forEach(d => {
                        pivotMap[d.time] = parseFloat(d.price) || 0;
                    });

                    // 對齊到主數據的時間軸
                    const alignedPivotPrices = validLabels.map(label => {
                        return pivotMap[label] || null;
                    });

                    console.log('轉折點對齊數據點數:', alignedPivotPrices.filter(p => p !== null).length);

                    if (alignedPivotPrices.filter(p => p !== null).length > 0) {
                        datasets.push({
                            label: '轉折點',
                            data: alignedPivotPrices,
                            borderColor: '#FF8C00',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1, // 減少曲線張力，讓線更直
                            pointRadius: 2, // 縮小點的大小
                            pointHoverRadius: 4, // 縮小懸停時點的大小
                            pointBackgroundColor: '#FF8C00',
                            pointBorderColor: '#FF8C00',
                            borderDash: [0], // 實線
                            spanGaps: true, // 允許跨越空值，讓線條連續
                            pointHitRadius: 8, // 增加點擊區域，方便交互
                            pointBorderWidth: 1, // 點邊框寬度
                            pointStyle: 'circle' // 確保點是圓形
                        });
                    } else {
                        console.log('⚠️ 轉折點對齊後沒有有效數據點');
                    }
                } else {
                    console.log('⚠️ 轉折點沒有有效數據點');
                }
            } else {
                console.log('⚠️ 轉折點數據不存在或為空');
                console.log('showQuarterly:', showQuarterly);
                console.log('data.pivot_points 存在:', !!data.pivot_points);
                console.log('data.pivot_points 長度:', data.pivot_points?.length);
            }

            // 檢查交叉信號
            let crossSignalText = '';
            if (data.cross_signal) {
                crossSignalText = data.cross_signal.message;
                console.log('📊 交叉信號:', data.cross_signal);
                console.log('📊 信號狀態:', data.cross_signal.status);
                console.log('📊 信號消息:', crossSignalText);
            }

            const config = {
                type: 'line',
                data: {
                    labels: validLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 20,   // 整張圖底部多留 20px
                            top: crossSignalText ? 40 : 20  // 如果有交叉信號，頂部多留空間
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `黃金期貨價格走勢 (一年)`,
                            color: '#f8fafc',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            labels: { color: '#cbd5e1' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                title: function (context) {
                                    const dataIndex = context[0].dataIndex;
                                    if (dataIndex < labels.length) {
                                        return labels[dataIndex];
                                    }
                                    return '未知日期';
                                },
                                label: function (context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        },
                        annotation: crossSignalText ? {
                            annotations: {
                                crossSignal: {
                                    type: 'label',
                                    xValue: 0.95,
                                    yValue: 0.95,
                                    backgroundColor: data.cross_signal.status === 'golden_cross' ? 'rgba(16, 185, 129, 0.9)' :
                                        data.cross_signal.status === 'death_cross' ? 'rgba(239, 68, 68, 0.9)' :
                                            'rgba(100, 116, 139, 0.9)',
                                    content: [crossSignalText],
                                    color: '#ffffff',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    padding: 8,
                                    borderRadius: 4,
                                    position: 'end'
                                }
                            }
                        } : {}
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#64748b',
                                rotation: 0,  // 旋轉角度
                                minRotation: 0,  // 最小旋轉角度
                                maxRotation: 0,  // 最大旋轉角度
                                autoSkip: true,
                                font: {
                                    size: 12,
                                    weight: 'normal'
                                },
                                callback: function (value, index, ticks) {
                                    if (index < validLabels.length) {
                                        const date = new Date(validLabels[index]);
                                        if (!isNaN(date.getTime())) {
                                            const year = date.getFullYear();
                                            const month = date.getMonth() + 1;
                                            return `${year}年${month}月`;
                                        }
                                    }
                                    return '';
                                }
                            },
                            grid: {
                                color: 'rgba(100, 116, 139, 0.1)'
                            },
                            afterFit: function (scale) {
                                scale.paddingTop = 10;
                                scale.paddingBottom = 10;
                            }
                        },
                        y: {
                            ticks: {
                                color: '#64748b',
                                callback: function (value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(100, 116, 139, 0.1)' }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 60
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            };

            try {
                const ctx = canvas.getContext('2d');
                console.log('🎨 開始渲染圖表...');
                console.log('Canvas 尺寸:', canvas.width, 'x', canvas.height);
                console.log('數據集數量:', datasets.length);
                console.log('有效價格數據點數:', validPrices.length);

                // 確保 Chart.js 已載入
                if (typeof Chart === 'undefined') {
                    console.error('❌ Chart.js 未載入');
                    return;
                }

                // 檢查數據是否有效
                if (validPrices.length === 0) {
                    console.error('❌ 有效價格數據為空，無法創建圖表');
                    return;
                }

                console.log('配置對象:', config);
                goldChart = new Chart(ctx, config);
                console.log('✅ 圖表創建成功');
                console.log('圖表實例:', goldChart);

                // 強制X軸標籤水平顯示
                setTimeout(() => {
                    if (goldChart && goldChart.options && goldChart.options.scales && goldChart.options.scales.x) {
                        goldChart.options.scales.x.ticks.rotation = 0;
                        goldChart.options.scales.x.ticks.maxTicksLimit = 6;
                        goldChart.update('none');

                        // 再次強制更新
                        setTimeout(() => {
                            goldChart.update('none');
                        }, 200);
                    }
                }, 100);

            } catch (error) {
                console.error('❌ 創建圖表時發生錯誤:', error);
                console.error('錯誤詳情:', error.message);
                console.error('錯誤堆疊:', error.stack);
            }
        }

        // ===== 更新技術指標 =====
        function updateTechnicalIndicators(indicators) {
            console.log('📊 更新技術指標:', indicators);

            if (indicators.ma_5) {
                document.getElementById('ma5-value').textContent = '$' + indicators.ma_5.toFixed(2);
            }
            if (indicators.ma_20) {
                document.getElementById('ma20-value').textContent = '$' + indicators.ma_20.toFixed(2);
            }
            if (indicators.ma_50) {
                document.getElementById('ma50-value').textContent = '$' + indicators.ma_50.toFixed(2);
            }
            if (indicators.rsi) {
                const rsiElement = document.getElementById('rsi-value');
                rsiElement.textContent = indicators.rsi.toFixed(1);

                // RSI 顏色指示
                rsiElement.className = 'indicator-value';
                if (indicators.rsi > 70) {
                    rsiElement.classList.add('rsi-overbought');
                } else if (indicators.rsi < 30) {
                    rsiElement.classList.add('rsi-oversold');
                } else {
                    rsiElement.classList.add('rsi-neutral');
                }
            }
        }

        // ===== 更新增強的交易訊號監測 =====
        function updateEnhancedSignalDisplay(goldData) {
            console.log('📊 更新增強的交易訊號監測:', goldData);

            // MA5/MA20 交叉信號
            updateMACrossSignal(goldData);

            // RSI 區間信號
            updateRSISignal(goldData);


        }

        function updateMACrossSignal(goldData) {
            const statusElement = document.getElementById('ma-cross-status');
            const descriptionElement = document.getElementById('ma-cross-description');

            if (goldData.cross_signal && goldData.cross_signal.status) {
                let statusText = '';
                let statusClass = '';
                let description = '';

                switch (goldData.cross_signal.status) {
                    case 'golden_cross':
                        statusText = '✅ 黃金交叉';
                        statusClass = 'signal-success';
                        description = 'MA5 上穿 MA20，看漲信號';
                        break;
                    case 'death_cross':
                        statusText = '⚠️ 死亡交叉';
                        statusClass = 'signal-warning';
                        description = 'MA5 下穿 MA20，看跌信號';
                        break;
                    default:
                        statusText = '✅ 正常';
                        statusClass = 'signal-normal';
                        description = 'MA5 與 MA20 無交叉信號';
                }

                statusElement.textContent = statusText;
                statusElement.className = `signal-status ${statusClass}`;
                descriptionElement.textContent = description;
            }
        }

        function updateRSISignal(goldData) {
            const statusElement = document.getElementById('rsi-status');
            const descriptionElement = document.getElementById('rsi-description');

            if (goldData.technical_indicators && goldData.technical_indicators.rsi) {
                const rsi = goldData.technical_indicators.rsi;
                let statusText = '';
                let statusClass = '';
                let description = '';

                if (rsi > 70) {
                    statusText = '⚠️ 過熱';
                    statusClass = 'signal-warning';
                    description = `RSI: ${rsi.toFixed(1)} > 70，市場可能過熱，注意回調風險`;
                } else if (rsi < 30) {
                    statusText = '⚠️ 過冷';
                    statusClass = 'signal-warning';
                    description = `RSI: ${rsi.toFixed(1)} < 30，市場可能過冷，注意反彈機會`;
                } else {
                    statusText = '✅ 正常';
                    statusClass = 'signal-success';
                    description = `RSI: ${rsi.toFixed(1)}，市場處於正常區間`;
                }

                statusElement.textContent = statusText;
                statusElement.className = `signal-status ${statusClass}`;
                descriptionElement.textContent = description;
            }
        }



        // ===== 更新詳細日誌 =====
        // 每個 section 都有自己的 accordion 展開/收合
        function updateDetailedLogs(goldData) {
            console.log('📝 更新詳細日誌');

            // 更新系統資訊
            updateSystemInfoContent(document.getElementById('system-info-content'));

            // 更新黃金價格詳情
            updateGoldPriceContent(document.getElementById('gold-price-content'));

            // 更新技術指標詳情
            updateTechnicalIndicatorsContent(document.getElementById('technical-indicators-content'));

            // 更新市場情感分析詳情
            updateMarketSentimentContent(document.getElementById('market-sentiment-content'));

            // 更新圖表數據樣本
            updateChartDataContent(document.getElementById('chart-data-content'));

            // 更新完整年度數據統計
            updateYearlyStatsContent(document.getElementById('yearly-stats-content'));
        }

        // ===== Accordion 收合功能 =====
        function toggleAccordion(accordionId) {
            console.log(`📋 切換 accordion: ${accordionId}`);

            const accordion = document.getElementById(accordionId);
            if (!accordion) {
                console.error(`❌ 找不到 accordion: ${accordionId}`);
                return;
            }

            const content = accordion.querySelector('.accordion-content');
            const icon = accordion.querySelector('.accordion-icon');

            if (!content || !icon) {
                console.error(`❌ 找不到 accordion 內容或圖標: ${accordionId}`);
                return;
            }

            const isExpanded = content.style.display === 'block';

            if (isExpanded) {
                // 收合
                content.style.display = 'none';
                content.classList.remove('expanded');
                icon.classList.remove('fa-minus');
                icon.classList.add('fa-plus');
                console.log(`📋 收合 accordion: ${accordionId}`);
            } else {
                // 展開
                content.style.display = 'block';
                content.classList.add('expanded');
                icon.classList.remove('fa-plus');
                icon.classList.add('fa-minus');
                console.log(`📋 展開 accordion: ${accordionId}`);

                // 如果展開且有數據，更新對應內容
                if (goldPriceData) {
                    updateAccordionContent(accordionId);
                }
            }
        }

        function updateAccordionContent(accordionId) {
            console.log(`📝 更新 accordion 內容: ${accordionId}`);

            const contentId = accordionId.replace('-accordion', '-content');
            const contentElement = document.getElementById(contentId);

            if (!contentElement) {
                console.error(`❌ 找不到內容元素: ${contentId}`);
                return;
            }

            // 隱藏placeholder
            const placeholder = contentElement.querySelector('.accordion-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }

            // 檢查是否有數據可用
            const hasGoldData = goldPriceData && Object.keys(goldPriceData).length > 0;
            const hasMarketData = marketData && Object.keys(marketData).length > 0;

            switch (accordionId) {
                case 'system-info-accordion':
                    updateSystemInfoContent(contentElement);
                    break;
                case 'gold-price-accordion':
                    if (hasGoldData) {
                        updateGoldPriceContent(contentElement);
                    } else {
                        contentElement.innerHTML = `
                            <div class="log-content">
                                <p><strong>狀態:</strong> <span class="status-warning">等待數據載入...</span></p>
                                <p>請先載入黃金價格數據</p>
                            </div>
                        `;
                    }
                    break;
                case 'technical-indicators-accordion':
                    if (hasGoldData && goldPriceData.technical_indicators) {
                        updateTechnicalIndicatorsContent(contentElement);
                    } else {
                        contentElement.innerHTML = `
                            <div class="log-content">
                                <p><strong>狀態:</strong> <span class="status-warning">等待數據載入...</span></p>
                                <p>請先載入黃金價格數據</p>
                            </div>
                        `;
                    }
                    break;
                case 'market-sentiment-accordion':
                    if (hasMarketData) {
                        updateMarketSentimentContent(contentElement);
                    } else {
                        contentElement.innerHTML = `
                            <div class="log-content">
                                <p><strong>狀態:</strong> <span class="status-warning">等待數據載入...</span></p>
                                <p>請先載入市場情感分析數據</p>
                            </div>
                        `;
                    }
                    break;
                case 'chart-data-accordion':
                    if (hasGoldData && goldPriceData.chart_data && goldPriceData.chart_data.length > 0) {
                        updateChartDataContent(contentElement);
                    } else {
                        contentElement.innerHTML = `
                            <div class="log-content">
                                <p><strong>狀態:</strong> <span class="status-warning">等待數據載入...</span></p>
                                <p>請先載入黃金價格圖表數據</p>
                            </div>
                        `;
                    }
                    break;
                case 'yearly-stats-accordion':
                    if (hasGoldData && goldPriceData.chart_data && goldPriceData.chart_data.length > 0) {
                        updateYearlyStatsContent(contentElement);
                    } else {
                        contentElement.innerHTML = `
                            <div class="log-content">
                                <p><strong>狀態:</strong> <span class="status-warning">等待數據載入...</span></p>
                                <p>請先載入黃金價格年度數據</p>
                            </div>
                        `;
                    }
                    break;
                default:
                    console.warn(`⚠️ 未知的 accordion ID: ${accordionId}`);
            }
        }



        function toggleMarketContent() {
            const content = document.getElementById('market-content');
            const isExpanded = content.style.maxHeight === 'none';

            content.style.maxHeight = isExpanded ? '200px' : 'none';
            content.style.overflow = isExpanded ? 'hidden' : 'visible';

            const btn = content.nextElementSibling;
            if (btn && btn.classList.contains('expand-btn')) {
                btn.textContent = isExpanded ? '展開全文' : '收起';
            }
        }

        function toggleEmailReportContent() {
            const content = document.getElementById('email-report-content');
            const isExpanded = content.style.maxHeight === 'none';

            content.style.maxHeight = isExpanded ? '300px' : 'none';
            content.style.overflow = isExpanded ? 'hidden' : 'visible';

            const btn = content.nextElementSibling;
            if (btn && btn.classList.contains('expand-btn')) {
                btn.textContent = isExpanded ? '展開全文' : '收起';
            }
        }

        // ===== Accordion 內容更新函數 =====
        function updateSystemInfoContent(contentElement) {
            contentElement.innerHTML = `
                <div class="log-content">
                    <p><strong>系統時間:</strong> ${new Date().toLocaleString('zh-TW')}</p>
                    <p><strong>數據來源:</strong> Yahoo Finance</p>
                    <p><strong>API狀態:</strong> <span class="status-success">正常</span></p>
                    <p><strong>下次更新:</strong> ${document.getElementById('next-update').textContent}</p>
                    <p><strong>系統版本:</strong> v2.1.4</p>
                </div>
            `;
        }

        function updateGoldPriceContent(contentElement) {
            if (!goldPriceData) return;

            contentElement.innerHTML = `
                <div class="log-content">
                    <p><strong>代碼:</strong> ${goldPriceData.symbol || 'GC=F'}</p>
                    <p><strong>名稱:</strong> ${goldPriceData.name || 'Gold Futures'}</p>
                    <p><strong>當前價格:</strong> ${goldPriceData.current_price?.toFixed(2) || 'N/A'}</p>
                    <p><strong>變化金額:</strong> ${goldPriceData.change >= 0 ? '+' : ''}${goldPriceData.change?.toFixed(2) || 'N/A'}</p>
                    <p><strong>變化百分比:</strong> ${goldPriceData.change_percent >= 0 ? '+' : ''}${goldPriceData.change_percent?.toFixed(2) || 'N/A'}%</p>
                    <p><strong>當日高:</strong> ${goldPriceData.today_high?.toFixed(2) || 'N/A'}</p>
                    <p><strong>當日低:</strong> ${goldPriceData.today_low?.toFixed(2) || 'N/A'}</p>
                    <p><strong>年平均價格:</strong> ${goldPriceData.avg_price?.toFixed(2) || 'N/A'}</p>
                    <p><strong>年標準差:</strong> ${goldPriceData.volatility?.toFixed(2) || 'N/A'}</p>
                    <p><strong>市場狀態:</strong> ${getMarketStatusText(goldPriceData.market_status)}</p>
                    <p><strong>貨幣單位:</strong> ${goldPriceData.currency || 'USD'}</p>
                    <p><strong>數據點數量:</strong> ${goldPriceData.data_points || 0}</p>
                    <p><strong>交易天數:</strong> ${goldPriceData.trading_days || 0}</p>
                    <p><strong>時間期間:</strong> 一年</p>
                    <p><strong>時間間隔:</strong> ${goldPriceData.interval || '1d'}</p>
                    <p><strong>最後更新:</strong> ${goldPriceData.last_updated_formatted || (goldPriceData.last_updated ? new Date(goldPriceData.last_updated).toLocaleString('zh-TW') : '未知')}</p>
                </div>
            `;
        }

        function updateTechnicalIndicatorsContent(contentElement) {
            if (!goldPriceData?.technical_indicators) return;

            const indicators = goldPriceData.technical_indicators;
            contentElement.innerHTML = `
                <div class="log-content">
                    ${indicators.ma_5 ? `<p><strong>MA5 (5日移動平均):</strong> ${indicators.ma_5.toFixed(2)}</p>` : ''}
                    ${indicators.ma_20 ? `<p><strong>MA20 (20日移動平均):</strong> ${indicators.ma_20.toFixed(2)}</p>` : ''}
                    ${indicators.ma_50 ? `<p><strong>MA50 (50日移動平均):</strong> ${indicators.ma_50.toFixed(2)}</p>` : ''}
                    ${indicators.rsi ? `<p><strong>RSI (相對強弱指標):</strong> ${indicators.rsi.toFixed(1)} ${getRSIStatus(indicators.rsi)}</p>` : ''}
                    ${indicators.volatility_5d ? `<p><strong>5日波動率:</strong> ${indicators.volatility_5d.toFixed(2)}</p>` : ''}
                    ${indicators.price_vs_ma20 ? `<p><strong>價格相對MA20:</strong> ${indicators.price_vs_ma20 >= 0 ? '+' : ''}${indicators.price_vs_ma20.toFixed(2)}%</p>` : ''}
                </div>
            `;
        }

        function updateMarketSentimentContent(contentElement) {
            if (!marketData) return;

            // 獲取 score - 使用與最上面市場情感分析相同的邏輯
            let sentimentScore = 0;

            // 從 raw_data 中獲取 score
            if (marketData.raw_data && marketData.raw_data.score !== undefined) {
                sentimentScore = marketData.raw_data.score;
            } else if (marketData.average_sentiment_score !== undefined) {
                sentimentScore = marketData.average_sentiment_score;
            }

            // 將 -1 到 1 的範圍轉換為 0 到 100 的範圍
            // 0 = 極度恐慌, 100 = 極度貪婪
            if (sentimentScore >= -1 && sentimentScore <= 1) {
                sentimentScore = Math.round(((sentimentScore + 1) / 2) * 100);
            }

            // 獲取情感相關信息
            const sentimentClass = getSentimentClass(sentimentScore);
            const sentimentText = getSentimentText(sentimentScore);
            const sentimentEmoji = getSentimentEmoji(sentimentScore);



            contentElement.innerHTML = `
                <div class="log-content">
                    <div class="sentiment-details">
                        <div class="sentiment-header">
                            <span class="sentiment-emoji">${sentimentEmoji}</span>
                            <span class="sentiment-score">${sentimentScore}/100分</span>
                            <span class="sentiment-text sentiment-${sentimentClass}">${sentimentText}</span>
                        </div>
                        
                        <div class="market-details">
                            <p><strong>市場日期:</strong> ${marketData.market_date || '未知'}</p>
                            <p><strong>接收時間:</strong> ${marketData.received_time || '未知'}</p>
                        </div>
                        
                        <div class="analysis-section">
                            <p><strong>市場情緒摘要:</strong></p>
                            <div class="analysis-content">
                                <p>${getSummaryContent(marketData)}</p>
                            </div>
                        </div>
                </div>
            `;
        }

        function updateChartDataContent(contentElement) {
            if (!goldPriceData?.chart_data || goldPriceData.chart_data.length === 0) return;

            const chartData = goldPriceData.chart_data;
            const sampleSize = Math.min(5, chartData.length);
            const samples = chartData.slice(-sampleSize);

            contentElement.innerHTML = `
                <div class="log-content">
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>時間</th>
                                    <th>開盤</th>
                                    <th>最高</th>
                                    <th>最低</th>
                                    <th>收盤</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${samples.map(point => `
                                    <tr>
                                        <td>${new Date(point.time).toLocaleDateString('zh-TW')}</td>
                                        <td>${point.open?.toFixed(2) || 'N/A'}</td>
                                        <td>${point.high?.toFixed(2) || 'N/A'}</td>
                                        <td>${point.low?.toFixed(2) || 'N/A'}</td>
                                        <td>${point.price?.toFixed(2) || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }



        function updateYearlyStatsContent(contentElement) {
            if (!goldPriceData?.chart_data || goldPriceData.chart_data.length === 0) return;

            const chartData = goldPriceData.chart_data;
            const prices = chartData.map(d => d.price).filter(p => p && !isNaN(p));

            contentElement.innerHTML = `
                <div class="log-content">
                    <p><strong>總數據點數:</strong> ${chartData.length}</p>
                    <p><strong>有效價格數據:</strong> ${prices.length}</p>
                    <p><strong>價格範圍:</strong> ${Math.min(...prices).toFixed(2)} - ${Math.max(...prices).toFixed(2)}</p>
                    <p><strong>年度平均價格:</strong> ${(prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2)}</p>
                    <p><strong>年度價格標準差:</strong> ${calculateStandardDeviation(prices).toFixed(2)}</p>
                    <p><strong>數據起始日期:</strong> ${new Date(chartData[0].time).toLocaleDateString('zh-TW')}</p>
                    <p><strong>數據結束日期:</strong> ${new Date(chartData[chartData.length - 1].time).toLocaleDateString('zh-TW')}</p>
                    <p><strong>年度漲跌:</strong> ${((prices[prices.length - 1] - prices[0]) / prices[0] * 100).toFixed(2)}%</p>
                </div>
            `;
        }

        // ===== 輔助函數 =====
        function getSummaryContent(data) {
            // 從 raw_data 中獲取 summary
            if (data.raw_data && data.raw_data.summary) {
                return data.raw_data.summary;
            } else if (data.summary) {
                return data.summary;
            } else if (data.message_content) {
                return data.message_content;
            }
            return '無分析內容';
        }

        function getSentimentClass(score) {
            if (score >= 76) return 'positive';
            if (score >= 51) return 'positive';
            if (score === 50) return 'neutral';
            if (score >= 26) return 'negative';
            return 'negative';
        }

        function getSentimentText(score) {
            if (score >= 76) return '極度貪婪';
            if (score >= 51) return '貪婪';
            if (score === 50) return '中立';
            if (score >= 26) return '恐懼';
            return '極度恐懼';
        }

        function getSentimentEmoji(score) {
            if (score >= 76) return '😈';
            if (score >= 51) return '😏';
            if (score === 50) return '😐';
            if (score >= 26) return '😰';
            return '😱';
        }

        function getMarketStatusText(status) {
            const statusMap = {
                'open': '開市',
                'closed': '休市',
                'unknown': '未知'
            };
            return statusMap[status] || status;
        }

        function getRSIStatus(rsi) {
            if (rsi > 70) return '(超買)';
            if (rsi < 30) return '(超賣)';
            return '(正常)';
        }

        function calculateStandardDeviation(values) {
            const avg = values.reduce((a, b) => a + b) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        // ===== 快速操作函數 =====
        function scrollToGoldPrice() {
            console.log('🎯 跳轉到黃金價格區塊');
            const goldSection = document.getElementById('gold-price-section');
            if (goldSection) {
                goldSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            } else {
                console.error('❌ 找不到黃金價格區塊');
            }
        }

        function scrollToSentiment() {
            console.log('🎯 跳轉到市場情感分析區塊');
            const sentimentSection = document.getElementById('sentiment-section');
            if (sentimentSection) {
                sentimentSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            } else {
                console.error('❌ 找不到市場情感分析區塊');
            }
        }

        function scrollToDataDetails() {
            console.log('🎯 跳轉到詳細數據日誌區塊');
            const dataLogsSection = document.getElementById('data-logs-section');
            if (dataLogsSection) {
                dataLogsSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            } else {
                console.error('❌ 找不到詳細數據日誌區塊');
            }
        }

        function toggleTechnicalIndicators() {
            console.log('📊 切換技術指標顯示');
            const indicators = document.getElementById('technical-indicators');
            const enhancedSignals = document.getElementById('enhanced-signal-display');
            const toggleBtn = document.getElementById('technical-toggle');

            if (indicators && enhancedSignals && toggleBtn) {
                const isVisible = indicators.style.display !== 'none';

                if (isVisible) {
                    indicators.style.display = 'none';
                    enhancedSignals.style.display = 'none';
                    toggleBtn.querySelector('span').textContent = '顯示技術指標';
                } else {
                    indicators.style.display = 'block';
                    enhancedSignals.style.display = 'block';
                    toggleBtn.querySelector('span').textContent = '隱藏技術指標';
                }
            } else {
                console.error('❌ 找不到技術指標元素');
            }
        }

        function toggleDataDetails() {
            console.log('📋 切換詳細數據日誌顯示');
            const toggleBtn = document.getElementById('details-toggle');

            if (toggleBtn) {
                const isShowingData = toggleBtn.querySelector('span').textContent === '隱藏詳情';

                if (isShowingData) {
                    // 隱藏數據，顯示placeholder
                    toggleBtn.querySelector('span').textContent = '顯示詳情';

                    // 收合所有accordion項目並顯示placeholder
                    const accordionItems = document.querySelectorAll('.accordion-content');
                    accordionItems.forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('expanded');

                        // 恢復placeholder內容
                        const placeholder = content.querySelector('.accordion-placeholder');
                        if (placeholder) {
                            placeholder.style.display = 'block';
                        }
                    });

                    // 重置所有accordion圖標
                    const accordionIcons = document.querySelectorAll('.accordion-icon');
                    accordionIcons.forEach(icon => {
                        icon.classList.remove('fa-minus');
                        icon.classList.add('fa-plus');
                    });

                } else {
                    // 顯示數據
                    toggleBtn.querySelector('span').textContent = '隱藏詳情';

                    // 自動展開所有accordion項目並載入數據
                    const accordionIds = [
                        'system-info-accordion',
                        'gold-price-accordion',
                        'technical-indicators-accordion',
                        'market-sentiment-accordion',
                        'chart-data-accordion',
                        'yearly-stats-accordion'
                    ];

                    accordionIds.forEach((accordionId, index) => {
                        setTimeout(() => {
                            const accordion = document.getElementById(accordionId);
                            if (accordion) {
                                const content = accordion.querySelector('.accordion-content');
                                const icon = accordion.querySelector('.accordion-icon');

                                if (content && icon) {
                                    // 展開accordion
                                    content.style.display = 'block';
                                    content.classList.add('expanded');
                                    icon.classList.remove('fa-plus');
                                    icon.classList.add('fa-minus');

                                    // 隱藏placeholder
                                    const placeholder = content.querySelector('.accordion-placeholder');
                                    if (placeholder) {
                                        placeholder.style.display = 'none';
                                    }

                                    // 載入對應的數據
                                    updateAccordionContent(accordionId);
                                }
                            }
                        }, index * 200); // 每個accordion間隔200ms展開，創造動畫效果
                    });
                }
            } else {
                console.error('❌ 找不到詳細數據日誌按鈕');
            }
        }

        async function refreshAllData() {
            console.log('🔄 開始刷新所有數據...');

            // 更新按鈕狀態
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                const originalText = refreshBtn.querySelector('span').textContent;
                refreshBtn.querySelector('span').textContent = '刷新中...';
                refreshBtn.disabled = true;

                try {
                    // 並行刷新數據
                    await Promise.all([
                        loadMarketData(),
                        loadGoldPrice(currentPeriod, true)
                    ]);

                    console.log('✅ 所有數據刷新完成');
                } catch (error) {
                    console.error('❌ 數據刷新失敗:', error);
                } finally {
                    // 恢復按鈕狀態
                    refreshBtn.querySelector('span').textContent = originalText;
                    refreshBtn.disabled = false;
                }
            }
        }

        // ===== 狀態更新函數 =====
        function updateMarketStatus(status, text) {
            const dot = document.querySelector('#status-indicator .indicator-dot');
            const textElement = document.querySelector('#status-indicator .indicator-text');

            if (dot && textElement) {
                dot.classList.remove('connected', 'error', 'loading');
                if (status !== 'waiting') {
                    dot.classList.add(status);
                }
                textElement.textContent = text;
            }
        }

        function updatePriceStatus(status, text) {
            const dot = document.querySelector('#price-status .status-dot');
            const textElement = document.querySelector('#price-status .status-text');

            if (dot && textElement) {
                dot.classList.remove('connected', 'error', 'loading');
                if (status !== 'waiting') {
                    dot.classList.add(status);
                }
                textElement.textContent = text;
            }
        }

        function updateGoldLastUpdated(text) {
            const element = document.getElementById('gold-last-updated');
            if (element) {
                element.querySelector('span').textContent = text;
            }
        }

        // ===== 載入和錯誤顯示函數 =====
        function showPriceLoading() {
            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <span>正在載入黃金價格...</span>
                </div>
            `;
        }

        function displayNoMarketData() {
            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-chart-bar"></i>
                    <h3>等待市場數據</h3>
                    <p>請確認 N8N 工作流程已正確運行並發送數據</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        重新載入
                    </button>
                </div>
            `;
        }

        function displayMarketError(message) {
            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>數據載入失敗</h3>
                    <p>${message}</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        重試
                    </button>
                </div>
            `;
        }

        function displayPriceError(message) {
            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>價格載入失敗</h3>
                    <p>${message}</p>
                    <button onclick="loadGoldPrice(currentPeriod, true)" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        重試
                    </button>
                </div>
            `;
        }

        // ===== 錯誤處理 =====
        window.addEventListener('error', (e) => {
            console.error('JavaScript 錯誤:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('未處理的 Promise 拒絕:', e.reason);
        });

        console.log('✅ 市場分析系統腳本載入完成');
    </script>

    <style>
        /* 強制X軸標籤水平顯示 */
        .chart-container canvas {
            transform: none !important;
        }

        /* 強制圖表標籤水平顯示 */
        .chart-container {
            overflow: visible !important;
        }

        /* 確保X軸標籤不旋轉 */
        .chart-container canvas {
            transform: none !important;
        }

        /* 詳細日誌樣式 */
        .data-details-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: var(--transition);
        }

        .log-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-glass);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .log-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .log-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .log-content p {
            margin-bottom: 0.5rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .log-content strong {
            color: var(--text-primary);
        }

        .status-success {
            color: var(--success);
            font-weight: bold;
        }

        .status-warning {
            color: #f59e0b;
            font-weight: bold;
        }

        .data-table {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: bold;
        }

        .data-table td {
            color: var(--text-secondary);
        }

        .data-table tr:hover {
            background: var(--bg-glass);
        }

        .data-table .positive {
            color: var(--success);
            font-weight: bold;
        }

        .data-table .negative {
            color: var(--error);
            font-weight: bold;
        }

        /* 線條控制樣式 */
        .line-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .line-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .line-toggle:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }

        .line-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .toggle-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }

            .line-controls {
                gap: 0.5rem;
            }

            .line-toggle {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
        }

        /* 強制X軸標籤水平顯示 */
        .chart-container canvas {
            transform: none !important;
        }

        /* 交叉信號顯示樣式 */
        .cross-signal-display {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-glass);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .cross-signal-display h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .signal-content {
            display: grid;
            gap: 1rem;
        }

        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .signal-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .signal-value {
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .signal-golden {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .signal-death {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .signal-normal {
            background: rgba(100, 116, 139, 0.2);
            color: #64748b;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .signal-message-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .signal-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* Accordion 樣式 */
        .accordion-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .accordion-item {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: var(--transition);
        }

        .accordion-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        .accordion-header:hover {
            background: var(--bg-glass);
        }

        .accordion-header span {
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .accordion-icon {
            color: var(--text-secondary);
            transition: var(--transition);
        }

        /* 修復accordion展開/收合動畫 */
        .accordion-content {
            display: none;
            padding: 1.5rem;
            background: var(--bg-glass);
            border-top: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        .accordion-content.expanded {
            display: block !important;
        }

        .accordion-placeholder {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            padding: 2rem;
        }

        /* 主佈局樣式 */
        .main-layout {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }

        .sidebar {
            position: sticky;
            top: 2rem;
            width: 280px;
            flex-shrink: 0;
            height: fit-content;
        }

        .quick-actions-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: var(--transition);
        }

        .quick-actions-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .quick-actions-card .card-header {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quick-actions-card .card-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .quick-actions-card .card-content {
            padding: 1.5rem;
        }

        .action-buttons-vertical {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .action-buttons-vertical .action-btn {
            width: 100%;
            justify-content: flex-start;
            padding: 1rem;
            font-size: 0.95rem;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* 響應式設計 */
        @media (max-width: 1024px) {
            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                position: static;
                width: 100%;
                order: -1;
            }

            .quick-actions-card {
                margin-bottom: 1rem;
            }

            .action-buttons-vertical {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .action-buttons-vertical .action-btn {
                flex: 1;
                min-width: 150px;
                padding: 0.75rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 768px) {
            .action-buttons-vertical {
                flex-direction: column;
            }

            .action-buttons-vertical .action-btn {
                width: 100%;
                min-width: auto;
            }
        }

        .status-warning {
            color: #f59e0b;
            font-weight: bold;
        }

        .analysis-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .analysis-content p {
            margin: 0;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .analysis-content::-webkit-scrollbar {
            width: 6px;
        }

        .analysis-content::-webkit-scrollbar-track {
            background: var(--bg-glass);
            border-radius: 3px;
        }

        .analysis-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .analysis-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Email Report 內容樣式 */
        .email-report-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .email-report-content::-webkit-scrollbar {
            width: 6px;
        }

        .email-report-content::-webkit-scrollbar-track {
            background: var(--bg-glass);
            border-radius: 3px;
        }

        .email-report-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .email-report-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* 市場分析報告標題樣式 */
        .email-report-content h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .email-report-content h3 {
            color: var(--text-primary);
            margin: 1rem 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .email-report-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        .email-report-content ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .email-report-content li {
            margin: 0.25rem 0;
        }

        .email-report-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 1rem 0;
        }

        .email-report-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }
    </style>
</body>

</html>
