<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場分析報告系統 - 即時黃金價格</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chartjs-adapter-moment.min.js"></script>
    <script>
        // 確保 Chart.js 時間適配器正確載入
        if (typeof Chart !== 'undefined') {
            Chart.defaults.locale = 'zh-TW';
        }
    </script>
</head>

<body>
    <div class="background-animation">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
        <div class="floating-shape shape-4"></div>
        <div class="floating-shape shape-5"></div>
    </div>

    <div class="container">
        <nav class="navigation">
            <div class="nav-brand">
                <i class="fas fa-chart-line"></i>
                <span>市場分析系統</span>
            </div>
            <div class="nav-links">
                <a href="/mail" class="nav-link mail-link">
                    <i class="fas fa-envelope"></i>
                    郵件發送
                </a>
                <a href="/api/docs" class="nav-link docs-link" target="_blank">
                    <i class="fas fa-book"></i>
                    API 文檔
                </a>
                <div class="system-time" id="system-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                </div>
            </div>
        </nav>

        <header class="page-header">
            <div class="header-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h1>市場分析報告系統</h1>
            <p>智能情感分析 • 即時黃金價格 • 自動化報告</p>
        </header>

        <div class="main-content">
            <div class="card data-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h2>市場情感分析</h2>
                    <div class="status-indicator" id="status-indicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">載入中...</span>
                    </div>
                </div>
                <div class="card-content">
                    <div id="market-data-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>正在載入市場數據...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card gold-price-card">
                <div class="card-header">
                    <div class="card-icon gold-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <h2>黃金期貨價格 (GC=F)</h2>
                    <div class="price-controls">
                        <div class="price-status" id="price-status">
                            <span class="status-dot"></span>
                            <span class="status-text">載入中...</span>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="price-display" id="price-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>正在載入黃金價格...</span>
                        </div>
                    </div>

                    <div id="gold-last-updated" class="last-updated"
                        style="text-align: right; margin-top: 1rem; font-size: 0.9em; color: var(--text-muted);">
                        <i class="fas fa-sync"></i>
                        <span>--</span>
                    </div>

                    <div class="technical-indicators" id="technical-indicators" style="display: none;">
                        <h3><i class="fas fa-chart-line"></i> 技術指標</h3>
                        <div class="indicators-grid">
                            <div class="indicator-item">
                                <span class="indicator-label">MA5</span>
                                <span class="indicator-value" id="ma5-value">--</span>
                            </div>
                            <div class="indicator-item">
                                <span class="indicator-label">MA20</span>
                                <span class="indicator-value" id="ma20-value">--</span>
                            </div>
                            <div class="indicator-item">
                                <span class="indicator-label">MA50</span>
                                <span class="indicator-value" id="ma50-value">--</span>
                            </div>
                            <div class="indicator-item">
                                <span class="indicator-label">RSI</span>
                                <span class="indicator-value" id="rsi-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-area"></i> 價格走勢圖</h3>
                            <div class="chart-controls">
                                <div class="line-controls">
                                    <label class="line-toggle">
                                        <input type="checkbox" id="show-ma5" checked>
                                        <span class="toggle-label">MA5</span>
                                    </label>
                                    <label class="line-toggle">
                                        <input type="checkbox" id="show-ma20" checked>
                                        <span class="toggle-label">MA20</span>
                                    </label>
                                    <label class="line-toggle">
                                        <input type="checkbox" id="show-monthly" checked>
                                        <span class="toggle-label">月平均</span>
                                    </label>
                                    <label class="line-toggle">
                                        <input type="checkbox" id="show-yearly" checked>
                                        <span class="toggle-label">年平均</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container" id="chart-container">
                            <canvas id="goldChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card actions-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h2>快速操作</h2>
                </div>
                <div class="card-content">
                    <div class="action-buttons">
                        <a href="/mail" class="action-btn primary">
                            <i class="fas fa-paper-plane"></i>
                            <span>發送郵件報告</span>
                        </a>
                        <button onclick="refreshAllData()" class="action-btn secondary" id="refresh-btn">
                            <i class="fas fa-sync"></i>
                            <span>刷新數據</span>
                        </button>
                        <a href="/api/docs" target="_blank" class="action-btn info">
                            <i class="fas fa-book"></i>
                            <span>API 文檔</span>
                        </a>
                        <button onclick="toggleTechnicalIndicators()" class="action-btn gold" id="indicator-toggle">
                            <i class="fas fa-chart-line"></i>
                            <span>顯示技術指標</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card data-details-card" style="margin-top: 2rem;">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-database"></i>
                </div>
                <h2>詳細數據日誌</h2>
                <button onclick="toggleDataDetails()" class="action-btn secondary" id="details-toggle">
                    <i class="fas fa-eye"></i>
                    <span>顯示詳情</span>
                </button>
            </div>
            <div class="card-content" id="data-details" style="display: none;">
                <div id="detailed-logs">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>正在載入詳細數據...</span>
                    </div>
                </div>
            </div>
        </div>

        <footer class="page-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>市場分析報告系統</h3>
                    <p>AI 驅動的智能市場分析與報告生成平台</p>
                </div>
                <div class="footer-stats">
                    <div class="stat-item">
                        <span class="stat-label">系統版本</span>
                        <span class="stat-value">v2.1.0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">數據來源</span>
                        <span class="stat-value">Yahoo Finance</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">下次更新</span>
                        <span class="stat-value" id="next-update">--</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ===== 全域變數 =====
        let goldChart = null;
        let goldPriceData = null;
        let marketData = null;
        let currentPeriod = '1y'; // 固定為一年
        let autoRefreshInterval = null;
        let indicatorsVisible = false;
        let detailsVisible = false;
        let showMA5 = true;
        let showMA20 = true;
        let showMonthly = true;
        let showYearly = true;

        // ===== 初始化 =====
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 市場分析系統載入中...');

            // 檢查Chart.js是否載入
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js 未載入，請檢查網路連接');
            } else {
                console.log('✅ Chart.js 已載入');
                console.log('Chart.js 版本:', Chart.version);
            }

            // 開始載入數據
            initializeSystem();

            // 設定事件監聽
            setupEventListeners();

            // 啟動時間更新
            updateSystemTime();
            setInterval(updateSystemTime, 1000);

            // 設定自動刷新（每5分鐘）
            autoRefreshInterval = setInterval(refreshAllData, 60000);

            // 監聽視窗大小改變
            window.addEventListener('resize', () => {
                if (goldChart && goldPriceData) {
                    setTimeout(() => {
                        createGoldChart(goldPriceData);
                    }, 100);
                }
            });

            console.log('✅ 系統初始化完成');
        });

        // ===== 系統初始化 =====
        async function initializeSystem() {
            console.log('📊 開始載入所有數據...');

            // 並行載入數據
            await Promise.all([
                loadMarketData(),
                loadGoldPrice(currentPeriod, true)
            ]);

            console.log('✅ 所有數據載入完成');
        }

        // ===== 事件監聽設定 =====
        function setupEventListeners() {
            // 線條顯示控制
            const lineToggles = document.querySelectorAll('.line-toggle input');
            lineToggles.forEach(toggle => {
                toggle.addEventListener('change', function () {
                    const lineType = this.id.replace('show-', '');
                    console.log(`📈 切換線條顯示: ${lineType} = ${this.checked}`);

                    if (lineType === 'ma5') showMA5 = this.checked;
                    if (lineType === 'ma20') showMA20 = this.checked;
                    if (lineType === 'monthly') showMonthly = this.checked;
                    if (lineType === 'yearly') showYearly = this.checked;

                    if (goldPriceData) {
                        createGoldChart(goldPriceData);
                    }
                });
            });

            console.log('🎯 事件監聽器設定完成');
        }

        // ===== 時間更新 =====
        function updateSystemTime() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('zh-TW');
            }
        }

        // ===== 載入市場數據 =====
        async function loadMarketData() {
            try {
                console.log('📈 開始載入市場情感分析數據...');
                updateMarketStatus('loading', '載入中...');

                const response = await fetch('/api/current-data');
                const result = await response.json();

                console.log('📥 市場數據API回應:', result);

                if (response.ok && result.status === 'success') {
                    if (result.data && typeof result.data === 'object' && Object.keys(result.data).length > 0) {
                        marketData = result.data;
                        console.log('✅ 成功接收市場數據:', marketData);
                        displayMarketData(marketData);
                        updateMarketStatus('connected', '已連接');


                    } else {
                        console.log('⚠️ 市場數據為空');
                        displayNoMarketData();
                        updateMarketStatus('waiting', '等待數據...');
                    }
                } else {
                    throw new Error(result.message || `HTTP 錯誤: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ 載入市場數據失敗:', error);
                displayMarketError('無法載入市場數據: ' + error.message);
                updateMarketStatus('error', '連接錯誤');
            }
        }

        // ===== 載入黃金價格數據 =====
        async function loadGoldPrice(period = currentPeriod, showLoading = true) {
            try {
                if (showLoading) {
                    updatePriceStatus('loading', '載入中...');
                    showPriceLoading();
                }

                console.log(`🔍 正在獲取黃金期貨數據 - 期間: ${period}`);
                const response = await fetch(`/api/gold-price?period=${period}&interval=1d`);
                const result = await response.json();

                console.log('💰 黃金價格API回應:', result);

                if (response.ok && result.status === 'success' && result.data) {
                    goldPriceData = result.data;
                    console.log('✅ 成功獲取黃金價格數據:');
                    console.log(`   價格: $${result.data.current_price}`);
                    console.log(`   變化: ${result.data.change} (${result.data.change_percent}%)`);
                    console.log(`   數據點數量: ${result.data.chart_data?.length || 0}`);

                    displayGoldPrice(result.data);
                    updateTechnicalIndicators(result.data.technical_indicators || {});

                    // 檢查圖表數據
                    console.log('📊 準備創建圖表，數據檢查:');
                    console.log('chart_data 存在:', !!result.data.chart_data);
                    console.log('chart_data 類型:', typeof result.data.chart_data);
                    console.log('chart_data 長度:', result.data.chart_data?.length);
                    if (result.data.chart_data && result.data.chart_data.length > 0) {
                        console.log('第一個數據點:', result.data.chart_data[0]);
                    }

                    // 檢查MA線數據
                    console.log('MA5 數據存在:', !!result.data.ma_lines?.ma_5);
                    console.log('MA20 數據存在:', !!result.data.ma_lines?.ma_20);
                    console.log('月平均線數據存在:', !!result.data.monthly_average_line);
                    console.log('年平均價格線數據存在:', !!result.data.yearly_average_line);
                    if (result.data.ma_lines?.ma_5) {
                        console.log('MA5 數據點數:', result.data.ma_lines.ma_5.length);
                    }
                    if (result.data.ma_lines?.ma_20) {
                        console.log('MA20 數據點數:', result.data.ma_lines.ma_20.length);
                    }
                    if (result.data.monthly_average_line) {
                        console.log('月平均線數據點數:', result.data.monthly_average_line.length);
                    }
                    if (result.data.yearly_average_line) {
                        console.log('年平均價格線數據點數:', result.data.yearly_average_line.length);
                    }

                    // 延遲創建圖表，確保DOM完全載入
                    setTimeout(() => {
                        createGoldChart(result.data);
                    }, 500);

                    updatePriceStatus('connected', '即時更新');

                    if (result.next_update) {
                        document.getElementById('next-update').textContent =
                            new Date(result.next_update).toLocaleTimeString('zh-TW');
                    }

                    if (result.data.last_updated_formatted) {
                        updateGoldLastUpdated(`最後更新: ${result.data.last_updated_formatted}`);
                    } else if (result.data.last_updated) {
                        const lastUpdated = new Date(result.data.last_updated);
                        updateGoldLastUpdated(`最後更新: ${lastUpdated.toLocaleString('zh-TW')}`);
                    }

                    // 更新詳細日誌
                    updateDetailedLogs(result);

                } else {
                    throw new Error(result.message || `HTTP 錯誤: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ 載入黃金價格失敗:', error);
                displayPriceError('無法載入黃金價格: ' + error.message);
                updatePriceStatus('error', '連接錯誤');
            }
        }

        // ===== 顯示市場數據 =====
        function displayMarketData(data) {
            console.log('🎨 顯示市場數據:', data);

            const sentimentClass = getSentimentClass(data.average_sentiment_score);
            const sentimentText = getSentimentText(data.average_sentiment_score);

            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="market-data">
                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-heart-pulse"></i>
                            情感分數
                        </div>
                        <div class="data-value">
                            <span class="sentiment-score sentiment-${sentimentClass}">
                                ${sentimentText} (${data.average_sentiment_score?.toFixed(3) || 'N/A'})
                            </span>
                        </div>
                    </div>

                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-calendar-day"></i>
                            市場日期
                        </div>
                        <div class="data-value">${data.market_date || '未知'}</div>
                    </div>

                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-gauge"></i>
                            信心水平
                        </div>
                        <div class="data-value">${data.confidence_level || '未評估'}</div>
                    </div>

                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-trending-up"></i>
                            趨勢方向
                        </div>
                        <div class="data-value">${data.trend_direction || '未評估'}</div>
                    </div>

                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-shield-alt"></i>
                            風險評估
                        </div>
                        <div class="data-value">${data.risk_assessment || '未評估'}</div>
                    </div>

                    <div class="data-row full-width">
                        <div class="data-label">
                            <i class="fas fa-newspaper"></i>
                            分析內容
                        </div>
                        <div class="market-content" id="market-content">
                            ${data.raw_data.message.content || ''}
                        </div>
                        ${data.raw_data.message.content && data.raw_data.message.content.length > 200
                    ? '<button class="expand-btn" onclick="toggleMarketContent()">展開全文</button>'
                    : ''}
                    </div>











                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-clock"></i>
                            接收時間
                        </div>
                        <div class="data-value">${data.received_time || '未知'}</div>
                    </div>
                </div>
            `;
        }

        // ===== 顯示黃金價格 =====
        function displayGoldPrice(data) {
            console.log('💰 顯示黃金價格數據:', data);

            const priceChangeClass = data.change >= 0 ? 'positive' : 'negative';
            const priceChangeIcon = data.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="gold-price-info">
                    <div class="price-main">
                        <div class="current-price">
                            <span class="price-value">$${data.current_price?.toFixed(2) || 'N/A'}</span>
                            <span class="price-unit">${data.unit || 'USD/oz'}</span>
                        </div>
                        <div class="price-change ${priceChangeClass}">
                            <i class="fas ${priceChangeIcon}"></i>
                            <span>${data.change >= 0 ? '+' : ''}${data.change?.toFixed(2) || 'N/A'}</span>
                            <span>(${data.change_percent >= 0 ? '+' : ''}${data.change_percent?.toFixed(2) || 'N/A'}%)</span>
                        </div>
                    </div>

                    <div class="price-statistics">
                        <div class="stat-grid">
                            <div class="stat-item">
                                <span class="stat-label">24H 高</span>
                                <span class="stat-value">$${data.high_24h?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">24H 低</span>
                                <span class="stat-value">$${data.low_24h?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">平均價格</span>
                                <span class="stat-value">$${data.avg_price?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">波動率</span>
                                <span class="stat-value">${data.volatility?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">交易量</span>
                                <span class="stat-value">${data.volume_24h?.toLocaleString() || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">市場狀態</span>
                                <span class="stat-value market-${data.market_status}">${getMarketStatusText(data.market_status)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== 創建黃金價格圖表 =====
        function createGoldChart(data) {
            console.log('🎨 開始創建黃金價格圖表...');
            console.log('接收到的數據:', data);

            const canvas = document.getElementById('goldChart');
            const container = document.getElementById('chart-container');

            if (!canvas) {
                console.error('❌ 找不到 Canvas 元素: goldChart');
                return;
            }

            if (!container) {
                console.error('❌ 找不到圖表容器: chart-container');
                return;
            }

            // 檢查容器是否可見
            const containerStyle = window.getComputedStyle(container);
            console.log('容器顯示狀態:', containerStyle.display);
            console.log('容器可見性:', containerStyle.visibility);

            // 確保容器可見
            if (containerStyle.display === 'none') {
                container.style.display = 'block';
            }

            // 重要：正確銷毀現有圖表
            if (goldChart) {
                console.log('🗑️ 銷毀現有圖表');
                goldChart.destroy();
                goldChart = null;
            }

            // 重新設置 Canvas 尺寸
            canvas.width = container.offsetWidth || 800;
            canvas.height = container.offsetHeight || 400;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            console.log('Canvas 尺寸:', canvas.width, 'x', canvas.height);
            console.log('容器尺寸:', container.offsetWidth, 'x', container.offsetHeight);

            if (!data.chart_data || !Array.isArray(data.chart_data) || data.chart_data.length === 0) {
                console.warn('⚠️ 圖表數據為空或無效，不渲染圖表');
                console.log('數據詳情:', data.chart_data);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            console.log(`📊 創建圖表，數據點: ${data.chart_data.length}`);
            console.log('原始數據樣本:', data.chart_data.slice(0, 3));

            const chartData = data.chart_data;

            // 簡化數據處理，使用字符串日期
            const labels = chartData.map(d => d.time);
            const prices = chartData.map(d => parseFloat(d.price) || 0);

            console.log('處理後的標籤:', labels.slice(0, 5));
            console.log('處理後的價格:', prices.slice(0, 5));
            console.log('標籤總數:', labels.length);
            console.log('價格總數:', prices.length);
            console.log('有效價格數量:', prices.filter(p => p > 0).length);

            // 準備數據集 - 使用簡單的數組格式
            const validPrices = prices.filter(p => p > 0);
            const validLabels = labels.slice(0, validPrices.length);

            console.log('有效價格數量:', validPrices.length);
            console.log('有效標籤數量:', validLabels.length);
            console.log('有效標籤樣本:', validLabels.slice(0, 5));
            console.log('主數據時間格式樣本:', validLabels.slice(0, 3).map(label => {
                const date = new Date(label);
                return {
                    original: label,
                    date: date.toISOString().split('T')[0]
                };
            }));

            const datasets = [{
                label: '黃金價格 (USD/oz)',
                data: validPrices,
                borderColor: '#FFD700',
                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                spanGaps: true
            }];

            console.log('主數據格式檢查:', {
                validPricesLength: validPrices.length,
                validPricesSample: validPrices.slice(0, 3),
                validLabelsLength: validLabels.length,
                validLabelsSample: validLabels.slice(0, 3)
            });

            // 添加MA5線
            if (showMA5 && data.ma_lines && data.ma_lines.ma_5) {
                console.log('🔍 處理MA5數據...');
                // 創建MA5數據映射
                const ma5Map = {};
                data.ma_lines.ma_5.forEach(d => {
                    ma5Map[d.time] = parseFloat(d.price) || 0;
                });

                console.log('MA5映射樣本:', Object.keys(ma5Map).slice(0, 5));

                // 對齊到主數據的時間軸
                const ma5Prices = validLabels.map(label => ma5Map[label] || null);
                const validMa5Prices = ma5Prices.filter(p => p !== null && p > 0);

                // 確保數據長度與主數據一致
                const alignedMa5Prices = validLabels.map(label => ma5Map[label] || null);

                console.log('MA5對齊數據點數:', alignedMa5Prices.filter(p => p !== null).length);

                if (alignedMa5Prices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'MA5',
                        data: alignedMa5Prices,
                        borderColor: '#FF6B6B',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        spanGaps: true
                    });
                }
            }

            // 添加MA20線
            if (showMA20 && data.ma_lines && data.ma_lines.ma_20) {
                console.log('🔍 處理MA20數據...');
                // 創建MA20數據映射
                const ma20Map = {};
                data.ma_lines.ma_20.forEach(d => {
                    ma20Map[d.time] = parseFloat(d.price) || 0;
                });

                console.log('MA20映射樣本:', Object.keys(ma20Map).slice(0, 5));

                // 對齊到主數據的時間軸
                const ma20Prices = validLabels.map(label => ma20Map[label] || null);
                const validMa20Prices = ma20Prices.filter(p => p !== null && p > 0);

                // 確保數據長度與主數據一致
                const alignedMa20Prices = validLabels.map(label => ma20Map[label] || null);

                console.log('MA20對齊數據點數:', alignedMa20Prices.filter(p => p !== null).length);

                if (alignedMa20Prices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'MA20',
                        data: alignedMa20Prices,
                        borderColor: '#4ECDC4',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        spanGaps: true
                    });
                }
            }

            // 添加每月平均線
            if (showMonthly && data.monthly_average_line && data.monthly_average_line.length > 0) {
                console.log('🔍 處理月平均線數據...');
                console.log('月平均線原始數據:', data.monthly_average_line);

                // 創建月平均線數據映射
                const monthlyMap = {};
                data.monthly_average_line.forEach(d => {
                    monthlyMap[d.time] = parseFloat(d.price) || 0;
                });

                console.log('月平均線映射樣本:', Object.keys(monthlyMap).slice(0, 5));
                console.log('月平均線映射值樣本:', Object.values(monthlyMap).slice(0, 5));

                // 對齊到主數據的時間軸 - 修正對齊邏輯
                const alignedMonthlyPrices = validLabels.map(label => {
                    // 直接使用日期字符串進行匹配
                    return monthlyMap[label] || null;
                });

                console.log('月平均線對齊數據點數:', alignedMonthlyPrices.filter(p => p !== null).length);
                console.log('月平均線對齊數據樣本:', alignedMonthlyPrices.slice(0, 10));
                console.log('月平均線數據類型檢查:', {
                    total: alignedMonthlyPrices.length,
                    valid: alignedMonthlyPrices.filter(p => p !== null).length,
                    null: alignedMonthlyPrices.filter(p => p === null).length,
                    zero: alignedMonthlyPrices.filter(p => p === 0).length,
                    positive: alignedMonthlyPrices.filter(p => p > 0).length
                });

                if (alignedMonthlyPrices.filter(p => p !== null).length > 0) {
                    // 創建月平均線數據集，使用與主數據相同的格式
                    datasets.push({
                        label: '月平均線',
                        data: alignedMonthlyPrices,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#8B5CF6',
                        pointBorderColor: '#FFFFFF',
                        pointBorderWidth: 2,
                        borderDash: [8, 4],
                        spanGaps: true
                    });
                } else {
                    console.log('⚠️ 月平均線沒有有效數據點');
                }
            } else {
                console.log('⚠️ 月平均線數據不存在或為空');
                console.log('showMonthly:', showMonthly);
                console.log('data.monthly_average_line 存在:', !!data.monthly_average_line);
                console.log('data.monthly_average_line 長度:', data.monthly_average_line?.length);
            }

            // 添加年平均價格線
            if (showYearly && data.yearly_average_line && data.yearly_average_line.length > 0) {
                console.log('🔍 處理年平均價格線數據...');
                console.log('年平均價格線原始數據:', data.yearly_average_line);

                // 創建年平均價格線數據映射
                const yearlyMap = {};
                data.yearly_average_line.forEach(d => {
                    yearlyMap[d.time] = parseFloat(d.price) || 0;
                });

                console.log('年平均價格線映射樣本:', Object.keys(yearlyMap).slice(0, 5));
                console.log('年平均價格線映射值樣本:', Object.values(yearlyMap).slice(0, 5));

                // 對齊到主數據的時間軸 - 修正對齊邏輯
                const alignedYearlyPrices = validLabels.map(label => {
                    // 直接使用日期字符串進行匹配
                    return yearlyMap[label] || null;
                });

                console.log('年平均價格線對齊數據點數:', alignedYearlyPrices.filter(p => p !== null).length);
                console.log('年平均價格線對齊數據樣本:', alignedYearlyPrices.slice(0, 10));
                console.log('年平均價格線數據類型檢查:', {
                    total: alignedYearlyPrices.length,
                    valid: alignedYearlyPrices.filter(p => p !== null).length,
                    null: alignedYearlyPrices.filter(p => p === null).length,
                    zero: alignedYearlyPrices.filter(p => p === 0).length,
                    positive: alignedYearlyPrices.filter(p => p > 0).length
                });

                if (alignedYearlyPrices.filter(p => p !== null).length > 0) {
                    // 創建年平均價格線數據集，使用與主數據相同的格式
                    datasets.push({
                        label: '年平均價格',
                        data: alignedYearlyPrices,
                        borderColor: '#FF8C00',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderDash: [10, 5],
                        spanGaps: true
                    });
                } else {
                    console.log('⚠️ 年平均價格線沒有有效數據點');
                }
            } else {
                console.log('⚠️ 年平均價格線數據不存在或為空');
                console.log('showYearly:', showYearly);
                console.log('data.yearly_average_line 存在:', !!data.yearly_average_line);
                console.log('data.yearly_average_line 長度:', data.yearly_average_line?.length);
            }

            const config = {
                type: 'line',
                data: {
                    labels: validLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 20   // 整張圖底部多留 20px
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `黃金期貨價格走勢 (一年)`,
                            color: '#f8fafc',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            labels: { color: '#cbd5e1' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                title: function (context) {
                                    const dataIndex = context[0].dataIndex;
                                    if (dataIndex < labels.length) {
                                        return labels[dataIndex];
                                    }
                                    return '未知日期';
                                },
                                label: function (context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#64748b',
                                rotation: 0,  // 旋轉角度
                                minRotation: 0,  // 最小旋轉角度
                                maxRotation: 0,  // 最大旋轉角度
                                autoSkip: true,
                                font: {
                                    size: 12,
                                    weight: 'normal'
                                },
                                callback: function (value, index, ticks) {
                                    if (index < validLabels.length) {
                                        const date = new Date(validLabels[index]);
                                        if (!isNaN(date.getTime())) {
                                            const year = date.getFullYear();
                                            const month = date.getMonth() + 1;
                                            return `${year}年${month}月`;
                                        }
                                    }
                                    return '';
                                }
                            },
                            grid: {
                                color: 'rgba(100, 116, 139, 0.1)'
                            },
                            afterFit: function (scale) {
                                scale.paddingTop = 10;
                                scale.paddingBottom = 10;
                            }
                        },
                        y: {
                            ticks: {
                                color: '#64748b',
                                callback: function (value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(100, 116, 139, 0.1)' }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 60
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            };

            try {
                const ctx = canvas.getContext('2d');
                console.log('🎨 開始渲染圖表...');
                console.log('Canvas 尺寸:', canvas.width, 'x', canvas.height);
                console.log('數據集數量:', datasets.length);
                console.log('有效價格數據點數:', validPrices.length);

                // 確保 Chart.js 已載入
                if (typeof Chart === 'undefined') {
                    console.error('❌ Chart.js 未載入');
                    return;
                }

                // 檢查數據是否有效
                if (validPrices.length === 0) {
                    console.error('❌ 有效價格數據為空，無法創建圖表');
                    return;
                }

                console.log('配置對象:', config);
                goldChart = new Chart(ctx, config);
                console.log('✅ 圖表創建成功');
                console.log('圖表實例:', goldChart);

                // 強制X軸標籤水平顯示
                setTimeout(() => {
                    if (goldChart && goldChart.options && goldChart.options.scales && goldChart.options.scales.x) {
                        goldChart.options.scales.x.ticks.rotation = 0;
                        goldChart.options.scales.x.ticks.maxTicksLimit = 6;
                        goldChart.update('none');

                        // 再次強制更新
                        setTimeout(() => {
                            goldChart.update('none');
                        }, 200);
                    }
                }, 100);

            } catch (error) {
                console.error('❌ 創建圖表時發生錯誤:', error);
                console.error('錯誤詳情:', error.message);
                console.error('錯誤堆疊:', error.stack);
            }
        }

        // ===== 更新技術指標 =====
        function updateTechnicalIndicators(indicators) {
            console.log('📊 更新技術指標:', indicators);

            if (indicators.ma_5) {
                document.getElementById('ma5-value').textContent = '$' + indicators.ma_5.toFixed(2);
            }
            if (indicators.ma_20) {
                document.getElementById('ma20-value').textContent = '$' + indicators.ma_20.toFixed(2);
            }
            if (indicators.ma_50) {
                document.getElementById('ma50-value').textContent = '$' + indicators.ma_50.toFixed(2);
            }
            if (indicators.rsi) {
                const rsiElement = document.getElementById('rsi-value');
                rsiElement.textContent = indicators.rsi.toFixed(1);

                // RSI 顏色指示
                rsiElement.className = 'indicator-value';
                if (indicators.rsi > 70) {
                    rsiElement.classList.add('rsi-overbought');
                } else if (indicators.rsi < 30) {
                    rsiElement.classList.add('rsi-oversold');
                } else {
                    rsiElement.classList.add('rsi-neutral');
                }
            }
        }

        // ===== 更新詳細日誌 =====
        function updateDetailedLogs(goldData) {
            const detailsContainer = document.getElementById('detailed-logs');
            if (!detailsContainer) return;

            console.log('📝 更新詳細日誌');

            const logs = [];

            // 系統資訊
            logs.push(`<div class="log-section">
                <h4><i class="fas fa-info-circle"></i> 系統資訊</h4>
                <div class="log-content">
                    <p><strong>系統時間:</strong> ${new Date().toLocaleString('zh-TW')}</p>
                    <p><strong>數據來源:</strong> ${goldData.data_source || 'Yahoo Finance'}</p>
                    <p><strong>API狀態:</strong> <span class="status-success">正常</span></p>
                    <p><strong>下次更新:</strong> ${goldData.next_update || '5分鐘後'}</p>
                </div>
            </div>`);

            // 黃金價格詳情
            if (goldData.data) {
                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-coins"></i> 黃金價格詳情</h4>
                    <div class="log-content">
                        <p><strong>代碼:</strong> ${goldData.data.symbol || 'GC=F'}</p>
                        <p><strong>名稱:</strong> ${goldData.data.name || 'Gold Futures'}</p>
                        <p><strong>當前價格:</strong> ${goldData.data.current_price?.toFixed(2) || 'N/A'}</p>
                        <p><strong>變化金額:</strong> ${goldData.data.change >= 0 ? '+' : ''}${goldData.data.change?.toFixed(2) || 'N/A'}</p>
                        <p><strong>變化百分比:</strong> ${goldData.data.change_percent >= 0 ? '+' : ''}${goldData.data.change_percent?.toFixed(2) || 'N/A'}%</p>
                        <p><strong>24小時最高:</strong> ${goldData.data.high_24h?.toFixed(2) || 'N/A'}</p>
                        <p><strong>24小時最低:</strong> ${goldData.data.low_24h?.toFixed(2) || 'N/A'}</p>
                        <p><strong>平均價格:</strong> ${goldData.data.avg_price?.toFixed(2) || 'N/A'}</p>
                        <p><strong>波動率:</strong> ${goldData.data.volatility?.toFixed(2) || 'N/A'}</p>
                        <p><strong>交易量:</strong> ${goldData.data.volume_24h?.toLocaleString() || 'N/A'}</p>
                        <p><strong>市場狀態:</strong> ${getMarketStatusText(goldData.data.market_status)}</p>
                        <p><strong>貨幣單位:</strong> ${goldData.data.currency || 'USD'}</p>
                        <p><strong>數據點數量:</strong> ${goldData.data.data_points || 0}</p>
                        <p><strong>交易天數:</strong> ${goldData.data.trading_days || 0}</p>
                        <p><strong>時間期間:</strong> 一年</p>
                        <p><strong>時間間隔:</strong> ${goldData.data.interval || '1d'}</p>
                        <p><strong>最後更新:</strong> ${goldData.data.last_updated_formatted || (goldData.data.last_updated ? new Date(goldData.data.last_updated).toLocaleString('zh-TW') : '未知')}</p>
                        
                    </div>
                </div>`);
            }

            // 技術指標詳情
            if (goldData.data?.technical_indicators) {
                const indicators = goldData.data.technical_indicators;
                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-chart-line"></i> 技術指標詳情</h4>
                    <div class="log-content">
                        ${indicators.ma_5 ? `<p><strong>MA5 (5日移動平均):</strong> ${indicators.ma_5.toFixed(2)}</p>` : ''}
                        ${indicators.ma_20 ? `<p><strong>MA20 (20日移動平均):</strong> ${indicators.ma_20.toFixed(2)}</p>` : ''}
                        ${indicators.ma_50 ? `<p><strong>MA50 (50日移動平均):</strong> ${indicators.ma_50.toFixed(2)}</p>` : ''}
                        ${indicators.rsi ? `<p><strong>RSI (相對強弱指標):</strong> ${indicators.rsi.toFixed(1)} ${getRSIStatus(indicators.rsi)}</p>` : ''}
                        ${indicators.volatility_5d ? `<p><strong>5日波動率:</strong> ${indicators.volatility_5d.toFixed(2)}</p>` : ''}
                        ${indicators.price_vs_ma20 ? `<p><strong>價格相對MA20:</strong> ${indicators.price_vs_ma20 >= 0 ? '+' : ''}${indicators.price_vs_ma20.toFixed(2)}%</p>` : ''}
                    </div>
                </div>`);
            }

            // 市場數據詳情
            if (marketData) {
                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-brain"></i> 市場情感分析詳情</h4>
                    <div class="log-content">
                        <p><strong>情感分數:</strong> ${marketData.average_sentiment_score?.toFixed(3) || 'N/A'}</p>
                        <p><strong>情感描述:</strong> ${getSentimentText(marketData.average_sentiment_score)}</p>
                        <p><strong>市場日期:</strong> ${marketData.market_date || '未知'}</p>
                        <p><strong>信心水平:</strong> ${marketData.confidence_level || '未評估'}</p>
                        <p><strong>趨勢方向:</strong> ${marketData.trend_direction || '未評估'}</p>
                        <p><strong>風險評估:</strong> ${marketData.risk_assessment || '未評估'}</p>
                        <p><strong>接收時間:</strong> ${marketData.received_time || '未知'}</p>
                        <p><strong>內容長度:</strong> ${marketData.message_content?.length || 0} 字元</p>
                    </div>
                </div>`);
            }

            // 圖表數據樣本
            if (goldData.data?.chart_data && goldData.data.chart_data.length > 0) {
                const chartData = goldData.data.chart_data;
                const sampleSize = Math.min(5, chartData.length);
                const samples = chartData.slice(-sampleSize);

                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-database"></i> 圖表數據樣本 (最近${sampleSize}筆)</h4>
                    <div class="log-content">
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>時間</th>
                                        <th>開盤</th>
                                        <th>最高</th>
                                        <th>最低</th>
                                        <th>收盤</th>
                                        <th>交易量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${samples.map(point => `
                                        <tr>
                                            <td>${new Date(point.time).toLocaleDateString('zh-TW')}</td>
                                            <td>${point.open?.toFixed(2) || 'N/A'}</td>
                                            <td>${point.high?.toFixed(2) || 'N/A'}</td>
                                            <td>${point.low?.toFixed(2) || 'N/A'}</td>
                                            <td>${point.price?.toFixed(2) || 'N/A'}</td>
                                            <td>${point.volume?.toLocaleString() || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`);
            }

            // 每月平均線詳情
            if (goldData.data?.monthly_average_line && goldData.data.monthly_average_line.length > 0) {
                const monthlyData = goldData.data.monthly_average_line;
                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-calendar-alt"></i> 每月平均線詳情</h4>
                    <div class="log-content">
                        <p><strong>數據點數:</strong> ${monthlyData.length}</p>
                        <p><strong>時間範圍:</strong> ${new Date(monthlyData[0].time).toLocaleDateString('zh-TW')} - ${new Date(monthlyData[monthlyData.length - 1].time).toLocaleDateString('zh-TW')}</p>
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>月份</th>
                                        <th>平均價格</th>
                                        <th>變化</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${monthlyData.map((point, index) => {
                    const prevPrice = index > 0 ? monthlyData[index - 1].price : point.price;
                    const change = point.price - prevPrice;
                    const changePercent = (change / prevPrice * 100);
                    return `
                                            <tr>
                                                <td>${new Date(point.time).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' })}</td>
                                                <td>$${point.price.toFixed(2)}</td>
                                                <td class="${change >= 0 ? 'positive' : 'negative'}">
                                                    ${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%)
                                                </td>
                                            </tr>
                                        `;
                }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`);
            }

            // 完整年度數據統計
            if (goldData.data?.chart_data && goldData.data.chart_data.length > 0) {
                const chartData = goldData.data.chart_data;
                const prices = chartData.map(d => d.price).filter(p => p && !isNaN(p));
                const volumes = chartData.map(d => d.volume).filter(v => v && !isNaN(v));

                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-chart-bar"></i> 完整年度數據統計</h4>
                    <div class="log-content">
                        <p><strong>總數據點數:</strong> ${chartData.length}</p>
                        <p><strong>有效價格數據:</strong> ${prices.length}</p>
                        <p><strong>價格範圍:</strong> ${Math.min(...prices).toFixed(2)} - ${Math.max(...prices).toFixed(2)}</p>
                        <p><strong>年度平均價格:</strong> ${(prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2)}</p>
                        <p><strong>年度價格標準差:</strong> ${calculateStandardDeviation(prices).toFixed(2)}</p>
                        <p><strong>總交易量:</strong> ${volumes.reduce((a, b) => a + b, 0).toLocaleString()}</p>
                        <p><strong>平均日交易量:</strong> ${(volumes.reduce((a, b) => a + b, 0) / volumes.length).toLocaleString()}</p>
                        <p><strong>數據起始日期:</strong> ${new Date(chartData[0].time).toLocaleDateString('zh-TW')}</p>
                        <p><strong>數據結束日期:</strong> ${new Date(chartData[chartData.length - 1].time).toLocaleDateString('zh-TW')}</p>
                        <p><strong>年度漲跌:</strong> ${((prices[prices.length - 1] - prices[0]) / prices[0] * 100).toFixed(2)}%</p>
                    </div>
                </div>`);
            }

            detailsContainer.innerHTML = logs.join('');
        }

        // ===== 狀態更新函數 =====
        function updateMarketStatus(status, text) {
            const dot = document.querySelector('#status-indicator .indicator-dot');
            const textElement = document.querySelector('#status-indicator .indicator-text');

            if (dot && textElement) {
                dot.classList.remove('connected', 'error', 'loading');
                if (status !== 'waiting') {
                    dot.classList.add(status);
                }
                textElement.textContent = text;
            }
        }

        function updatePriceStatus(status, text) {
            const dot = document.querySelector('#price-status .status-dot');
            const textElement = document.querySelector('#price-status .status-text');

            if (dot && textElement) {
                dot.classList.remove('connected', 'error', 'loading');
                if (status !== 'waiting') {
                    dot.classList.add(status);
                }
                textElement.textContent = text;
            }
        }

        function updateGoldLastUpdated(text) {
            const element = document.getElementById('gold-last-updated');
            if (element) {
                element.querySelector('span').textContent = text;
            }
        }

        // ===== 載入和錯誤顯示函數 =====
        function showPriceLoading() {
            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <span>正在載入黃金價格...</span>
                </div>
            `;
        }

        function displayNoMarketData() {
            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-chart-bar"></i>
                    <h3>等待市場數據</h3>
                    <p>請確認 N8N 工作流程已正確運行並發送數據</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        重新載入
                    </button>
                </div>
            `;
        }

        function displayMarketError(message) {
            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>數據載入失敗</h3>
                    <p>${message}</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        重試
                    </button>
                </div>
            `;
        }

        function displayPriceError(message) {
            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>價格載入失敗</h3>
                    <p>${message}</p>
                    <button onclick="loadGoldPrice(currentPeriod, true)" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        重試
                    </button>
                </div>
            `;
        }

        // ===== 輔助函數 =====
        function getSentimentClass(score) {
            if (score > 0.1) return 'positive';
            if (score < -0.1) return 'negative';
            return 'neutral';
        }

        function getSentimentText(score) {
            if (score > 0.6) return '極度樂觀';
            if (score > 0.3) return '樂觀';
            if (score > 0.1) return '略為樂觀';
            if (score > -0.1) return '中性';
            if (score > -0.3) return '略為悲觀';
            if (score > -0.6) return '悲觀';
            return '極度悲觀';
        }

        function getMarketStatusText(status) {
            const statusMap = {
                'open': '開市',
                'closed': '休市',
                'unknown': '未知'
            };
            return statusMap[status] || status;
        }

        function getRSIStatus(rsi) {
            if (rsi > 70) return '(超買)';
            if (rsi < 30) return '(超賣)';
            return '(正常)';
        }

        function calculateStandardDeviation(values) {
            const avg = values.reduce((a, b) => a + b) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        // ===== 按鈕操作函數 =====
        function refreshAllData() {
            console.log('🔄 刷新所有數據');
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>刷新中...</span>';
            }

            Promise.all([
                loadMarketData(),
                loadGoldPrice(currentPeriod, true)
            ]).finally(() => {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync"></i><span>刷新數據</span>';
                }
            });
        }

        function toggleTechnicalIndicators() {
            const indicators = document.getElementById('technical-indicators');
            const toggleBtn = document.getElementById('indicator-toggle');

            if (indicators) {
                indicatorsVisible = !indicatorsVisible;
                indicators.style.display = indicatorsVisible ? 'block' : 'none';

                if (toggleBtn) {
                    toggleBtn.innerHTML = indicatorsVisible ?
                        '<i class="fas fa-eye-slash"></i><span>隱藏技術指標</span>' :
                        '<i class="fas fa-eye"></i><span>顯示技術指標</span>';
                }
            }
        }

        function toggleDataDetails() {
            const details = document.getElementById('data-details');
            const toggleBtn = document.getElementById('details-toggle');

            if (details) {
                detailsVisible = !detailsVisible;
                details.style.display = detailsVisible ? 'block' : 'none';

                if (toggleBtn) {
                    toggleBtn.innerHTML = detailsVisible ?
                        '<i class="fas fa-eye-slash"></i><span>隱藏詳情</span>' :
                        '<i class="fas fa-eye"></i><span>顯示詳情</span>';
                }

                // 如果顯示詳情且有數據，更新日誌
                if (detailsVisible && goldPriceData) {
                    updateDetailedLogs({ data: goldPriceData });
                }
            }
        }

        function toggleMarketContent() {
            const content = document.getElementById('market-content');
            const isExpanded = content.style.maxHeight === 'none';

            content.style.maxHeight = isExpanded ? '200px' : 'none';
            content.style.overflow = isExpanded ? 'hidden' : 'visible';

            const btn = content.nextElementSibling;
            if (btn && btn.classList.contains('expand-btn')) {
                btn.textContent = isExpanded ? '展開全文' : '收起';
            }
        }

        // ===== 錯誤處理 =====
        window.addEventListener('error', (e) => {
            console.error('JavaScript 錯誤:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('未處理的 Promise 拒絕:', e.reason);
        });

        console.log('✅ 市場分析系統腳本載入完成');
    </script>

    <style>
        /* 強制X軸標籤水平顯示 */
        .chart-container canvas {
            transform: none !important;
        }

        /* 強制圖表標籤水平顯示 */
        .chart-container {
            overflow: visible !important;
        }

        /* 確保X軸標籤不旋轉 */
        .chart-container canvas {
            transform: none !important;
        }

        /* 詳細日誌樣式 */
        .data-details-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: var(--transition);
        }

        .log-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-glass);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .log-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .log-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .log-content p {
            margin-bottom: 0.5rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .log-content strong {
            color: var(--text-primary);
        }

        .status-success {
            color: var(--success);
            font-weight: bold;
        }

        .data-table {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: bold;
        }

        .data-table td {
            color: var(--text-secondary);
        }

        .data-table tr:hover {
            background: var(--bg-glass);
        }

        .data-table .positive {
            color: var(--success);
            font-weight: bold;
        }

        .data-table .negative {
            color: var(--error);
            font-weight: bold;
        }

        /* 線條控制樣式 */
        .line-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .line-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .line-toggle:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }

        .line-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .toggle-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }

            .line-controls {
                gap: 0.5rem;
            }

            .line-toggle {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
        }

        /* 強制X軸標籤水平顯示 */
        .chart-container canvas {
            transform: none !important;
        }
    </style>
</body>

</html>