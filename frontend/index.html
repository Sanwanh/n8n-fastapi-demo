<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場分析報告系統 - 即時黃金價格</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="background-animation">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
        <div class="floating-shape shape-4"></div>
        <div class="floating-shape shape-5"></div>
    </div>

    <div class="container">
        <nav class="navigation">
            <div class="nav-brand">
                <i class="fas fa-chart-line"></i>
                <span>市場分析系統</span>
            </div>
            <div class="nav-links">
                <a href="/mail" class="nav-link mail-link">
                    <i class="fas fa-envelope"></i>
                    郵件發送
                </a>
                <a href="/api/docs" class="nav-link docs-link" target="_blank">
                    <i class="fas fa-book"></i>
                    API 文檔
                </a>
                <div class="system-time" id="system-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                </div>
            </div>
        </nav>

        <header class="page-header">
            <div class="header-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h1>市場分析報告系統</h1>
            <p>智能情感分析 • 即時黃金價格 • 自動化報告</p>
            <div class="last-updated" id="last-updated">
                <i class="fas fa-sync"></i>
                <span>最後更新: --</span>
            </div>
        </header>

        <div class="main-content">
            <div class="card data-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h2>市場情感分析</h2>
                    <div class="status-indicator" id="status-indicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">載入中...</span>
                    </div>
                </div>
                <div class="card-content">
                    <div id="market-data-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>正在載入市場數據...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card gold-price-card">
                <div class="card-header">
                    <div class="card-icon gold-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <h2>黃金期貨價格 (GC=F)</h2>
                    <div class="price-controls">
                        <select id="time-period" class="control-select">
                            <option value="1d">1天</option>
                            <option value="5d">5天</option>
                            <option value="1mo">1個月</option>
                            <option value="3mo">3個月</option>
                            <option value="6mo">6個月</option>
                            <option value="1y" selected>1年</option>
                        </select>
                        <div class="price-status" id="price-status">
                            <span class="status-dot"></span>
                            <span class="status-text">載入中...</span>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="price-display" id="price-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>正在載入黃金價格...</span>
                        </div>
                    </div>

                    <div class="technical-indicators" id="technical-indicators" style="display: none;">
                        <h3><i class="fas fa-chart-line"></i> 技術指標</h3>
                        <div class="indicators-grid">
                            <div class="indicator-item">
                                <span class="indicator-label">MA20</span>
                                <span class="indicator-value" id="ma20-value">--</span>
                            </div>
                            <div class="indicator-item">
                                <span class="indicator-label">MA50</span>
                                <span class="indicator-value" id="ma50-value">--</span>
                            </div>
                            <div class="indicator-item">
                                <span class="indicator-label">RSI</span>
                                <span class="indicator-value" id="rsi-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-area"></i> 價格走勢圖</h3>
                            <div class="chart-controls">
                                <button class="chart-control-btn active" data-type="line">
                                    <i class="fas fa-chart-line"></i> 線圖
                                </button>
                                <button class="chart-control-btn" data-type="candle">
                                    <i class="fas fa-chart-bar"></i> K線
                                </button>
                            </div>
                        </div>
                        <div class="chart-container" id="chart-container">
                            <canvas id="goldChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card actions-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h2>快速操作</h2>
                </div>
                <div class="card-content">
                    <div class="action-buttons">
                        <a href="/mail" class="action-btn primary">
                            <i class="fas fa-paper-plane"></i>
                            <span>發送郵件報告</span>
                        </a>
                        <button onclick="refreshAllData()" class="action-btn secondary" id="refresh-btn">
                            <i class="fas fa-sync"></i>
                            <span>刷新數據</span>
                        </button>
                        <a href="/api/docs" target="_blank" class="action-btn info">
                            <i class="fas fa-book"></i>
                            <span>API 文檔</span>
                        </a>
                        <button onclick="toggleTechnicalIndicators()" class="action-btn gold" id="indicator-toggle">
                            <i class="fas fa-chart-line"></i>
                            <span>顯示技術指標</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="page-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>市場分析報告系統</h3>
                    <p>AI 驅動的智能市場分析與報告生成平台</p>
                </div>
                <div class="footer-stats">
                    <div class="stat-item">
                        <span class="stat-label">系統版本</span>
                        <span class="stat-value">v2.1.0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">數據來源</span>
                        <span class="stat-value">Yahoo Finance</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">下次更新</span>
                        <span class="stat-value" id="next-update">--</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // 全域變數
        let goldChart = null;
        let goldPriceData = null;
        let chartType = 'line';
        let currentPeriod = '1y';
        let autoRefreshInterval = null;
        let indicatorsVisible = false;

        // 時間更新
        function updateSystemTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-TW');
        }

        // ==================================================================
        // ===== 修正開始 (FIX START) - 增強錯誤處理 ========================
        // ==================================================================

        // 載入黃金價格數據 - 修正錯誤處理
        async function loadGoldPrice(period = currentPeriod, showLoading = true) {
            try {
                if (showLoading) {
                    updatePriceStatus('loading', '載入中...');
                }

                console.log(`🔍 正在獲取黃金期貨數據 - 期間: ${period}`);
                const response = await fetch(`/api/gold-price?period=${period}&interval=1d`);

                // 即使 HTTP 狀態碼是 200，API 本身也可能回傳錯誤訊息
                const result = await response.json();

                if (response.ok && result.status === 'success' && result.data) {
                    goldPriceData = result.data;
                    displayGoldPrice(result.data);
                    updateTechnicalIndicators(result.data.technical_indicators || {});
                    createGoldChart(result.data);
                    updatePriceStatus('connected', '即時更新');

                    if (result.next_update) {
                        document.getElementById('next-update').textContent =
                            new Date(result.next_update).toLocaleTimeString('zh-TW');
                    }
                    const lastUpdated = new Date(result.data.last_updated);
                    document.getElementById('last-updated').querySelector('span').textContent =
                        `最後更新: ${lastUpdated.toLocaleString('zh-TW')}`;
                    console.log(`✅ 成功獲取黃金價格數據: $${result.data.current_price.toFixed(2)}`);
                } else {
                    // 將 API 回傳的錯誤訊息或 HTTP 錯誤拋出，由 catch 區塊統一處理
                    throw new Error(result.message || `HTTP 錯誤: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ 載入黃金價格失敗:', error);
                // 顯示從 try 區塊中拋出的具體錯誤訊息
                displayPriceError('無法載入黃金價格: ' + error.message);
                updatePriceStatus('error', '連接錯誤');
            }
        }

        // 載入市場數據 - 修正數據接收和錯誤處理問題
        async function loadMarketData() {
            try {
                updateMarketStatus('loading', '載入中...');
                console.log('📊 開始載入市場情感分析數據...');

                const response = await fetch('/api/current-data');
                const result = await response.json();

                if (response.ok && result.status === 'success' && result.data && typeof result.data === 'object') {
                    const hasValidData = Object.keys(result.data).length > 0;

                    if (hasValidData) {
                        console.log('✅ 成功接收市場數據:', result.data);
                        displayMarketData(result.data);
                        updateMarketStatus('connected', '已連接');
                        if (result.data.received_time) {
                            // 這裡可以選擇性更新，避免與黃金價格的更新時間衝突
                        }
                    } else {
                        console.log('⚠️ 數據為空或無效');
                        displayNoMarketData();
                        updateMarketStatus('waiting', '等待數據...');
                    }
                } else {
                    // 拋出錯誤，由 catch 區塊統一處理
                    throw new Error(result.message || `HTTP 錯誤: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ 載入市場數據失敗:', error);
                displayMarketError('無法載入市場數據: ' + error.message);
                updateMarketStatus('error', '連接錯誤');
            }
        }

        // ==================================================================
        // ===== 修正結束 (FIX END) =========================================
        // ==================================================================

        // 顯示市場數據
        function displayMarketData(data) {
            // ... 此函數保持不變 ...
        }

        // 顯示黃金價格
        function displayGoldPrice(data) {
            // ... 此函數保持不變 ...
        }

        // 更新技術指標
        function updateTechnicalIndicators(indicators) {
            // ... 此函數保持不變 ...
        }

        // 創建黃金價格圖表 - 已修正競爭條件問題
        function createGoldChart(data) {
            const canvas = document.getElementById('goldChart');
            if (!canvas) {
                console.error('❌ 找不到 Canvas 元素: goldChart');
                return;
            }
            const ctx = canvas.getContext('2d');
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            if (!data.chart_data || !Array.isArray(data.chart_data) || data.chart_data.length === 0) {
                console.warn('⚠️ 圖表數據為空或無效，不渲染圖表');
                // 清空容器，避免顯示舊圖表
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const chartData = data.chart_data;
            const labels = chartData.map(d => new Date(d.time));
            const prices = chartData.map(d => d.price);

            const config = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: '黃金價格 (USD/oz)',
                        data: prices,
                        borderColor: '#FFD700',
                        backgroundColor: chartType === 'line' ? 'rgba(255, 215, 0, 0.1)' : prices.map((price, i) => chartData[i].open <= price ? '#10b981' : '#ef4444'),
                        borderWidth: 2,
                        fill: chartType === 'line',
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { /* ... options ... */ },
                    scales: { /* ... options ... */ }
                }
            };
            goldChart = new Chart(ctx, config);
        }

        // ... 其餘所有輔助函數和事件監聽器保持不變 ...

    </script>
</body>
</html>