<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸‚å ´åˆ†æå ±å‘Šç³»çµ± - å³æ™‚é»ƒé‡‘åƒ¹æ ¼</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chartjs-adapter-moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <script>
        // ç¢ºä¿è¨»è§£æ’ä»¶æ­£ç¢ºè¼‰å…¥
        if (typeof Chart !== 'undefined') {
            console.log('âœ… Chart.js å·²è¼‰å…¥');
            console.log('Chart.js ç‰ˆæœ¬:', Chart.version);
        }
        // æª¢æŸ¥è¨»è§£æ’ä»¶æ˜¯å¦æ­£ç¢ºè¼‰å…¥
        if (typeof Chart !== 'undefined' && Chart.registry && Chart.registry.getController) {
            console.log('âœ… Chart.js è¨»è§£æ’ä»¶å·²è¼‰å…¥');
        } else {
            console.warn('âš ï¸ Chart.js è¨»è§£æ’ä»¶æœªè¼‰å…¥');
        }
    </script>
    <script>
        // ç¢ºä¿ Chart.js æ™‚é–“é©é…å™¨æ­£ç¢ºè¼‰å…¥
        if (typeof Chart !== 'undefined') {
            Chart.defaults.locale = 'zh-TW';
        }
    </script>
</head>

<body>
    <div class="background-animation">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
        <div class="floating-shape shape-4"></div>
        <div class="floating-shape shape-5"></div>
    </div>

    <div class="container">
        <nav class="navigation">
            <div class="nav-brand">
                <i class="fas fa-chart-line"></i>
                <span>å¸‚å ´åˆ†æç³»çµ±</span>
            </div>
            <div class="nav-links">
                <a href="/mail" class="nav-link mail-link">
                    <i class="fas fa-envelope"></i>
                    éƒµä»¶ç™¼é€
                </a>
                <a href="/api/docs" class="nav-link docs-link" target="_blank">
                    <i class="fas fa-book"></i>
                    API æ–‡æª”
                </a>
                <div class="system-time" id="system-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                </div>
            </div>
        </nav>

        <header class="page-header">
            <div class="header-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h1>å¸‚å ´åˆ†æå ±å‘Šç³»çµ±</h1>
            <p>æ™ºèƒ½æƒ…æ„Ÿåˆ†æ â€¢ å³æ™‚é»ƒé‡‘åƒ¹æ ¼ â€¢ è‡ªå‹•åŒ–å ±å‘Š</p>
        </header>

        <div class="main-content">
            <div class="card data-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h2>å¸‚å ´æƒ…æ„Ÿåˆ†æ</h2>
                    <div class="status-indicator" id="status-indicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                <div class="card-content">
                    <div id="market-data-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>æ­£åœ¨è¼‰å…¥å¸‚å ´æ•¸æ“š...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card gold-price-card">
                <div class="card-header">
                    <div class="card-icon gold-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <h2>é»ƒé‡‘æœŸè²¨åƒ¹æ ¼ (GC=F)</h2>
                    <div class="price-controls">
                        <div class="price-status" id="price-status">
                            <span class="status-dot"></span>
                            <span class="status-text">è¼‰å…¥ä¸­...</span>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="price-display" id="price-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>æ­£åœ¨è¼‰å…¥é»ƒé‡‘åƒ¹æ ¼...</span>
                        </div>
                    </div>

                    <div id="gold-last-updated" class="last-updated"
                        style="text-align: right; margin-top: 1rem; font-size: 0.9em; color: var(--text-muted);">
                        <i class="fas fa-sync"></i>
                        <span>--</span>
                    </div>

                    <div class="technical-indicators" id="technical-indicators" style="display: none;">
                        <h3><i class="fas fa-chart-line"></i> æŠ€è¡“æŒ‡æ¨™</h3>
                        <div class="indicators-grid">
                            <div class="indicator-item">
                                <span class="indicator-label">MA5</span>
                                <span class="indicator-value" id="ma5-value">--</span>
                            </div>
                            <div class="indicator-item">
                                <span class="indicator-label">MA20</span>
                                <span class="indicator-value" id="ma20-value">--</span>
                            </div>
                            <div class="indicator-item">
                                <span class="indicator-label">MA50</span>
                                <span class="indicator-value" id="ma50-value">--</span>
                            </div>
                            <div class="indicator-item">
                                <span class="indicator-label">RSI</span>
                                <span class="indicator-value" id="rsi-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="cross-signal-display" id="cross-signal-display" style="display: none;">
                        <h3><i class="fas fa-signal"></i> äº¤å‰ä¿¡è™Ÿ</h3>
                        <div class="signal-content">
                            <div class="signal-item" id="signal-status">
                                <span class="signal-label">ä¿¡è™Ÿç‹€æ…‹</span>
                                <span class="signal-value" id="signal-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-area"></i> åƒ¹æ ¼èµ°å‹¢åœ–</h3>
                            <div class="chart-controls">
                                <div class="line-controls">
                                    <label class="line-toggle">
                                        <input type="checkbox" id="show-ma5" checked>
                                        <span class="toggle-label">MA5</span>
                                    </label>
                                    <label class="line-toggle">
                                        <input type="checkbox" id="show-ma20" checked>
                                        <span class="toggle-label">MA20</span>
                                    </label>
                                    <label class="line-toggle">
                                        <input type="checkbox" id="show-ma125" checked>
                                        <span class="toggle-label">MA125</span>
                                    </label>
                                    <label class="line-toggle">
                                        <input type="checkbox" id="show-quarterly" checked>
                                        <span class="toggle-label">å­£å¹³å‡</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container" id="chart-container">
                            <canvas id="goldChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card actions-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h2>å¿«é€Ÿæ“ä½œ</h2>
                </div>
                <div class="card-content">
                    <div class="action-buttons">
                        <a href="/mail" class="action-btn primary">
                            <i class="fas fa-paper-plane"></i>
                            <span>ç™¼é€éƒµä»¶å ±å‘Š</span>
                        </a>
                        <button onclick="refreshAllData()" class="action-btn secondary" id="refresh-btn">
                            <i class="fas fa-sync"></i>
                            <span>åˆ·æ–°æ•¸æ“š</span>
                        </button>
                        <a href="/api/docs" target="_blank" class="action-btn info">
                            <i class="fas fa-book"></i>
                            <span>API æ–‡æª”</span>
                        </a>
                        <button onclick="toggleTechnicalIndicators()" class="action-btn gold" id="indicator-toggle">
                            <i class="fas fa-chart-line"></i>
                            <span>é¡¯ç¤ºæŠ€è¡“æŒ‡æ¨™</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card data-details-card" style="margin-top: 2rem;">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-database"></i>
                </div>
                <h2>è©³ç´°æ•¸æ“šæ—¥èªŒ</h2>
                <button onclick="toggleDataDetails()" class="action-btn secondary" id="details-toggle">
                    <i class="fas fa-eye"></i>
                    <span>é¡¯ç¤ºè©³æƒ…</span>
                </button>
            </div>
            <div class="card-content" id="data-details" style="display: none;">
                <div id="detailed-logs">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>æ­£åœ¨è¼‰å…¥è©³ç´°æ•¸æ“š...</span>
                    </div>
                </div>
            </div>
        </div>

        <footer class="page-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>å¸‚å ´åˆ†æå ±å‘Šç³»çµ±</h3>
                    <p>AI é©…å‹•çš„æ™ºèƒ½å¸‚å ´åˆ†æèˆ‡å ±å‘Šç”Ÿæˆå¹³å°</p>
                </div>
                <div class="footer-stats">
                    <div class="stat-item">
                        <span class="stat-label">ç³»çµ±ç‰ˆæœ¬</span>
                        <span class="stat-value">v2.1.0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">æ•¸æ“šä¾†æº</span>
                        <span class="stat-value">Yahoo Finance</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ä¸‹æ¬¡æ›´æ–°</span>
                        <span class="stat-value" id="next-update">--</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ===== å…¨åŸŸè®Šæ•¸ =====
        let goldChart = null;
        let goldPriceData = null;
        let marketData = null;
        let currentPeriod = '1y'; // å›ºå®šç‚ºä¸€å¹´
        let autoRefreshInterval = null;
        let indicatorsVisible = false;
        let detailsVisible = false;
        let showMA5 = true;
        let showMA20 = true;
        let showMA125 = true;
        let showQuarterly = true;

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš€ å¸‚å ´åˆ†æç³»çµ±è¼‰å…¥ä¸­...');

            // æª¢æŸ¥Chart.jsæ˜¯å¦è¼‰å…¥
            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
            } else {
                console.log('âœ… Chart.js å·²è¼‰å…¥');
                console.log('Chart.js ç‰ˆæœ¬:', Chart.version);
            }

            // é–‹å§‹è¼‰å…¥æ•¸æ“š
            initializeSystem();

            // è¨­å®šäº‹ä»¶ç›£è½
            setupEventListeners();

            // å•Ÿå‹•æ™‚é–“æ›´æ–°
            updateSystemTime();
            setInterval(updateSystemTime, 1000);

            // è¨­å®šè‡ªå‹•åˆ·æ–°ï¼ˆæ¯5åˆ†é˜ï¼‰
            autoRefreshInterval = setInterval(refreshAllData, 60000);

            // ç›£è½è¦–çª—å¤§å°æ”¹è®Š
            window.addEventListener('resize', () => {
                if (goldChart && goldPriceData) {
                    setTimeout(() => {
                        createGoldChart(goldPriceData);
                    }, 100);
                }
            });

            console.log('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        });

        // ===== ç³»çµ±åˆå§‹åŒ– =====
        async function initializeSystem() {
            console.log('ğŸ“Š é–‹å§‹è¼‰å…¥æ‰€æœ‰æ•¸æ“š...');

            // ä¸¦è¡Œè¼‰å…¥æ•¸æ“š
            await Promise.all([
                loadMarketData(),
                loadGoldPrice(currentPeriod, true)
            ]);

            console.log('âœ… æ‰€æœ‰æ•¸æ“šè¼‰å…¥å®Œæˆ');
        }

        // ===== äº‹ä»¶ç›£è½è¨­å®š =====
        function setupEventListeners() {
            // ç·šæ¢é¡¯ç¤ºæ§åˆ¶
            const lineToggles = document.querySelectorAll('.line-toggle input');
            lineToggles.forEach(toggle => {
                toggle.addEventListener('change', function () {
                    const lineType = this.id.replace('show-', '');
                    console.log(`ğŸ“ˆ åˆ‡æ›ç·šæ¢é¡¯ç¤º: ${lineType} = ${this.checked}`);

                    if (lineType === 'ma5') showMA5 = this.checked;
                    if (lineType === 'ma20') showMA20 = this.checked;
                    if (lineType === 'ma125') showMA125 = this.checked;
                    if (lineType === 'quarterly') showQuarterly = this.checked;

                    if (goldPriceData) {
                        createGoldChart(goldPriceData);
                    }
                });
            });

            console.log('ğŸ¯ äº‹ä»¶ç›£è½å™¨è¨­å®šå®Œæˆ');
        }

        // ===== æ™‚é–“æ›´æ–° =====
        function updateSystemTime() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('zh-TW');
            }
        }

        // ===== è¼‰å…¥å¸‚å ´æ•¸æ“š =====
        async function loadMarketData() {
            try {
                console.log('ğŸ“ˆ é–‹å§‹è¼‰å…¥å¸‚å ´æƒ…æ„Ÿåˆ†ææ•¸æ“š...');
                updateMarketStatus('loading', 'è¼‰å…¥ä¸­...');

                const response = await fetch('/api/current-data');
                const result = await response.json();

                console.log('ğŸ“¥ å¸‚å ´æ•¸æ“šAPIå›æ‡‰:', result);

                if (response.ok && result.status === 'success') {
                    if (result.data && typeof result.data === 'object' && Object.keys(result.data).length > 0) {
                        marketData = result.data;
                        console.log('âœ… æˆåŠŸæ¥æ”¶å¸‚å ´æ•¸æ“š:', marketData);
                        displayMarketData(marketData);
                        updateMarketStatus('connected', 'å·²é€£æ¥');


                    } else {
                        console.log('âš ï¸ å¸‚å ´æ•¸æ“šç‚ºç©º');
                        displayNoMarketData();
                        updateMarketStatus('waiting', 'ç­‰å¾…æ•¸æ“š...');
                    }
                } else {
                    throw new Error(result.message || `HTTP éŒ¯èª¤: ${response.status}`);
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥å¸‚å ´æ•¸æ“šå¤±æ•—:', error);
                displayMarketError('ç„¡æ³•è¼‰å…¥å¸‚å ´æ•¸æ“š: ' + error.message);
                updateMarketStatus('error', 'é€£æ¥éŒ¯èª¤');
            }
        }

        // ===== è¼‰å…¥é»ƒé‡‘åƒ¹æ ¼æ•¸æ“š =====
        async function loadGoldPrice(period = currentPeriod, showLoading = true) {
            try {
                if (showLoading) {
                    updatePriceStatus('loading', 'è¼‰å…¥ä¸­...');
                    showPriceLoading();
                }

                console.log(`ğŸ” æ­£åœ¨ç²å–é»ƒé‡‘æœŸè²¨æ•¸æ“š - æœŸé–“: ${period}`);
                const response = await fetch(`/api/gold-price?period=${period}&interval=1d`);
                const result = await response.json();

                console.log('ğŸ’° é»ƒé‡‘åƒ¹æ ¼APIå›æ‡‰:', result);

                if (response.ok && result.status === 'success' && result.data) {
                    goldPriceData = result.data;
                    console.log('âœ… æˆåŠŸç²å–é»ƒé‡‘åƒ¹æ ¼æ•¸æ“š:');
                    console.log(`   åƒ¹æ ¼: $${result.data.current_price}`);
                    console.log(`   è®ŠåŒ–: ${result.data.change} (${result.data.change_percent}%)`);
                    console.log(`   æ•¸æ“šé»æ•¸é‡: ${result.data.chart_data?.length || 0}`);

                    displayGoldPrice(result.data);
                    updateTechnicalIndicators(result.data.technical_indicators || {});
                    updateCrossSignalDisplay(result.data.cross_signal);

                    // æª¢æŸ¥åœ–è¡¨æ•¸æ“š
                    console.log('ğŸ“Š æº–å‚™å‰µå»ºåœ–è¡¨ï¼Œæ•¸æ“šæª¢æŸ¥:');
                    console.log('chart_data å­˜åœ¨:', !!result.data.chart_data);
                    console.log('chart_data é¡å‹:', typeof result.data.chart_data);
                    console.log('chart_data é•·åº¦:', result.data.chart_data?.length);
                    if (result.data.chart_data && result.data.chart_data.length > 0) {
                        console.log('ç¬¬ä¸€å€‹æ•¸æ“šé»:', result.data.chart_data[0]);
                    }

                    // æª¢æŸ¥MAç·šæ•¸æ“š
                    console.log('MA5 æ•¸æ“šå­˜åœ¨:', !!result.data.ma_lines?.ma_5);
                    console.log('MA20 æ•¸æ“šå­˜åœ¨:', !!result.data.ma_lines?.ma_20);
                    console.log('æœˆå¹³å‡ç·šæ•¸æ“šå­˜åœ¨:', !!result.data.monthly_average_line);
                    console.log('å¹´å¹³å‡åƒ¹æ ¼ç·šæ•¸æ“šå­˜åœ¨:', !!result.data.yearly_average_line);
                    if (result.data.ma_lines?.ma_5) {
                        console.log('MA5 æ•¸æ“šé»æ•¸:', result.data.ma_lines.ma_5.length);
                    }
                    if (result.data.ma_lines?.ma_20) {
                        console.log('MA20 æ•¸æ“šé»æ•¸:', result.data.ma_lines.ma_20.length);
                    }
                    if (result.data.monthly_average_line) {
                        console.log('æœˆå¹³å‡ç·šæ•¸æ“šé»æ•¸:', result.data.monthly_average_line.length);
                    }
                    if (result.data.yearly_average_line) {
                        console.log('å¹´å¹³å‡åƒ¹æ ¼ç·šæ•¸æ“šé»æ•¸:', result.data.yearly_average_line.length);
                    }

                    // å»¶é²å‰µå»ºåœ–è¡¨ï¼Œç¢ºä¿DOMå®Œå…¨è¼‰å…¥
                    setTimeout(() => {
                        createGoldChart(result.data);
                    }, 500);

                    updatePriceStatus('connected', 'å³æ™‚æ›´æ–°');

                    if (result.next_update) {
                        document.getElementById('next-update').textContent =
                            new Date(result.next_update).toLocaleTimeString('zh-TW');
                    }

                    if (result.data.last_updated_formatted) {
                        updateGoldLastUpdated(`æœ€å¾Œæ›´æ–°: ${result.data.last_updated_formatted}`);
                    } else if (result.data.last_updated) {
                        const lastUpdated = new Date(result.data.last_updated);
                        updateGoldLastUpdated(`æœ€å¾Œæ›´æ–°: ${lastUpdated.toLocaleString('zh-TW')}`);
                    }

                    // æ›´æ–°è©³ç´°æ—¥èªŒ
                    updateDetailedLogs(result);

                } else {
                    throw new Error(result.message || `HTTP éŒ¯èª¤: ${response.status}`);
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥é»ƒé‡‘åƒ¹æ ¼å¤±æ•—:', error);
                displayPriceError('ç„¡æ³•è¼‰å…¥é»ƒé‡‘åƒ¹æ ¼: ' + error.message);
                updatePriceStatus('error', 'é€£æ¥éŒ¯èª¤');
            }
        }

        // ===== é¡¯ç¤ºå¸‚å ´æ•¸æ“š =====
        function displayMarketData(data) {
            console.log('ğŸ¨ é¡¯ç¤ºå¸‚å ´æ•¸æ“š:', data);

            const sentimentClass = getSentimentClass(data.average_sentiment_score);
            const sentimentText = getSentimentText(data.average_sentiment_score);

            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="market-data">
                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-heart-pulse"></i>
                            æƒ…æ„Ÿåˆ†æ•¸
                        </div>
                        <div class="data-value">
                            <span class="sentiment-score sentiment-${sentimentClass}">
                                ${sentimentText} (${data.average_sentiment_score?.toFixed(3) || 'N/A'})
                            </span>
                        </div>
                    </div>

                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-calendar-day"></i>
                            å¸‚å ´æ—¥æœŸ
                        </div>
                        <div class="data-value">${data.market_date || 'æœªçŸ¥'}</div>
                    </div>



                    <div class="data-row full-width">
                        <div class="data-label">
                            <i class="fas fa-newspaper"></i>
                            åˆ†æå…§å®¹
                        </div>
                        <div class="market-content" id="market-content">
                            ${data.raw_data.message.content || ''}
                        </div>
                        ${data.raw_data.message.content && data.raw_data.message.content.length > 200
                    ? '<button class="expand-btn" onclick="toggleMarketContent()">å±•é–‹å…¨æ–‡</button>'
                    : ''}
                    </div>











                    <div class="data-row">
                        <div class="data-label">
                            <i class="fas fa-clock"></i>
                            æ¥æ”¶æ™‚é–“
                        </div>
                        <div class="data-value">${data.received_time || 'æœªçŸ¥'}</div>
                    </div>
                </div>
            `;
        }

        // ===== é¡¯ç¤ºé»ƒé‡‘åƒ¹æ ¼ =====
        function displayGoldPrice(data) {
            console.log('ğŸ’° é¡¯ç¤ºé»ƒé‡‘åƒ¹æ ¼æ•¸æ“š:', data);

            const priceChangeClass = data.change >= 0 ? 'positive' : 'negative';
            const priceChangeIcon = data.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="gold-price-info">
                    <div class="price-main">
                        <div class="current-price">
                            <span class="price-value">$${data.current_price?.toFixed(2) || 'N/A'}</span>
                            <span class="price-unit">${data.unit || 'USD/oz'} (USD)</span>
                        </div>
                        <div class="price-change ${priceChangeClass}">
                            <i class="fas ${priceChangeIcon}"></i>
                            <span>${data.change >= 0 ? '+' : ''}${data.change?.toFixed(2) || 'N/A'}</span>
                            <span>(${data.change_percent >= 0 ? '+' : ''}${data.change_percent?.toFixed(2) || 'N/A'}%)</span>
                        </div>
                    </div>

                    <div class="price-statistics">
                        <div class="stat-grid">
                            <div class="stat-item">
                                <span class="stat-label">24H é«˜</span>
                                <span class="stat-value">$${data.high_24h?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">24H ä½</span>
                                <span class="stat-value">$${data.low_24h?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">å¹³å‡åƒ¹æ ¼</span>
                                <span class="stat-value">$${data.avg_price?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æ³¢å‹•ç‡</span>
                                <span class="stat-value">${data.volatility?.toFixed(2) || 'N/A'}</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">å¸‚å ´ç‹€æ…‹</span>
                                <span class="stat-value market-${data.market_status}">${getMarketStatusText(data.market_status)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== å‰µå»ºé»ƒé‡‘åƒ¹æ ¼åœ–è¡¨ =====
        function createGoldChart(data) {
            console.log('ğŸ¨ é–‹å§‹å‰µå»ºé»ƒé‡‘åƒ¹æ ¼åœ–è¡¨...');
            console.log('æ¥æ”¶åˆ°çš„æ•¸æ“š:', data);

            const canvas = document.getElementById('goldChart');
            const container = document.getElementById('chart-container');

            if (!canvas) {
                console.error('âŒ æ‰¾ä¸åˆ° Canvas å…ƒç´ : goldChart');
                return;
            }

            if (!container) {
                console.error('âŒ æ‰¾ä¸åˆ°åœ–è¡¨å®¹å™¨: chart-container');
                return;
            }

            // æª¢æŸ¥å®¹å™¨æ˜¯å¦å¯è¦‹
            const containerStyle = window.getComputedStyle(container);
            console.log('å®¹å™¨é¡¯ç¤ºç‹€æ…‹:', containerStyle.display);
            console.log('å®¹å™¨å¯è¦‹æ€§:', containerStyle.visibility);

            // ç¢ºä¿å®¹å™¨å¯è¦‹
            if (containerStyle.display === 'none') {
                container.style.display = 'block';
            }

            // é‡è¦ï¼šæ­£ç¢ºéŠ·æ¯€ç¾æœ‰åœ–è¡¨
            if (goldChart) {
                console.log('ğŸ—‘ï¸ éŠ·æ¯€ç¾æœ‰åœ–è¡¨');
                goldChart.destroy();
                goldChart = null;
            }

            // é‡æ–°è¨­ç½® Canvas å°ºå¯¸
            canvas.width = container.offsetWidth || 800;
            canvas.height = container.offsetHeight || 400;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            console.log('Canvas å°ºå¯¸:', canvas.width, 'x', canvas.height);
            console.log('å®¹å™¨å°ºå¯¸:', container.offsetWidth, 'x', container.offsetHeight);

            if (!data.chart_data || !Array.isArray(data.chart_data) || data.chart_data.length === 0) {
                console.warn('âš ï¸ åœ–è¡¨æ•¸æ“šç‚ºç©ºæˆ–ç„¡æ•ˆï¼Œä¸æ¸²æŸ“åœ–è¡¨');
                console.log('æ•¸æ“šè©³æƒ…:', data.chart_data);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            console.log(`ğŸ“Š å‰µå»ºåœ–è¡¨ï¼Œæ•¸æ“šé»: ${data.chart_data.length}`);
            console.log('åŸå§‹æ•¸æ“šæ¨£æœ¬:', data.chart_data.slice(0, 3));

            const chartData = data.chart_data;

            // ç°¡åŒ–æ•¸æ“šè™•ç†ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ—¥æœŸ
            const labels = chartData.map(d => d.time);
            const prices = chartData.map(d => parseFloat(d.price) || 0);

            console.log('è™•ç†å¾Œçš„æ¨™ç±¤:', labels.slice(0, 5));
            console.log('è™•ç†å¾Œçš„åƒ¹æ ¼:', prices.slice(0, 5));
            console.log('æ¨™ç±¤ç¸½æ•¸:', labels.length);
            console.log('åƒ¹æ ¼ç¸½æ•¸:', prices.length);
            console.log('æœ‰æ•ˆåƒ¹æ ¼æ•¸é‡:', prices.filter(p => p > 0).length);

            // æº–å‚™æ•¸æ“šé›† - ä½¿ç”¨ç°¡å–®çš„æ•¸çµ„æ ¼å¼
            const validPrices = prices.filter(p => p > 0);
            const validLabels = labels.slice(0, validPrices.length);

            console.log('æœ‰æ•ˆåƒ¹æ ¼æ•¸é‡:', validPrices.length);
            console.log('æœ‰æ•ˆæ¨™ç±¤æ•¸é‡:', validLabels.length);
            console.log('æœ‰æ•ˆæ¨™ç±¤æ¨£æœ¬:', validLabels.slice(0, 5));
            console.log('ä¸»æ•¸æ“šæ™‚é–“æ ¼å¼æ¨£æœ¬:', validLabels.slice(0, 3).map(label => {
                const date = new Date(label);
                return {
                    original: label,
                    date: date.toISOString().split('T')[0]
                };
            }));

            const datasets = [{
                label: 'é»ƒé‡‘åƒ¹æ ¼ (USD/oz)',
                data: validPrices,
                borderColor: '#FFD700',
                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                spanGaps: true
            }];

            console.log('ä¸»æ•¸æ“šæ ¼å¼æª¢æŸ¥:', {
                validPricesLength: validPrices.length,
                validPricesSample: validPrices.slice(0, 3),
                validLabelsLength: validLabels.length,
                validLabelsSample: validLabels.slice(0, 3)
            });

            // æ·»åŠ MA5ç·š
            if (showMA5 && data.ma_lines && data.ma_lines.ma_5) {
                console.log('ğŸ” è™•ç†MA5æ•¸æ“š...');
                // å‰µå»ºMA5æ•¸æ“šæ˜ å°„
                const ma5Map = {};
                data.ma_lines.ma_5.forEach(d => {
                    ma5Map[d.time] = parseFloat(d.price) || 0;
                });

                console.log('MA5æ˜ å°„æ¨£æœ¬:', Object.keys(ma5Map).slice(0, 5));

                // å°é½Šåˆ°ä¸»æ•¸æ“šçš„æ™‚é–“è»¸
                const ma5Prices = validLabels.map(label => ma5Map[label] || null);
                const validMa5Prices = ma5Prices.filter(p => p !== null && p > 0);

                // ç¢ºä¿æ•¸æ“šé•·åº¦èˆ‡ä¸»æ•¸æ“šä¸€è‡´
                const alignedMa5Prices = validLabels.map(label => ma5Map[label] || null);

                console.log('MA5å°é½Šæ•¸æ“šé»æ•¸:', alignedMa5Prices.filter(p => p !== null).length);

                if (alignedMa5Prices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'MA5',
                        data: alignedMa5Prices,
                        borderColor: '#FF6B6B',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        spanGaps: true
                    });
                }
            }

            // æ·»åŠ MA20ç·š
            if (showMA20 && data.ma_lines && data.ma_lines.ma_20) {
                console.log('ğŸ” è™•ç†MA20æ•¸æ“š...');
                // å‰µå»ºMA20æ•¸æ“šæ˜ å°„
                const ma20Map = {};
                data.ma_lines.ma_20.forEach(d => {
                    ma20Map[d.time] = parseFloat(d.price) || 0;
                });

                console.log('MA20æ˜ å°„æ¨£æœ¬:', Object.keys(ma20Map).slice(0, 5));

                // å°é½Šåˆ°ä¸»æ•¸æ“šçš„æ™‚é–“è»¸
                const ma20Prices = validLabels.map(label => ma20Map[label] || null);
                const validMa20Prices = ma20Prices.filter(p => p !== null && p > 0);

                // ç¢ºä¿æ•¸æ“šé•·åº¦èˆ‡ä¸»æ•¸æ“šä¸€è‡´
                const alignedMa20Prices = validLabels.map(label => ma20Map[label] || null);

                console.log('MA20å°é½Šæ•¸æ“šé»æ•¸:', alignedMa20Prices.filter(p => p !== null).length);

                if (alignedMa20Prices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'MA20',
                        data: alignedMa20Prices,
                        borderColor: '#4ECDC4',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        spanGaps: true
                    });
                }
            }

            // æ·»åŠ MA125ç·š
            if (showMA125 && data.ma_125_line && data.ma_125_line.length > 0) {
                console.log('ğŸ” è™•ç†MA125æ•¸æ“š...');
                console.log('MA125åŸå§‹æ•¸æ“š:', data.ma_125_line);

                // å‰µå»ºMA125æ•¸æ“šæ˜ å°„
                const ma125Map = {};
                data.ma_125_line.forEach(d => {
                    ma125Map[d.time] = parseFloat(d.price) || 0;
                });

                console.log('MA125æ˜ å°„æ¨£æœ¬:', Object.keys(ma125Map).slice(0, 5));
                console.log('MA125æ˜ å°„å€¼æ¨£æœ¬:', Object.values(ma125Map).slice(0, 5));

                // å°é½Šåˆ°ä¸»æ•¸æ“šçš„æ™‚é–“è»¸
                const alignedMA125Prices = validLabels.map(label => {
                    return ma125Map[label] || null;
                });

                console.log('MA125å°é½Šæ•¸æ“šé»æ•¸:', alignedMA125Prices.filter(p => p !== null).length);
                console.log('MA125å°é½Šæ•¸æ“šæ¨£æœ¬:', alignedMA125Prices.slice(0, 10));

                if (alignedMA125Prices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'MA125',
                        data: alignedMA125Prices,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderDash: [6, 3],
                        spanGaps: true
                    });
                } else {
                    console.log('âš ï¸ MA125æ²’æœ‰æœ‰æ•ˆæ•¸æ“šé»');
                }
            } else {
                console.log('âš ï¸ MA125æ•¸æ“šä¸å­˜åœ¨æˆ–ç‚ºç©º');
                console.log('showMA125:', showMA125);
                console.log('data.ma_125_line å­˜åœ¨:', !!data.ma_125_line);
                console.log('data.ma_125_line é•·åº¦:', data.ma_125_line?.length);
            }

            // æ·»åŠ å­£å¹³å‡å‡ç·š
            if (showQuarterly && data.quarterly_average_line && data.quarterly_average_line.length > 0) {
                console.log('ğŸ” è™•ç†å­£å¹³å‡å‡ç·šæ•¸æ“š...');
                console.log('å­£å¹³å‡å‡ç·šåŸå§‹æ•¸æ“š:', data.quarterly_average_line);

                // å‰µå»ºå­£å¹³å‡å‡ç·šæ•¸æ“šæ˜ å°„
                const quarterlyMap = {};
                data.quarterly_average_line.forEach(d => {
                    quarterlyMap[d.time] = parseFloat(d.price) || 0;
                });

                console.log('å­£å¹³å‡å‡ç·šæ˜ å°„æ¨£æœ¬:', Object.keys(quarterlyMap).slice(0, 5));
                console.log('å­£å¹³å‡å‡ç·šæ˜ å°„å€¼æ¨£æœ¬:', Object.values(quarterlyMap).slice(0, 5));

                // å°é½Šåˆ°ä¸»æ•¸æ“šçš„æ™‚é–“è»¸
                const alignedQuarterlyPrices = validLabels.map(label => {
                    return quarterlyMap[label] || null;
                });

                console.log('å­£å¹³å‡å‡ç·šå°é½Šæ•¸æ“šé»æ•¸:', alignedQuarterlyPrices.filter(p => p !== null).length);
                console.log('å­£å¹³å‡å‡ç·šå°é½Šæ•¸æ“šæ¨£æœ¬:', alignedQuarterlyPrices.slice(0, 10));

                if (alignedQuarterlyPrices.filter(p => p !== null).length > 0) {
                    datasets.push({
                        label: 'å­£å¹³å‡å‡ç·š',
                        data: alignedQuarterlyPrices,
                        borderColor: '#FF8C00',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderDash: [6, 3],
                        spanGaps: true
                    });
                } else {
                    console.log('âš ï¸ å­£å¹³å‡å‡ç·šæ²’æœ‰æœ‰æ•ˆæ•¸æ“šé»');
                }
            } else {
                console.log('âš ï¸ å­£å¹³å‡å‡ç·šæ•¸æ“šä¸å­˜åœ¨æˆ–ç‚ºç©º');
                console.log('showQuarterly:', showQuarterly);
                console.log('data.quarterly_average_line å­˜åœ¨:', !!data.quarterly_average_line);
                console.log('data.quarterly_average_line é•·åº¦:', data.quarterly_average_line?.length);
            }

            // æª¢æŸ¥äº¤å‰ä¿¡è™Ÿ
            let crossSignalText = '';
            if (data.cross_signal) {
                crossSignalText = data.cross_signal.message;
                console.log('ğŸ“Š äº¤å‰ä¿¡è™Ÿ:', data.cross_signal);
                console.log('ğŸ“Š ä¿¡è™Ÿç‹€æ…‹:', data.cross_signal.status);
                console.log('ğŸ“Š ä¿¡è™Ÿæ¶ˆæ¯:', crossSignalText);
            }

            const config = {
                type: 'line',
                data: {
                    labels: validLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 20,   // æ•´å¼µåœ–åº•éƒ¨å¤šç•™ 20px
                            top: crossSignalText ? 40 : 20  // å¦‚æœæœ‰äº¤å‰ä¿¡è™Ÿï¼Œé ‚éƒ¨å¤šç•™ç©ºé–“
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `é»ƒé‡‘æœŸè²¨åƒ¹æ ¼èµ°å‹¢ (ä¸€å¹´)`,
                            color: '#f8fafc',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            labels: { color: '#cbd5e1' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                title: function (context) {
                                    const dataIndex = context[0].dataIndex;
                                    if (dataIndex < labels.length) {
                                        return labels[dataIndex];
                                    }
                                    return 'æœªçŸ¥æ—¥æœŸ';
                                },
                                label: function (context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        },
                        annotation: crossSignalText ? {
                            annotations: {
                                crossSignal: {
                                    type: 'label',
                                    xValue: 0.95,
                                    yValue: 0.95,
                                    backgroundColor: data.cross_signal.status === 'golden_cross' ? 'rgba(16, 185, 129, 0.9)' :
                                        data.cross_signal.status === 'death_cross' ? 'rgba(239, 68, 68, 0.9)' :
                                            'rgba(100, 116, 139, 0.9)',
                                    content: [crossSignalText],
                                    color: '#ffffff',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    padding: 8,
                                    borderRadius: 4,
                                    position: 'end'
                                }
                            }
                        } : {}
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#64748b',
                                rotation: 0,  // æ—‹è½‰è§’åº¦
                                minRotation: 0,  // æœ€å°æ—‹è½‰è§’åº¦
                                maxRotation: 0,  // æœ€å¤§æ—‹è½‰è§’åº¦
                                autoSkip: true,
                                font: {
                                    size: 12,
                                    weight: 'normal'
                                },
                                callback: function (value, index, ticks) {
                                    if (index < validLabels.length) {
                                        const date = new Date(validLabels[index]);
                                        if (!isNaN(date.getTime())) {
                                            const year = date.getFullYear();
                                            const month = date.getMonth() + 1;
                                            return `${year}å¹´${month}æœˆ`;
                                        }
                                    }
                                    return '';
                                }
                            },
                            grid: {
                                color: 'rgba(100, 116, 139, 0.1)'
                            },
                            afterFit: function (scale) {
                                scale.paddingTop = 10;
                                scale.paddingBottom = 10;
                            }
                        },
                        y: {
                            ticks: {
                                color: '#64748b',
                                callback: function (value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(100, 116, 139, 0.1)' }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 60
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            };

            try {
                const ctx = canvas.getContext('2d');
                console.log('ğŸ¨ é–‹å§‹æ¸²æŸ“åœ–è¡¨...');
                console.log('Canvas å°ºå¯¸:', canvas.width, 'x', canvas.height);
                console.log('æ•¸æ“šé›†æ•¸é‡:', datasets.length);
                console.log('æœ‰æ•ˆåƒ¹æ ¼æ•¸æ“šé»æ•¸:', validPrices.length);

                // ç¢ºä¿ Chart.js å·²è¼‰å…¥
                if (typeof Chart === 'undefined') {
                    console.error('âŒ Chart.js æœªè¼‰å…¥');
                    return;
                }

                // æª¢æŸ¥æ•¸æ“šæ˜¯å¦æœ‰æ•ˆ
                if (validPrices.length === 0) {
                    console.error('âŒ æœ‰æ•ˆåƒ¹æ ¼æ•¸æ“šç‚ºç©ºï¼Œç„¡æ³•å‰µå»ºåœ–è¡¨');
                    return;
                }

                console.log('é…ç½®å°è±¡:', config);
                goldChart = new Chart(ctx, config);
                console.log('âœ… åœ–è¡¨å‰µå»ºæˆåŠŸ');
                console.log('åœ–è¡¨å¯¦ä¾‹:', goldChart);

                // å¼·åˆ¶Xè»¸æ¨™ç±¤æ°´å¹³é¡¯ç¤º
                setTimeout(() => {
                    if (goldChart && goldChart.options && goldChart.options.scales && goldChart.options.scales.x) {
                        goldChart.options.scales.x.ticks.rotation = 0;
                        goldChart.options.scales.x.ticks.maxTicksLimit = 6;
                        goldChart.update('none');

                        // å†æ¬¡å¼·åˆ¶æ›´æ–°
                        setTimeout(() => {
                            goldChart.update('none');
                        }, 200);
                    }
                }, 100);

            } catch (error) {
                console.error('âŒ å‰µå»ºåœ–è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', error.message);
                console.error('éŒ¯èª¤å †ç–Š:', error.stack);
            }
        }

        // ===== æ›´æ–°æŠ€è¡“æŒ‡æ¨™ =====
        function updateTechnicalIndicators(indicators) {
            console.log('ğŸ“Š æ›´æ–°æŠ€è¡“æŒ‡æ¨™:', indicators);

            if (indicators.ma_5) {
                document.getElementById('ma5-value').textContent = '$' + indicators.ma_5.toFixed(2);
            }
            if (indicators.ma_20) {
                document.getElementById('ma20-value').textContent = '$' + indicators.ma_20.toFixed(2);
            }
            if (indicators.ma_50) {
                document.getElementById('ma50-value').textContent = '$' + indicators.ma_50.toFixed(2);
            }
            if (indicators.rsi) {
                const rsiElement = document.getElementById('rsi-value');
                rsiElement.textContent = indicators.rsi.toFixed(1);

                // RSI é¡è‰²æŒ‡ç¤º
                rsiElement.className = 'indicator-value';
                if (indicators.rsi > 70) {
                    rsiElement.classList.add('rsi-overbought');
                } else if (indicators.rsi < 30) {
                    rsiElement.classList.add('rsi-oversold');
                } else {
                    rsiElement.classList.add('rsi-neutral');
                }
            }
        }

        // ===== æ›´æ–°äº¤å‰ä¿¡è™Ÿé¡¯ç¤º =====
        function updateCrossSignalDisplay(crossSignal) {
            console.log('ğŸ“Š æ›´æ–°äº¤å‰ä¿¡è™Ÿé¡¯ç¤º:', crossSignal);

            const signalDisplay = document.getElementById('cross-signal-display');
            const signalValue = document.getElementById('signal-value');

            if (crossSignal && crossSignal.status) {
                signalDisplay.style.display = 'block';

                // è¨­ç½®ä¿¡è™Ÿç‹€æ…‹
                let statusText = '';
                let statusClass = '';

                switch (crossSignal.status) {
                    case 'golden_cross':
                        statusText = 'ğŸŸ¢ é»ƒé‡‘äº¤å‰';
                        statusClass = 'signal-golden';
                        break;
                    case 'death_cross':
                        statusText = 'ğŸ”´ æ­»äº¡äº¤å‰';
                        statusClass = 'signal-death';
                        break;
                    case 'normal':
                        statusText = 'âšª æ­£å¸¸';
                        statusClass = 'signal-normal';
                        break;
                    default:
                        statusText = 'âšª æ­£å¸¸';
                        statusClass = 'signal-normal';
                }

                signalValue.textContent = statusText;
                signalValue.className = `signal-value ${statusClass}`;

            } else {
                signalDisplay.style.display = 'none';
            }
        }

        // ===== æ›´æ–°è©³ç´°æ—¥èªŒ =====
        function updateDetailedLogs(goldData) {
            const detailsContainer = document.getElementById('detailed-logs');
            if (!detailsContainer) return;

            console.log('ğŸ“ æ›´æ–°è©³ç´°æ—¥èªŒ');

            const logs = [];

            // ç³»çµ±è³‡è¨Š
            logs.push(`<div class="log-section">
                <h4><i class="fas fa-info-circle"></i> ç³»çµ±è³‡è¨Š</h4>
                <div class="log-content">
                    <p><strong>ç³»çµ±æ™‚é–“:</strong> ${new Date().toLocaleString('zh-TW')}</p>
                    <p><strong>æ•¸æ“šä¾†æº:</strong> ${goldData.data_source || 'Yahoo Finance'}</p>
                    <p><strong>APIç‹€æ…‹:</strong> <span class="status-success">æ­£å¸¸</span></p>
                    <p><strong>ä¸‹æ¬¡æ›´æ–°:</strong> ${goldData.next_update || '5åˆ†é˜å¾Œ'}</p>
                </div>
            </div>`);

            // é»ƒé‡‘åƒ¹æ ¼è©³æƒ…
            if (goldData.data) {
                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-coins"></i> é»ƒé‡‘åƒ¹æ ¼è©³æƒ…</h4>
                    <div class="log-content">
                        <p><strong>ä»£ç¢¼:</strong> ${goldData.data.symbol || 'GC=F'}</p>
                        <p><strong>åç¨±:</strong> ${goldData.data.name || 'Gold Futures'}</p>
                        <p><strong>ç•¶å‰åƒ¹æ ¼:</strong> ${goldData.data.current_price?.toFixed(2) || 'N/A'}</p>
                        <p><strong>è®ŠåŒ–é‡‘é¡:</strong> ${goldData.data.change >= 0 ? '+' : ''}${goldData.data.change?.toFixed(2) || 'N/A'}</p>
                        <p><strong>è®ŠåŒ–ç™¾åˆ†æ¯”:</strong> ${goldData.data.change_percent >= 0 ? '+' : ''}${goldData.data.change_percent?.toFixed(2) || 'N/A'}%</p>
                        <p><strong>24å°æ™‚æœ€é«˜:</strong> ${goldData.data.high_24h?.toFixed(2) || 'N/A'}</p>
                        <p><strong>24å°æ™‚æœ€ä½:</strong> ${goldData.data.low_24h?.toFixed(2) || 'N/A'}</p>
                        <p><strong>å¹³å‡åƒ¹æ ¼:</strong> ${goldData.data.avg_price?.toFixed(2) || 'N/A'}</p>
                        <p><strong>æ³¢å‹•ç‡:</strong> ${goldData.data.volatility?.toFixed(2) || 'N/A'}</p>
                        <p><strong>å¸‚å ´ç‹€æ…‹:</strong> ${getMarketStatusText(goldData.data.market_status)}</p>
                        <p><strong>è²¨å¹£å–®ä½:</strong> ${goldData.data.currency || 'USD'}</p>
                        <p><strong>æ•¸æ“šé»æ•¸é‡:</strong> ${goldData.data.data_points || 0}</p>
                        <p><strong>äº¤æ˜“å¤©æ•¸:</strong> ${goldData.data.trading_days || 0}</p>
                        <p><strong>æ™‚é–“æœŸé–“:</strong> ä¸€å¹´</p>
                        <p><strong>æ™‚é–“é–“éš”:</strong> ${goldData.data.interval || '1d'}</p>
                        <p><strong>æœ€å¾Œæ›´æ–°:</strong> ${goldData.data.last_updated_formatted || (goldData.data.last_updated ? new Date(goldData.data.last_updated).toLocaleString('zh-TW') : 'æœªçŸ¥')}</p>
                        
                    </div>
                </div>`);
            }

            // æŠ€è¡“æŒ‡æ¨™è©³æƒ…
            if (goldData.data?.technical_indicators) {
                const indicators = goldData.data.technical_indicators;
                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-chart-line"></i> æŠ€è¡“æŒ‡æ¨™è©³æƒ…</h4>
                    <div class="log-content">
                        ${indicators.ma_5 ? `<p><strong>MA5 (5æ—¥ç§»å‹•å¹³å‡):</strong> ${indicators.ma_5.toFixed(2)}</p>` : ''}
                        ${indicators.ma_20 ? `<p><strong>MA20 (20æ—¥ç§»å‹•å¹³å‡):</strong> ${indicators.ma_20.toFixed(2)}</p>` : ''}
                        ${indicators.ma_50 ? `<p><strong>MA50 (50æ—¥ç§»å‹•å¹³å‡):</strong> ${indicators.ma_50.toFixed(2)}</p>` : ''}
                        ${indicators.rsi ? `<p><strong>RSI (ç›¸å°å¼·å¼±æŒ‡æ¨™):</strong> ${indicators.rsi.toFixed(1)} ${getRSIStatus(indicators.rsi)}</p>` : ''}
                        ${indicators.volatility_5d ? `<p><strong>5æ—¥æ³¢å‹•ç‡:</strong> ${indicators.volatility_5d.toFixed(2)}</p>` : ''}
                        ${indicators.price_vs_ma20 ? `<p><strong>åƒ¹æ ¼ç›¸å°MA20:</strong> ${indicators.price_vs_ma20 >= 0 ? '+' : ''}${indicators.price_vs_ma20.toFixed(2)}%</p>` : ''}
                    </div>
                </div>`);
            }

            // å¸‚å ´æ•¸æ“šè©³æƒ…
            if (marketData) {
                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-brain"></i> å¸‚å ´æƒ…æ„Ÿåˆ†æè©³æƒ…</h4>
                    <div class="log-content">
                        <p><strong>æƒ…æ„Ÿåˆ†æ•¸:</strong> ${marketData.average_sentiment_score?.toFixed(3) || 'N/A'}</p>
                        <p><strong>æƒ…æ„Ÿæè¿°:</strong> ${getSentimentText(marketData.average_sentiment_score)}</p>
                        <p><strong>å¸‚å ´æ—¥æœŸ:</strong> ${marketData.market_date || 'æœªçŸ¥'}</p>

                        <p><strong>æ¥æ”¶æ™‚é–“:</strong> ${marketData.received_time || 'æœªçŸ¥'}</p>
                        <p><strong>å…§å®¹é•·åº¦:</strong> ${marketData.message_content?.length || 0} å­—å…ƒ</p>
                    </div>
                </div>`);
            }

            // åœ–è¡¨æ•¸æ“šæ¨£æœ¬
            if (goldData.data?.chart_data && goldData.data.chart_data.length > 0) {
                const chartData = goldData.data.chart_data;
                const sampleSize = Math.min(5, chartData.length);
                const samples = chartData.slice(-sampleSize);

                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-database"></i> åœ–è¡¨æ•¸æ“šæ¨£æœ¬ (æœ€è¿‘${sampleSize}ç­†)</h4>
                    <div class="log-content">
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>æ™‚é–“</th>
                                        <th>é–‹ç›¤</th>
                                        <th>æœ€é«˜</th>
                                        <th>æœ€ä½</th>
                                        <th>æ”¶ç›¤</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${samples.map(point => `
                                        <tr>
                                            <td>${new Date(point.time).toLocaleDateString('zh-TW')}</td>
                                            <td>${point.open?.toFixed(2) || 'N/A'}</td>
                                            <td>${point.high?.toFixed(2) || 'N/A'}</td>
                                            <td>${point.low?.toFixed(2) || 'N/A'}</td>
                                            <td>${point.price?.toFixed(2) || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`);
            }

            // å­£å¹³å‡å‡ç·šè©³æƒ…
            if (goldData.data?.quarterly_average_line && goldData.data.quarterly_average_line.length > 0) {
                const quarterlyData = goldData.data.quarterly_average_line;
                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-calendar-alt"></i> å­£å¹³å‡å‡ç·šè©³æƒ…</h4>
                    <div class="log-content">
                        <p><strong>æ•¸æ“šé»æ•¸:</strong> ${quarterlyData.length}</p>
                        <p><strong>æ™‚é–“ç¯„åœ:</strong> ${new Date(quarterlyData[0].time).toLocaleDateString('zh-TW')} - ${new Date(quarterlyData[quarterlyData.length - 1].time).toLocaleDateString('zh-TW')}</p>
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>å­£åº¦</th>
                                        <th>å¹³å‡åƒ¹æ ¼</th>
                                        <th>è®ŠåŒ–</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${quarterlyData.map((point, index) => {
                    const prevPrice = index > 0 ? quarterlyData[index - 1].price : point.price;
                    const change = point.price - prevPrice;
                    const changePercent = (change / prevPrice * 100);
                    return `
                                            <tr>
                                                <td>${new Date(point.time).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' })}</td>
                                                <td>$${point.price.toFixed(2)}</td>
                                                <td class="${change >= 0 ? 'positive' : 'negative'}">
                                                    ${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%)
                                                </td>
                                            </tr>
                                        `;
                }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`);
            }

            // å®Œæ•´å¹´åº¦æ•¸æ“šçµ±è¨ˆ
            if (goldData.data?.chart_data && goldData.data.chart_data.length > 0) {
                const chartData = goldData.data.chart_data;
                const prices = chartData.map(d => d.price).filter(p => p && !isNaN(p));

                logs.push(`<div class="log-section">
                    <h4><i class="fas fa-chart-bar"></i> å®Œæ•´å¹´åº¦æ•¸æ“šçµ±è¨ˆ</h4>
                    <div class="log-content">
                        <p><strong>ç¸½æ•¸æ“šé»æ•¸:</strong> ${chartData.length}</p>
                        <p><strong>æœ‰æ•ˆåƒ¹æ ¼æ•¸æ“š:</strong> ${prices.length}</p>
                        <p><strong>åƒ¹æ ¼ç¯„åœ:</strong> ${Math.min(...prices).toFixed(2)} - ${Math.max(...prices).toFixed(2)}</p>
                        <p><strong>å¹´åº¦å¹³å‡åƒ¹æ ¼:</strong> ${(prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2)}</p>
                        <p><strong>å¹´åº¦åƒ¹æ ¼æ¨™æº–å·®:</strong> ${calculateStandardDeviation(prices).toFixed(2)}</p>
                        <p><strong>æ•¸æ“šèµ·å§‹æ—¥æœŸ:</strong> ${new Date(chartData[0].time).toLocaleDateString('zh-TW')}</p>
                        <p><strong>æ•¸æ“šçµæŸæ—¥æœŸ:</strong> ${new Date(chartData[chartData.length - 1].time).toLocaleDateString('zh-TW')}</p>
                        <p><strong>å¹´åº¦æ¼²è·Œ:</strong> ${((prices[prices.length - 1] - prices[0]) / prices[0] * 100).toFixed(2)}%</p>
                    </div>
                </div>`);
            }

            detailsContainer.innerHTML = logs.join('');
        }

        // ===== ç‹€æ…‹æ›´æ–°å‡½æ•¸ =====
        function updateMarketStatus(status, text) {
            const dot = document.querySelector('#status-indicator .indicator-dot');
            const textElement = document.querySelector('#status-indicator .indicator-text');

            if (dot && textElement) {
                dot.classList.remove('connected', 'error', 'loading');
                if (status !== 'waiting') {
                    dot.classList.add(status);
                }
                textElement.textContent = text;
            }
        }

        function updatePriceStatus(status, text) {
            const dot = document.querySelector('#price-status .status-dot');
            const textElement = document.querySelector('#price-status .status-text');

            if (dot && textElement) {
                dot.classList.remove('connected', 'error', 'loading');
                if (status !== 'waiting') {
                    dot.classList.add(status);
                }
                textElement.textContent = text;
            }
        }

        function updateGoldLastUpdated(text) {
            const element = document.getElementById('gold-last-updated');
            if (element) {
                element.querySelector('span').textContent = text;
            }
        }

        // ===== è¼‰å…¥å’ŒéŒ¯èª¤é¡¯ç¤ºå‡½æ•¸ =====
        function showPriceLoading() {
            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <span>æ­£åœ¨è¼‰å…¥é»ƒé‡‘åƒ¹æ ¼...</span>
                </div>
            `;
        }

        function displayNoMarketData() {
            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-chart-bar"></i>
                    <h3>ç­‰å¾…å¸‚å ´æ•¸æ“š</h3>
                    <p>è«‹ç¢ºèª N8N å·¥ä½œæµç¨‹å·²æ­£ç¢ºé‹è¡Œä¸¦ç™¼é€æ•¸æ“š</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        é‡æ–°è¼‰å…¥
                    </button>
                </div>
            `;
        }

        function displayMarketError(message) {
            const display = document.getElementById('market-data-display');
            display.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>æ•¸æ“šè¼‰å…¥å¤±æ•—</h3>
                    <p>${message}</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        é‡è©¦
                    </button>
                </div>
            `;
        }

        function displayPriceError(message) {
            const display = document.getElementById('price-display');
            display.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>åƒ¹æ ¼è¼‰å…¥å¤±æ•—</h3>
                    <p>${message}</p>
                    <button onclick="loadGoldPrice(currentPeriod, true)" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        é‡è©¦
                    </button>
                </div>
            `;
        }

        // ===== è¼”åŠ©å‡½æ•¸ =====
        function getSentimentClass(score) {
            if (score > 0.1) return 'positive';
            if (score < -0.1) return 'negative';
            return 'neutral';
        }

        function getSentimentText(score) {
            if (score > 0.6) return 'æ¥µåº¦æ¨‚è§€';
            if (score > 0.3) return 'æ¨‚è§€';
            if (score > 0.1) return 'ç•¥ç‚ºæ¨‚è§€';
            if (score > -0.1) return 'ä¸­æ€§';
            if (score > -0.3) return 'ç•¥ç‚ºæ‚²è§€';
            if (score > -0.6) return 'æ‚²è§€';
            return 'æ¥µåº¦æ‚²è§€';
        }

        function getMarketStatusText(status) {
            const statusMap = {
                'open': 'é–‹å¸‚',
                'closed': 'ä¼‘å¸‚',
                'unknown': 'æœªçŸ¥'
            };
            return statusMap[status] || status;
        }

        function getRSIStatus(rsi) {
            if (rsi > 70) return '(è¶…è²·)';
            if (rsi < 30) return '(è¶…è³£)';
            return '(æ­£å¸¸)';
        }

        function calculateStandardDeviation(values) {
            const avg = values.reduce((a, b) => a + b) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        // ===== æŒ‰éˆ•æ“ä½œå‡½æ•¸ =====
        function refreshAllData() {
            console.log('ğŸ”„ åˆ·æ–°æ‰€æœ‰æ•¸æ“š');
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>åˆ·æ–°ä¸­...</span>';
            }

            Promise.all([
                loadMarketData(),
                loadGoldPrice(currentPeriod, true)
            ]).finally(() => {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync"></i><span>åˆ·æ–°æ•¸æ“š</span>';
                }
            });
        }

        function toggleTechnicalIndicators() {
            const indicators = document.getElementById('technical-indicators');
            const toggleBtn = document.getElementById('indicator-toggle');

            if (indicators) {
                indicatorsVisible = !indicatorsVisible;
                indicators.style.display = indicatorsVisible ? 'block' : 'none';

                if (toggleBtn) {
                    toggleBtn.innerHTML = indicatorsVisible ?
                        '<i class="fas fa-eye-slash"></i><span>éš±è—æŠ€è¡“æŒ‡æ¨™</span>' :
                        '<i class="fas fa-eye"></i><span>é¡¯ç¤ºæŠ€è¡“æŒ‡æ¨™</span>';
                }
            }
        }

        function toggleDataDetails() {
            const details = document.getElementById('data-details');
            const toggleBtn = document.getElementById('details-toggle');

            if (details) {
                detailsVisible = !detailsVisible;
                details.style.display = detailsVisible ? 'block' : 'none';

                if (toggleBtn) {
                    toggleBtn.innerHTML = detailsVisible ?
                        '<i class="fas fa-eye-slash"></i><span>éš±è—è©³æƒ…</span>' :
                        '<i class="fas fa-eye"></i><span>é¡¯ç¤ºè©³æƒ…</span>';
                }

                // å¦‚æœé¡¯ç¤ºè©³æƒ…ä¸”æœ‰æ•¸æ“šï¼Œæ›´æ–°æ—¥èªŒ
                if (detailsVisible && goldPriceData) {
                    updateDetailedLogs({ data: goldPriceData });
                }
            }
        }

        function toggleMarketContent() {
            const content = document.getElementById('market-content');
            const isExpanded = content.style.maxHeight === 'none';

            content.style.maxHeight = isExpanded ? '200px' : 'none';
            content.style.overflow = isExpanded ? 'hidden' : 'visible';

            const btn = content.nextElementSibling;
            if (btn && btn.classList.contains('expand-btn')) {
                btn.textContent = isExpanded ? 'å±•é–‹å…¨æ–‡' : 'æ”¶èµ·';
            }
        }

        // ===== éŒ¯èª¤è™•ç† =====
        window.addEventListener('error', (e) => {
            console.error('JavaScript éŒ¯èª¤:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
        });

        console.log('âœ… å¸‚å ´åˆ†æç³»çµ±è…³æœ¬è¼‰å…¥å®Œæˆ');
    </script>

    <style>
        /* å¼·åˆ¶Xè»¸æ¨™ç±¤æ°´å¹³é¡¯ç¤º */
        .chart-container canvas {
            transform: none !important;
        }

        /* å¼·åˆ¶åœ–è¡¨æ¨™ç±¤æ°´å¹³é¡¯ç¤º */
        .chart-container {
            overflow: visible !important;
        }

        /* ç¢ºä¿Xè»¸æ¨™ç±¤ä¸æ—‹è½‰ */
        .chart-container canvas {
            transform: none !important;
        }

        /* è©³ç´°æ—¥èªŒæ¨£å¼ */
        .data-details-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: var(--transition);
        }

        .log-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-glass);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .log-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .log-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .log-content p {
            margin-bottom: 0.5rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .log-content strong {
            color: var(--text-primary);
        }

        .status-success {
            color: var(--success);
            font-weight: bold;
        }

        .data-table {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: bold;
        }

        .data-table td {
            color: var(--text-secondary);
        }

        .data-table tr:hover {
            background: var(--bg-glass);
        }

        .data-table .positive {
            color: var(--success);
            font-weight: bold;
        }

        .data-table .negative {
            color: var(--error);
            font-weight: bold;
        }

        /* ç·šæ¢æ§åˆ¶æ¨£å¼ */
        .line-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .line-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .line-toggle:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }

        .line-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .toggle-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }

            .line-controls {
                gap: 0.5rem;
            }

            .line-toggle {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
        }

        /* å¼·åˆ¶Xè»¸æ¨™ç±¤æ°´å¹³é¡¯ç¤º */
        .chart-container canvas {
            transform: none !important;
        }

        /* äº¤å‰ä¿¡è™Ÿé¡¯ç¤ºæ¨£å¼ */
        .cross-signal-display {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-glass);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .cross-signal-display h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .signal-content {
            display: grid;
            gap: 1rem;
        }

        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .signal-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .signal-value {
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .signal-golden {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .signal-death {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .signal-normal {
            background: rgba(100, 116, 139, 0.2);
            color: #64748b;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .signal-message-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .signal-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</body>

</html>