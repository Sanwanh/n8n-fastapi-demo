<!-- 市場數據預覽卡片 -->
            <div class="card data-preview-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <h2>郵件內容預覽</h2>
                    <div class="status-indicator" id="status-indicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">載入中...</span>
                    </div>
                </div>
                <div class="card-content">
                    <div id="market-data-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>正在載入郵件預覽數據...</span>
                        </div>
                    </div>
                </div>
            </div><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場分析郵件發送系統</title>
    <style>
        /* 郵件頁面專用的市場數據預覽樣式 */
        .market-data-preview {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .preview-header h4 {
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-freshness {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .summary-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-glass);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .summary-card:hover {
            border-color: var(--border-focus);
            background: rgba(255, 255, 255, 0.08);
        }

        .summary-card.sentiment-positive {
            border-left: 4px solid var(--success);
        }

        .summary-card.sentiment-negative {
            border-left: 4px solid var(--error);
        }

        .summary-card.sentiment-neutral {
            border-left: 4px solid var(--warning);
        }

        .summary-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .summary-content {
            flex: 1;
        }

        .summary-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .summary-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .summary-score {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .content-preview {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .content-preview h5 {
            color: var(--text-primary);
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .content-snippet {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .content-stats {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .content-stats .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .preview-footer {
            display: flex;
            justify-content: center;
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .data-quality {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success);
            font-weight: 600;
        }

        /* 響應式調整 */
        @media (max-width: 768px) {
            .data-summary {
                grid-template-columns: 1fr;
            }

            .preview-header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .content-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
    </div>

    <div class="container">
        <!-- 導航列 -->
        <nav class="navigation">
            <div class="nav-brand">
                <i class="fas fa-envelope-open-text"></i>
                <span>郵件發送系統</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i>
                    返回首頁
                </a>
                <div class="system-time" id="system-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                </div>
            </div>
        </nav>

        <!-- 標題區域 -->
        <header class="page-header">
            <div class="header-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <h1>市場分析郵件發送</h1>
            <p>將最新市場分析數據通過郵件發送給指定收件人</p>
            <div class="last-updated" id="last-updated">
                <i class="fas fa-sync"></i>
                <span>數據更新: --</span>
            </div>
        </header>

        <!-- 主要內容 -->
        <div class="main-content">
            <!-- 市場數據預覽卡片 -->
            <div class="card data-preview-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h2>當前市場數據預覽</h2>
                    <div class="status-indicator" id="status-indicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">載入中...</span>
                    </div>
                </div>
                <div class="card-content">
                    <div id="market-data-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>正在載入市場數據...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 郵件配置卡片 -->
            <div class="card mail-form-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h2>郵件設定與發送</h2>
                    <div class="form-progress" id="form-progress">
                        <div class="progress-step active" data-step="1">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="progress-step" data-step="2">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="progress-step" data-step="3">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="progress-step" data-step="4">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <form id="mail-form" class="mail-form">
                        <!-- 步驟 1: 基本資訊 -->
                        <div class="form-step active" data-step="1">
                            <div class="step-header">
                                <h3><i class="fas fa-user"></i> 收件人資訊</h3>
                                <p>請輸入郵件收件人的基本資訊</p>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="recipient">
                                        <i class="fas fa-envelope"></i>
                                        收件人郵件地址 *
                                    </label>
                                    <input type="email" id="recipient" name="recipient"
                                           placeholder="example@email.com" required>
                                    <div class="input-hint">請輸入有效的郵件地址</div>
                                </div>

                                <div class="form-group">
                                    <label for="sender_name">
                                        <i class="fas fa-signature"></i>
                                        寄件人名稱
                                    </label>
                                    <input type="text" id="sender_name" name="sender_name"
                                           value="市場分析系統" placeholder="請輸入寄件人名稱">
                                    <div class="input-hint">將顯示在郵件中的發送者名稱</div>
                                </div>
                            </div>
                        </div>

                        <!-- 步驟 2: 郵件內容 -->
                        <div class="form-step" data-step="2">
                            <div class="step-header">
                                <h3><i class="fas fa-edit"></i> 郵件內容</h3>
                                <p>設定郵件主題和自訂內容</p>
                            </div>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="subject">
                                        <i class="fas fa-heading"></i>
                                        郵件主旨 *
                                    </label>
                                    <input type="text" id="subject" name="subject"
                                           value="市場分析報告" placeholder="請輸入郵件主旨">
                                    <div class="input-hint">建議包含日期或時間範圍</div>
                                </div>

                                <div class="form-group full-width">
                                    <label for="custom_message">
                                        <i class="fas fa-comment-alt"></i>
                                        自訂開頭訊息 <span class="optional">(選填)</span>
                                    </label>
                                    <textarea id="custom_message" name="custom_message" rows="4"
                                             placeholder="請輸入您想要添加到郵件開頭的自訂內容..."></textarea>
                                    <div class="input-hint">此訊息將顯示在市場分析內容之前</div>
                                </div>

                                <div class="form-group full-width">
                                    <label for="mail_type">
                                        <i class="fas fa-tag"></i>
                                        郵件類型
                                    </label>
                                    <select id="mail_type" name="mail_type" class="form-select">
                                        <option value="daily">每日報告</option>
                                        <option value="weekly">週度報告</option>
                                        <option value="monthly">月度報告</option>
                                        <option value="alert">市場警示</option>
                                        <option value="custom">自訂報告</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 步驟 3: 郵件選項 -->
                        <div class="form-step" data-step="3">
                            <div class="step-header">
                                <h3><i class="fas fa-cog"></i> 郵件選項</h3>
                                <p>選擇要包含在郵件中的額外內容</p>
                            </div>
                            <div class="options-section">
                                <div class="option-category">
                                    <h4>內容選項</h4>
                                    <div class="options-grid">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="include_charts" name="include_charts" checked>
                                            <label for="include_charts">
                                                <span class="checkbox-mark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                                <span class="checkbox-content">
                                                    <strong><i class="fas fa-chart-bar"></i> 包含圖表分析</strong>
                                                    <small>在郵件中附加視覺化圖表和技術分析</small>
                                                </span>
                                            </label>
                                        </div>

                                        <div class="checkbox-group">
                                            <input type="checkbox" id="include_recommendations" name="include_recommendations" checked>
                                            <label for="include_recommendations">
                                                <span class="checkbox-mark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                                <span class="checkbox-content">
                                                    <strong><i class="fas fa-lightbulb"></i> 包含投資建議</strong>
                                                    <small>基於當前市場分析提供相應投資建議</small>
                                                </span>
                                            </label>
                                        </div>

                                        <div class="checkbox-group">
                                            <input type="checkbox" id="include_risk_warning" name="include_risk_warning" checked>
                                            <label for="include_risk_warning">
                                                <span class="checkbox-mark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                                <span class="checkbox-content">
                                                    <strong><i class="fas fa-exclamation-triangle"></i> 包含風險提醒</strong>
                                                    <small>添加風險評估和投資注意事項</small>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="option-category">
                                    <h4>郵件優先級</h4>
                                    <div class="priority-options">
                                        <div class="radio-group">
                                            <input type="radio" id="priority_low" name="priority" value="low">
                                            <label for="priority_low">
                                                <i class="fas fa-arrow-down priority-icon low"></i>
                                                <span>低優先級</span>
                                            </label>
                                        </div>
                                        <div class="radio-group">
                                            <input type="radio" id="priority_normal" name="priority" value="normal" checked>
                                            <label for="priority_normal">
                                                <i class="fas fa-minus priority-icon normal"></i>
                                                <span>一般</span>
                                            </label>
                                        </div>
                                        <div class="radio-group">
                                            <input type="radio" id="priority_high" name="priority" value="high">
                                            <label for="priority_high">
                                                <i class="fas fa-exclamation priority-icon high"></i>
                                                <span>高優先級</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 步驟 4: 預覽與發送 -->
                        <div class="form-step" data-step="4">
                            <div class="step-header">
                                <h3><i class="fas fa-paper-plane"></i> 預覽與發送</h3>
                                <p>確認郵件內容並發送</p>
                            </div>
                            <div class="preview-section">
                                <div class="email-preview" id="email-preview">
                                    <div class="preview-header">
                                        <h4><i class="fas fa-envelope"></i> 郵件預覽</h4>
                                        <button type="button" class="preview-refresh-btn" onclick="generatePreview()">
                                            <i class="fas fa-sync"></i> 刷新預覽
                                        </button>
                                    </div>
                                    <div class="preview-content" id="preview-content">
                                        <div class="loading-spinner">
                                            <div class="spinner"></div>
                                            <span>生成預覽中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 表單導航 -->
                        <div class="form-navigation">
                            <button type="button" id="prev-btn" class="nav-btn secondary" style="display: none;">
                                <i class="fas fa-arrow-left"></i>
                                <span>上一步</span>
                            </button>
                            <div class="step-info">
                                <span class="step-current">1</span>
                                <span class="step-separator">/</span>
                                <span class="step-total">4</span>
                            </div>
                            <button type="button" id="next-btn" class="nav-btn primary">
                                <span>下一步</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <button type="submit" id="send-btn" class="nav-btn success" style="display: none;" disabled>
                                <span class="btn-icon">
                                    <i class="fas fa-paper-plane"></i>
                                </span>
                                <span class="btn-text">發送郵件</span>
                                <div class="btn-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 結果模態框 -->
        <div class="modal" id="result-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon" id="result-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 id="result-title">發送成功</h3>
                    <button class="modal-close" id="result-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="result-message">郵件已成功發送！</div>
                    <div id="result-details"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="result-ok">確定</button>
                    <button class="btn btn-secondary" id="send-another">再發一封</button>
                </div>
            </div>
        </div>

        <!-- 頁腳 -->
        <footer class="page-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>市場分析郵件系統</h3>
                    <p>專業的市場分析報告郵件發送服務</p>
                </div>
                <div class="footer-stats">
                    <div class="stat-item">
                        <span class="stat-label">系統狀態</span>
                        <span class="stat-value" id="system-status">正常運行</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">版本</span>
                        <span class="stat-value">v2.1.0</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // 全域變數
        let currentMarketData = null;
        let currentStep = 1;
        let formValid = false;

        // 時間更新
        function updateSystemTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-TW');
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadMarketData();
            bindEvents();
            updateSystemTime();
            setInterval(updateSystemTime, 1000);

            // 自動填充今日日期到主題
            const today = new Date().toLocaleDateString('zh-TW');
            const subjectInput = document.getElementById('subject');
            if (subjectInput.value === '市場分析報告') {
                subjectInput.value = `市場分析報告 - ${today}`;
            }
        });

        // 綁定事件
        function bindEvents() {
            // 表單提交
            document.getElementById('mail-form').addEventListener('submit', handleSubmit);

            // 模態框關閉
            document.getElementById('result-close').addEventListener('click', hideModal);
            document.getElementById('result-ok').addEventListener('click', hideModal);
            document.getElementById('send-another').addEventListener('click', () => {
                hideModal();
                resetForm();
            });

            // 表單驗證
            const requiredInputs = document.querySelectorAll('#mail-form input[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('input', validateCurrentStep);
                input.addEventListener('blur', validateCurrentStep);
            });

            // 步驟導航
            document.getElementById('next-btn').addEventListener('click', nextStep);
            document.getElementById('prev-btn').addEventListener('click', prevStep);

            // 即時預覽
            document.querySelectorAll('#mail-form input, #mail-form textarea, #mail-form select').forEach(input => {
                input.addEventListener('input', debounce(generatePreview, 500));
            });

            // 模態框外部點擊關閉
            document.getElementById('result-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideModal();
            });

            // ESC 鍵關閉模態框
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hideModal();
            });
        }

        // 載入市場數據
        async function loadMarketData() {
            try {
                updateStatus('loading', '載入市場數據...');

                const response = await fetch('/api/current-data');
                const result = await response.json();

                if (result.data && Object.keys(result.data).length > 0) {
                    currentMarketData = result.data;
                    displayMarketData(result.data);
                    updateStatus('connected', '數據已更新');

                    // 更新最後更新時間
                    document.getElementById('last-updated').querySelector('span').textContent =
                        `數據更新: ${result.data.received_time}`;

                    validateCurrentStep();
                } else {
                    displayNoData();
                    updateStatus('waiting', '等待數據...');
                }
            } catch (error) {
                console.error('載入市場數據失敗:', error);
                displayError('無法載入市場數據: ' + error.message);
                updateStatus('error', '連接錯誤');
            }
        }

        // 顯示市場數據（郵件頁面專用 - 精簡版）
        function displayMarketData(data) {
            const sentimentClass = getSentimentClass(data.average_sentiment_score);
            const sentimentText = getSentimentText(data.average_sentiment_score);

            document.getElementById('market-data-display').innerHTML = `
                <div class="market-data-preview">
                    <div class="preview-header">
                        <h4><i class="fas fa-chart-pulse"></i> 將發送的市場數據預覽</h4>
                        <div class="data-freshness">
                            <i class="fas fa-clock"></i>
                            <span>數據時間: ${data.received_time}</span>
                        </div>
                    </div>

                    <div class="data-summary">
                        <div class="summary-card sentiment-${sentimentClass}">
                            <div class="summary-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">市場情緒</div>
                                <div class="summary-value">${sentimentText}</div>
                                <div class="summary-score">${data.average_sentiment_score?.toFixed(3)}</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">分析日期</div>
                                <div class="summary-value">${data.market_date || '今日'}</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">風險評估</div>
                                <div class="summary-value">${data.risk_assessment || '未評估'}</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-trending-up"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">趨勢方向</div>
                                <div class="summary-value">${data.trend_direction || '未評估'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="content-preview">
                        <h5><i class="fas fa-newspaper"></i> 分析內容摘要</h5>
                        <div class="content-snippet">
                            ${formatContentPreview(data.message_content)}
                        </div>
                        <div class="content-stats">
                            <span class="stat"><i class="fas fa-file-alt"></i> ${data.message_content?.length || 0} 字元</span>
                            <span class="stat"><i class="fas fa-language"></i> 繁體中文</span>
                        </div>
                    </div>

                    <div class="preview-footer">
                        <div class="data-quality">
                            <i class="fas fa-check-circle"></i>
                            <span>資料完整，可以發送</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // 表單步驟控制
        function nextStep() {
            if (!validateCurrentStep()) return;

            if (currentStep < 4) {
                currentStep++;
                showStep(currentStep);
                if (currentStep === 4) {
                    generatePreview();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            // 隱藏所有步驟
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.progress-step').forEach(s => s.classList.remove('active'));

            // 顯示當前步驟
            document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
            document.querySelector(`.progress-step[data-step="${step}"]`).classList.add('active');

            // 更新導航按鈕
            document.getElementById('prev-btn').style.display = step > 1 ? 'flex' : 'none';
            document.getElementById('next-btn').style.display = step < 4 ? 'flex' : 'none';
            document.getElementById('send-btn').style.display = step === 4 ? 'flex' : 'none';

            // 更新步驟計數器
            document.querySelector('.step-current').textContent = step;

            validateCurrentStep();
        }

        // 表單驗證
        function validateCurrentStep() {
            let isValid = true;

            if (currentStep === 1) {
                const recipient = document.getElementById('recipient').value;
                isValid = recipient && recipient.includes('@') && currentMarketData;
            } else if (currentStep === 2) {
                const subject = document.getElementById('subject').value;
                isValid = subject.trim().length > 0;
            }

            // 更新按鈕狀態
            document.getElementById('next-btn').disabled = !isValid;
            document.getElementById('send-btn').disabled = !isValid;

            return isValid;
        }

        // 生成郵件預覽
        function generatePreview() {
            if (!currentMarketData) {
                document.getElementById('preview-content').innerHTML = '<p class="error">無市場數據可預覽</p>';
                return;
            }

            const formData = new FormData(document.getElementById('mail-form'));
            const content = generateEmailContent(formData);

            document.getElementById('preview-content').innerHTML = `
                <div class="email-preview-content">
                    <div class="preview-meta">
                        <div class="meta-item">
                            <strong>收件人:</strong> ${formData.get('recipient')}
                        </div>
                        <div class="meta-item">
                            <strong>主旨:</strong> ${formData.get('subject')}
                        </div>
                        <div class="meta-item">
                            <strong>優先級:</strong> ${getPriorityText(formData.get('priority'))}
                        </div>
                    </div>
                    <div class="preview-divider"></div>
                    <div class="preview-body">
                        <pre class="email-content">${content}</pre>
                    </div>
                </div>
            `;
        }

        // 生成郵件內容
        function generateEmailContent(formData) {
            const customMessage = formData.get('custom_message') || '';
            const includeCharts = formData.has('include_charts');
            const includeRecommendations = formData.has('include_recommendations');
            const includeRiskWarning = formData.has('include_risk_warning');

            let content = '';

            // 自訂開頭訊息
            if (customMessage.trim()) {
                content += `${customMessage}\n\n`;
            }

            // 郵件標題
            content += `╔══════════════════════════════════════════╗\n`;
            content += `║              📊 市場分析報告 📊           ║\n`;
            content += `╚══════════════════════════════════════════╝\n\n`;

            // 基本資訊
            content += `📅 報告日期：${currentMarketData.market_date || '今日'}\n`;
            content += `⏰ 生成時間：${new Date().toLocaleString('zh-TW')}\n`;
            content += `📡 數據來源：N8N 市場分析系統\n\n`;

            // 市場概況
            content += `📊 市場概況分析\n`;
            content += `${'─'.repeat(40)}\n`;
            content += `💹 情感分析分數：${currentMarketData.average_sentiment_score?.toFixed(3)}\n`;
            content += `📈 情感評估：${getSentimentText(currentMarketData.average_sentiment_score)}\n`;
            content += `🎯 信心水平：${currentMarketData.confidence_level || '未知'}\n`;
            content += `📊 趨勢方向：${currentMarketData.trend_direction || '未知'}\n`;
            content += `🛡️  風險評估：${currentMarketData.risk_assessment || '未知'}\n\n`;

            // 詳細分析
            if (currentMarketData.message_content) {
                content += `📰 詳細市場分析\n`;
                content += `${'─'.repeat(40)}\n`;
                content += `${currentMarketData.message_content}\n\n`;
            }

            // 可選內容
            if (includeCharts) {
                content += `📊 圖表分析：本報告包含相關市場圖表分析\n`;
            }

            if (includeRecommendations) {
                content += `💡 投資建議：基於當前分析提供相應投資建議\n`;
            }

            if (includeRiskWarning) {
                content += `⚠️  風險提醒：請注意市場風險，謹慎投資決策\n`;
            }

            content += `\n`;

            // 系統資訊
            content += `${'─'.repeat(50)}\n`;
            content += `🤖 本報告由智能市場分析系統自動生成\n`;
            content += `📧 發送系統：市場分析郵件系統 v2.1\n`;
            content += `⏱️  數據接收時間：${currentMarketData.received_time}\n`;
            content += `📞 如有疑問，請聯繫系統管理員\n`;
            content += `${'─'.repeat(50)}\n`;

            return content;
        }

        // 處理表單提交
        async function handleSubmit(e) {
            e.preventDefault();

            if (!currentMarketData) {
                showModal('error', '發送失敗', '沒有可用的市場數據');
                return;
            }

            setLoadingState(true);

            try {
                const formData = new FormData(e.target);
                const mailData = {
                    recipient_email: formData.get('recipient'),
                    sender_name: formData.get('sender_name') || '市場分析系統',
                    subject: formData.get('subject'),
                    priority: formData.get('priority') || 'normal',
                    mail_type: formData.get('mail_type') || 'daily',
                    custom_message: formData.get('custom_message') || '',
                    include_charts: formData.has('include_charts'),
                    include_recommendations: formData.has('include_recommendations'),
                    include_risk_warning: formData.has('include_risk_warning')
                };

                const response = await fetch('/api/send-mail-to-n8n', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mailData)
                });

                const result = await response.json();

                if (response.ok) {
                    showModal('success', '發送成功',
                        `郵件已成功發送至 ${formData.get('recipient')}`,
                        `發送時間: ${result.sent_time}`);
                } else {
                    throw new Error(result.detail || '發送失敗');
                }

            } catch (error) {
                console.error('發送郵件失敗:', error);

                let errorMessage = '網路連接失敗，請檢查連接後重試';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = '無法連接到 N8N 服務，請檢查 webhook URL 是否正確';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `伺服器回應錯誤：${error.message}`;
                }

                showModal('error', '發送失敗', errorMessage);
            } finally {
                setLoadingState(false);
            }
        }

        // 輔助函數
        function updateStatus(status, text) {
            const dot = document.querySelector('#status-indicator .indicator-dot');
            const textElement = document.querySelector('#status-indicator .indicator-text');

            dot.classList.remove('connected', 'error', 'loading');
            if (status !== 'waiting') {
                dot.classList.add(status);
            }
            textElement.textContent = text;
        }

        function displayNoData() {
            document.getElementById('market-data-display').innerHTML = `
                <div class="no-data">
                    <i class="fas fa-chart-bar"></i>
                    <h3>等待市場數據</h3>
                    <p>請確認 N8N 工作流程已正確運行並發送數據</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        重新載入
                    </button>
                </div>
            `;
        }

        function displayError(message) {
            document.getElementById('market-data-display').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>數據載入失敗</h3>
                    <p>${message}</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        重試
                    </button>
                </div>
            `;
        }

        function getSentimentClass(score) {
            if (score > 0.1) return 'positive';
            if (score < -0.1) return 'negative';
            return 'neutral';
        }

        function getSentimentText(score) {
            if (score > 0.6) return '極度樂觀';
            if (score > 0.3) return '樂觀';
            if (score > 0.1) return '略為樂觀';
            if (score > -0.1) return '中性';
            if (score > -0.3) return '略為悲觀';
            if (score > -0.6) return '悲觀';
            return '極度悲觀';
        }

        function formatContentPreview(content) {
            if (!content) return '無市場分析內容';
            if (content.length > 200) {
                return content.substring(0, 200) + '...';
            }
            return content;
        }

        function getPriorityText(priority) {
            const priorities = {
                'low': '低優先級',
                'normal': '一般',
                'high': '高優先級'
            };
            return priorities[priority] || '一般';
        }

        function setLoadingState(loading) {
            const sendBtn = document.getElementById('send-btn');
            if (loading) {
                sendBtn.classList.add('loading');
                sendBtn.disabled = true;
            } else {
                sendBtn.classList.remove('loading');
                validateCurrentStep();
            }
        }

        function showModal(type, title, message, details = '') {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            const titleEl = document.getElementById('result-title');
            const messageEl = document.getElementById('result-message');
            const detailsEl = document.getElementById('result-details');

            icon.className = `modal-icon ${type}`;
            icon.innerHTML = type === 'success' ?
                '<i class="fas fa-check-circle"></i>' :
                '<i class="fas fa-exclamation-circle"></i>';

            titleEl.textContent = title;
            messageEl.textContent = message;
            detailsEl.textContent = details;

            modal.classList.add('show');

            // 成功時自動關閉
            if (type === 'success') {
                setTimeout(() => {
                    hideModal();
                }, 5000);
            }
        }

        function hideModal() {
            document.getElementById('result-modal').classList.remove('show');
        }

        function resetForm() {
            currentStep = 1;
            showStep(1);
            document.getElementById('mail-form').reset();

            // 重新設定預設值
            const today = new Date().toLocaleDateString('zh-TW');
            document.getElementById('subject').value = `市場分析報告 - ${today}`;
            document.getElementById('sender_name').value = '市場分析系統';
            document.getElementById('priority_normal').checked = true;

            validateCurrentStep();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 全域錯誤處理
        window.addEventListener('error', (e) => {
            console.error('全域錯誤:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('未處理的 Promise 拒絕:', e.reason);
        });
    </script>
</body>
</html>