<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸‚å ´åˆ†æéƒµä»¶ç™¼é€ç³»çµ±</title>
    <link rel="stylesheet" href="/static/mail-style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="background-animation">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
    </div>

    <div class="container">
        <!-- å°èˆªåˆ— -->
        <nav class="navigation">
            <div class="nav-brand">
                <i class="fas fa-envelope-open-text"></i>
                <span>éƒµä»¶ç™¼é€ç³»çµ±</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i>
                    è¿”å›é¦–é 
                </a>
                <div class="system-time" id="system-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                </div>
            </div>
        </nav>

        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="page-header">
            <div class="header-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <h1>å¸‚å ´åˆ†æéƒµä»¶ç™¼é€</h1>
            <p>å°‡æœ€æ–°å¸‚å ´åˆ†ææ•¸æ“šé€šééƒµä»¶ç™¼é€çµ¦æŒ‡å®šæ”¶ä»¶äºº</p>
        </header>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <!-- å¸‚å ´æ•¸æ“šé è¦½å¡ç‰‡ -->
            <div class="card data-preview-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h2>å¸‚å ´æ•¸æ“šé è¦½</h2>
                    <div class="status-indicator" id="status-indicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                <div class="card-content">
                    <div id="market-data-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>æ­£åœ¨è¼‰å…¥å¸‚å ´æ•¸æ“š...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç°¡åŒ–çš„éƒµä»¶ç™¼é€è¡¨å–® -->
            <div class="card mail-form-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h2>éƒµä»¶ç™¼é€</h2>
                </div>
                <div class="card-content">
                    <form id="mail-form" class="simple-mail-form">
                        <div class="form-group">
                            <label for="recipient">
                                <i class="fas fa-envelope"></i>
                                æ”¶ä»¶äººéƒµä»¶åœ°å€ *
                            </label>
                            <input type="email" id="recipient" name="recipient" placeholder="example@email.com"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="custom_message">
                                <i class="fas fa-comment-alt"></i>
                                è‡ªè¨‚è¨Šæ¯ (é¸å¡«)
                            </label>
                            <textarea id="custom_message" name="custom_message" rows="3"
                                placeholder="è«‹è¼¸å…¥æ‚¨æƒ³è¦æ·»åŠ çš„è‡ªè¨‚å…§å®¹..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="send-btn" class="btn btn-primary">
                                <span class="btn-icon">
                                    <i class="fas fa-paper-plane"></i>
                                </span>
                                <span class="btn-text">ç™¼é€éƒµä»¶</span>
                                <div class="btn-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </button>
                            <button type="button" id="debug-btn" class="btn btn-secondary"
                                onclick="debugDataStructure()">
                                <span class="btn-icon">
                                    <i class="fas fa-bug"></i>
                                </span>
                                <span class="btn-text">æŸ¥çœ‹æ•¸æ“šçµæ§‹</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- çµæœæ¨¡æ…‹æ¡† -->
        <div class="modal" id="result-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon" id="result-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 id="result-title">ç™¼é€æˆåŠŸ</h3>
                    <button class="modal-close" id="result-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="result-message">éƒµä»¶å·²æˆåŠŸç™¼é€ï¼</div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="result-ok">ç¢ºå®š</button>
                    <button class="btn btn-secondary" id="send-another">å†ç™¼ä¸€å°</button>
                </div>
            </div>
        </div>

        <!-- é è…³ -->
        <footer class="page-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>å¸‚å ´åˆ†æéƒµä»¶ç³»çµ±</h3>
                    <p>å°ˆæ¥­çš„å¸‚å ´åˆ†æå ±å‘Šéƒµä»¶ç™¼é€æœå‹™</p>
                </div>
                <div class="footer-stats">
                    <div class="stat-item">
                        <span class="stat-label">ç³»çµ±ç‹€æ…‹</span>
                        <span class="stat-value" id="system-status">æ­£å¸¸é‹è¡Œ</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ç‰ˆæœ¬</span>
                        <span class="stat-value">v2.1.4</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ç°¡åŒ–çš„éƒµä»¶ç™¼é€ç³»çµ± JavaScript
        console.log('ğŸ“§ éƒµä»¶ç™¼é€ç³»çµ±è¼‰å…¥ä¸­...');

        let currentMarketData = null;

        // æ™‚é–“æ›´æ–°
        function updateSystemTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-TW');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            loadMarketData();
            bindEvents();
            updateSystemTime();
            setInterval(updateSystemTime, 1000);
            console.log('âœ… éƒµä»¶ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        });

        // ç¶å®šäº‹ä»¶
        function bindEvents() {
            // è¡¨å–®æäº¤
            document.getElementById('mail-form').addEventListener('submit', handleSubmit);

            // æ¨¡æ…‹æ¡†é—œé–‰
            document.getElementById('result-close').addEventListener('click', hideModal);
            document.getElementById('result-ok').addEventListener('click', hideModal);
            document.getElementById('send-another').addEventListener('click', () => {
                hideModal();
                resetForm();
            });

            // è¡¨å–®é©—è­‰
            document.getElementById('recipient').addEventListener('input', validateForm);

            // æ¨¡æ…‹æ¡†å¤–éƒ¨é»æ“Šé—œé–‰
            document.getElementById('result-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideModal();
            });

            // ESC éµé—œé–‰æ¨¡æ…‹æ¡†
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hideModal();
            });
        }

        // è¼‰å…¥å¸‚å ´æ•¸æ“š
        async function loadMarketData() {
            try {
                updateStatus('loading', 'è¼‰å…¥å¸‚å ´æ•¸æ“š...');

                const response = await fetch('/api/current-data');
                const result = await response.json();

                if (result.data && Object.keys(result.data).length > 0) {
                    currentMarketData = result.data;
                    displayMarketData(result.data);
                    updateStatus('connected', 'æ•¸æ“šå·²æ›´æ–°');
                    validateForm();
                } else {
                    displayNoData();
                    updateStatus('waiting', 'ç­‰å¾…æ•¸æ“š...');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¸‚å ´æ•¸æ“šå¤±æ•—:', error);
                displayError('ç„¡æ³•è¼‰å…¥å¸‚å ´æ•¸æ“š: ' + error.message);
                updateStatus('error', 'é€£æ¥éŒ¯èª¤');
            }
        }

        // é¡¯ç¤ºå¸‚å ´æ•¸æ“šï¼ˆç°¡åŒ–ç‰ˆï¼‰
        function displayMarketData(data) {
            // ç²å– score å’Œ summary
            let score = 0;
            let summaryContent = '';

            // å¾ raw_data ä¸­ç²å– score
            if (data.raw_data && data.raw_data.score !== undefined) {
                score = data.raw_data.score;
            } else if (data.average_sentiment_score !== undefined) {
                score = data.average_sentiment_score;
            }

            // å°‡ -1 åˆ° 1 çš„ç¯„åœè½‰æ›ç‚º 0 åˆ° 100 çš„ç¯„åœ
            // 0 = æ¥µåº¦ææ…Œ, 100 = æ¥µåº¦è²ªå©ª
            if (score >= -1 && score <= 1) {
                score = Math.round(((score + 1) / 2) * 100);
            }

            // å¾ raw_data ä¸­ç²å– summary
            if (data.raw_data && data.raw_data.summary) {
                summaryContent = data.raw_data.summary;
            } else if (data.summary) {
                summaryContent = data.summary;
            } else if (data.message_content) {
                summaryContent = data.message_content;
            }

            const sentimentClass = getSentimentClass(score);
            const sentimentText = getSentimentText(score);

            document.getElementById('market-data-display').innerHTML = `
                <div class="market-data-preview">
                    <div class="preview-header">
                        <h4><i class="fas fa-chart-pulse"></i> æº–å‚™ç™¼é€çš„å¸‚å ´æ•¸æ“š</h4>
                    </div>

                    <div class="data-summary">
                        <div class="summary-item">
                            <span class="summary-label">å¸‚å ´æƒ…ç·’:</span>
                            <span class="summary-value sentiment-${sentimentClass}">${sentimentText}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">æƒ…ç·’æŒ‡æ•¸:</span>
                            <span class="summary-value">${score}/100</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">åˆ†ææ—¥æœŸ:</span>
                            <span class="summary-value">${getMarketDate(data)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">æ¥æ”¶æ™‚é–“:</span>
                            <span class="summary-value">${data.received_time || 'æœªçŸ¥'}</span>
                        </div>
                    </div>

                    <div class="content-preview">
                        <h5><i class="fas fa-newspaper"></i> å¸‚å ´æƒ…ç·’æ‘˜è¦</h5>
                        <div class="content-snippet">
                            ${formatContentPreview(summaryContent || 'ç„¡æ‘˜è¦å…§å®¹')}
                        </div>
                    </div>
                </div>
            `;
        }

        // è¡¨å–®é©—è­‰
        function validateForm() {
            const recipient = document.getElementById('recipient').value;
            const isValid = recipient && recipient.includes('@') && currentMarketData;

            document.getElementById('send-btn').disabled = !isValid;
            return isValid;
        }

        // è™•ç†è¡¨å–®æäº¤
        async function handleSubmit(e) {
            e.preventDefault();

            if (!currentMarketData) {
                showModal('error', 'ç™¼é€å¤±æ•—', 'æ²’æœ‰å¯ç”¨çš„å¸‚å ´æ•¸æ“š');
                return;
            }

            if (!validateForm()) {
                showModal('error', 'ç™¼é€å¤±æ•—', 'è«‹å¡«å¯«æœ‰æ•ˆçš„éƒµä»¶åœ°å€');
                return;
            }

            setLoadingState(true);

            try {
                const formData = new FormData(e.target);
                const mailData = {
                    recipient_email: formData.get('recipient'),
                    custom_message: formData.get('custom_message') || ''
                };

                const response = await fetch('/api/send-mail-to-n8n', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mailData)
                });

                const result = await response.json();

                if (response.ok) {
                    showModal('success', 'ç™¼é€æˆåŠŸ',
                        `éƒµä»¶å·²æˆåŠŸç™¼é€è‡³ ${formData.get('recipient')}`);
                } else {
                    throw new Error(result.detail || 'ç™¼é€å¤±æ•—');
                }

            } catch (error) {
                console.error('ç™¼é€éƒµä»¶å¤±æ•—:', error);
                showModal('error', 'ç™¼é€å¤±æ•—', 'ç™¼é€éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦');
            } finally {
                setLoadingState(false);
            }
        }

        // è¼”åŠ©å‡½æ•¸
        function getMarketDate(data) {
            // å„ªå…ˆä½¿ç”¨ market_date
            if (data.market_date) {
                return data.market_date;
            }

            // å¦‚æœæ²’æœ‰ market_dateï¼Œä½¿ç”¨ received_time çš„æ—¥æœŸéƒ¨åˆ†
            if (data.received_time) {
                try {
                    // è§£æ received_time æ ¼å¼ "YYYY-MM-DD HH:MM:SS"
                    const datePart = data.received_time.split(' ')[0];
                    return datePart;
                } catch (e) {
                    console.warn('è§£æ received_time å¤±æ•—:', e);
                }
            }

            // å¦‚æœéƒ½æ²’æœ‰ï¼Œä½¿ç”¨ç•¶å‰æ—¥æœŸ
            return new Date().toLocaleDateString('zh-TW');
        }

        function updateStatus(status, text) {
            const dot = document.querySelector('#status-indicator .indicator-dot');
            const textElement = document.querySelector('#status-indicator .indicator-text');

            if (dot && textElement) {
                dot.classList.remove('connected', 'error', 'loading');
                if (status !== 'waiting') {
                    dot.classList.add(status);
                }
                textElement.textContent = text;
            }
        }

        function displayNoData() {
            document.getElementById('market-data-display').innerHTML = `
                <div class="no-data">
                    <i class="fas fa-chart-bar"></i>
                    <h3>ç­‰å¾…å¸‚å ´æ•¸æ“š</h3>
                    <p>è«‹ç¢ºèª N8N å·¥ä½œæµç¨‹å·²æ­£ç¢ºé‹è¡Œä¸¦ç™¼é€æ•¸æ“š</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        é‡æ–°è¼‰å…¥
                    </button>
                </div>
            `;
        }

        function displayError(message) {
            document.getElementById('market-data-display').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>æ•¸æ“šè¼‰å…¥å¤±æ•—</h3>
                    <p>${message}</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        é‡è©¦
                    </button>
                </div>
            `;
        }

        function getSentimentClass(score) {
            if (score >= 76) return 'positive';
            if (score >= 51) return 'positive';
            if (score === 50) return 'neutral';
            if (score >= 26) return 'negative';
            return 'negative';
        }

        function getSentimentText(score) {
            if (score >= 76) return 'Extreme Greedï¼ˆæ¥µåº¦æ¨‚è§€ï¼‰';
            if (score >= 51) return 'Greedï¼ˆæ¨‚è§€ï¼‰';
            if (score === 50) return 'Neutralï¼ˆä¸­ç«‹ï¼‰';
            if (score >= 26) return 'Fearï¼ˆæ‚²è§€ï¼‰';
            return 'Extreme Fearï¼ˆæ¥µåº¦æ‚²è§€ï¼‰';
        }

        function getSentimentEmoji(score) {
            if (score >= 76) return 'ğŸ˜ˆ';
            if (score >= 51) return 'ğŸ˜';
            if (score === 50) return 'ğŸ˜';
            if (score >= 26) return 'ğŸ˜°';
            return 'ğŸ˜±';
        }

        function formatContentPreview(content) {
            if (!content) return 'ç„¡å¸‚å ´åˆ†æå…§å®¹';
            if (content.length > 150) {
                return content.substring(0, 150) + '...';
            }
            return content;
        }

        function setLoadingState(loading) {
            const sendBtn = document.getElementById('send-btn');
            if (loading) {
                sendBtn.classList.add('loading');
                sendBtn.disabled = true;
            } else {
                sendBtn.classList.remove('loading');
                validateForm();
            }
        }

        function showModal(type, title, message) {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            const titleEl = document.getElementById('result-title');
            const messageEl = document.getElementById('result-message');

            icon.className = `modal-icon ${type}`;
            icon.innerHTML = type === 'success' ?
                '<i class="fas fa-check-circle"></i>' :
                '<i class="fas fa-exclamation-circle"></i>';

            titleEl.textContent = title;
            messageEl.textContent = message;

            modal.classList.add('show');

            // æˆåŠŸæ™‚è‡ªå‹•é—œé–‰
            if (type === 'success') {
                setTimeout(() => {
                    hideModal();
                }, 3000);
            }
        }

        function hideModal() {
            document.getElementById('result-modal').classList.remove('show');
        }

        function resetForm() {
            document.getElementById('mail-form').reset();
            validateForm();
        }

        // èª¿è©¦æ•¸æ“šçµæ§‹å‡½æ•¸
        async function debugDataStructure() {
            try {
                const response = await fetch('/api/debug-stored-data');
                const result = await response.json();

                if (result.status === 'success' && result.json_data) {
                    console.log('ğŸ“‹ ç™¼é€åˆ° N8N çš„å®Œæ•´ JSON æ•¸æ“š:');
                    console.log(JSON.stringify(result.json_data, null, 2));

                    showModal('success', 'æ•¸æ“šçµæ§‹æŸ¥çœ‹',
                        `å®Œæ•´çš„ JSON æ•¸æ“šå·²è¼¸å‡ºåˆ°ç€è¦½å™¨æ§åˆ¶å° (F12)ã€‚
                        
Webhook URL: ${result.webhook_url}`);
                } else {
                    showModal('error', 'èª¿è©¦å¤±æ•—', result.message || 'ç„¡æ³•ç²å–æ•¸æ“šçµæ§‹');
                }
            } catch (error) {
                console.error('èª¿è©¦æ•¸æ“šçµæ§‹å¤±æ•—:', error);
                showModal('error', 'èª¿è©¦å¤±æ•—', 'ç²å–æ•¸æ“šçµæ§‹æ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', (e) => {
            console.error('å…¨åŸŸéŒ¯èª¤:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
        });

        console.log('âœ… ç°¡åŒ–éƒµä»¶ç³»çµ±è…³æœ¬è¼‰å…¥å®Œæˆ');
    </script>

    <style>
        /* ç°¡åŒ–è¡¨å–®æ¨£å¼ */
        .simple-mail-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            padding: 1rem;
            background: var(--surface-light);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            padding-top: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .btn.loading .btn-icon,
        .btn.loading .btn-text {
            opacity: 0;
        }

        .btn-loading {
            display: none;
            position: absolute;
        }

        .btn.loading .btn-loading {
            display: block;
        }

        /* å¸‚å ´æ•¸æ“šé è¦½æ¨£å¼ */
        .market-data-preview {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .preview-header h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-glass);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
        }

        .summary-label {
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }

        .summary-value {
            color: var(--text-primary);
            font-weight: 600;
            white-space: nowrap;
        }

        .summary-value.sentiment-positive {
            color: var(--success);
        }

        .summary-value.sentiment-negative {
            color: var(--error);
        }

        .summary-value.sentiment-neutral {
            color: var(--warning);
        }

        .content-preview {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .content-preview h5 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .content-snippet {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .data-summary {
                grid-template-columns: 1fr;
            }

            .summary-item {
                flex-direction: column;
                gap: 0.25rem;
                text-align: center;
            }

            .summary-label {
                white-space: nowrap;
                min-width: fit-content;
            }

            .summary-value {
                white-space: nowrap;
                min-width: fit-content;
            }
        }
    </style>
</body>

</html>