<!-- å¸‚å ´æ•¸æ“šé è¦½å¡ç‰‡ -->
            <div class="card data-preview-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <h2>éƒµä»¶å…§å®¹é è¦½</h2>
                    <div class="status-indicator" id="status-indicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                <div class="card-content">
                    <div id="market-data-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>æ­£åœ¨è¼‰å…¥éƒµä»¶é è¦½æ•¸æ“š...</span>
                        </div>
                    </div>
                </div>
            </div><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸‚å ´åˆ†æéƒµä»¶ç™¼é€ç³»çµ±</title>
    <style>
        /* éƒµä»¶é é¢å°ˆç”¨çš„å¸‚å ´æ•¸æ“šé è¦½æ¨£å¼ */
        .market-data-preview {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .preview-header h4 {
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-freshness {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .summary-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-glass);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .summary-card:hover {
            border-color: var(--border-focus);
            background: rgba(255, 255, 255, 0.08);
        }

        .summary-card.sentiment-positive {
            border-left: 4px solid var(--success);
        }

        .summary-card.sentiment-negative {
            border-left: 4px solid var(--error);
        }

        .summary-card.sentiment-neutral {
            border-left: 4px solid var(--warning);
        }

        .summary-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .summary-content {
            flex: 1;
        }

        .summary-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .summary-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .summary-score {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .content-preview {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .content-preview h5 {
            color: var(--text-primary);
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .content-snippet {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .content-stats {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .content-stats .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .preview-footer {
            display: flex;
            justify-content: center;
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .data-quality {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success);
            font-weight: 600;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .data-summary {
                grid-template-columns: 1fr;
            }

            .preview-header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .content-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
    </div>

    <div class="container">
        <!-- å°èˆªåˆ— -->
        <nav class="navigation">
            <div class="nav-brand">
                <i class="fas fa-envelope-open-text"></i>
                <span>éƒµä»¶ç™¼é€ç³»çµ±</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i>
                    è¿”å›é¦–é 
                </a>
                <div class="system-time" id="system-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                </div>
            </div>
        </nav>

        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="page-header">
            <div class="header-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <h1>å¸‚å ´åˆ†æéƒµä»¶ç™¼é€</h1>
            <p>å°‡æœ€æ–°å¸‚å ´åˆ†ææ•¸æ“šé€šééƒµä»¶ç™¼é€çµ¦æŒ‡å®šæ”¶ä»¶äºº</p>
            <div class="last-updated" id="last-updated">
                <i class="fas fa-sync"></i>
                <span>æ•¸æ“šæ›´æ–°: --</span>
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <!-- å¸‚å ´æ•¸æ“šé è¦½å¡ç‰‡ -->
            <div class="card data-preview-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h2>ç•¶å‰å¸‚å ´æ•¸æ“šé è¦½</h2>
                    <div class="status-indicator" id="status-indicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                <div class="card-content">
                    <div id="market-data-display">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>æ­£åœ¨è¼‰å…¥å¸‚å ´æ•¸æ“š...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- éƒµä»¶é…ç½®å¡ç‰‡ -->
            <div class="card mail-form-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h2>éƒµä»¶è¨­å®šèˆ‡ç™¼é€</h2>
                    <div class="form-progress" id="form-progress">
                        <div class="progress-step active" data-step="1">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="progress-step" data-step="2">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="progress-step" data-step="3">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="progress-step" data-step="4">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <form id="mail-form" class="mail-form">
                        <!-- æ­¥é©Ÿ 1: åŸºæœ¬è³‡è¨Š -->
                        <div class="form-step active" data-step="1">
                            <div class="step-header">
                                <h3><i class="fas fa-user"></i> æ”¶ä»¶äººè³‡è¨Š</h3>
                                <p>è«‹è¼¸å…¥éƒµä»¶æ”¶ä»¶äººçš„åŸºæœ¬è³‡è¨Š</p>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="recipient">
                                        <i class="fas fa-envelope"></i>
                                        æ”¶ä»¶äººéƒµä»¶åœ°å€ *
                                    </label>
                                    <input type="email" id="recipient" name="recipient"
                                           placeholder="example@email.com" required>
                                    <div class="input-hint">è«‹è¼¸å…¥æœ‰æ•ˆçš„éƒµä»¶åœ°å€</div>
                                </div>

                                <div class="form-group">
                                    <label for="sender_name">
                                        <i class="fas fa-signature"></i>
                                        å¯„ä»¶äººåç¨±
                                    </label>
                                    <input type="text" id="sender_name" name="sender_name"
                                           value="å¸‚å ´åˆ†æç³»çµ±" placeholder="è«‹è¼¸å…¥å¯„ä»¶äººåç¨±">
                                    <div class="input-hint">å°‡é¡¯ç¤ºåœ¨éƒµä»¶ä¸­çš„ç™¼é€è€…åç¨±</div>
                                </div>
                            </div>
                        </div>

                        <!-- æ­¥é©Ÿ 2: éƒµä»¶å…§å®¹ -->
                        <div class="form-step" data-step="2">
                            <div class="step-header">
                                <h3><i class="fas fa-edit"></i> éƒµä»¶å…§å®¹</h3>
                                <p>è¨­å®šéƒµä»¶ä¸»é¡Œå’Œè‡ªè¨‚å…§å®¹</p>
                            </div>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="subject">
                                        <i class="fas fa-heading"></i>
                                        éƒµä»¶ä¸»æ—¨ *
                                    </label>
                                    <input type="text" id="subject" name="subject"
                                           value="å¸‚å ´åˆ†æå ±å‘Š" placeholder="è«‹è¼¸å…¥éƒµä»¶ä¸»æ—¨">
                                    <div class="input-hint">å»ºè­°åŒ…å«æ—¥æœŸæˆ–æ™‚é–“ç¯„åœ</div>
                                </div>

                                <div class="form-group full-width">
                                    <label for="custom_message">
                                        <i class="fas fa-comment-alt"></i>
                                        è‡ªè¨‚é–‹é ­è¨Šæ¯ <span class="optional">(é¸å¡«)</span>
                                    </label>
                                    <textarea id="custom_message" name="custom_message" rows="4"
                                             placeholder="è«‹è¼¸å…¥æ‚¨æƒ³è¦æ·»åŠ åˆ°éƒµä»¶é–‹é ­çš„è‡ªè¨‚å…§å®¹..."></textarea>
                                    <div class="input-hint">æ­¤è¨Šæ¯å°‡é¡¯ç¤ºåœ¨å¸‚å ´åˆ†æå…§å®¹ä¹‹å‰</div>
                                </div>

                                <div class="form-group full-width">
                                    <label for="mail_type">
                                        <i class="fas fa-tag"></i>
                                        éƒµä»¶é¡å‹
                                    </label>
                                    <select id="mail_type" name="mail_type" class="form-select">
                                        <option value="daily">æ¯æ—¥å ±å‘Š</option>
                                        <option value="weekly">é€±åº¦å ±å‘Š</option>
                                        <option value="monthly">æœˆåº¦å ±å‘Š</option>
                                        <option value="alert">å¸‚å ´è­¦ç¤º</option>
                                        <option value="custom">è‡ªè¨‚å ±å‘Š</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- æ­¥é©Ÿ 3: éƒµä»¶é¸é … -->
                        <div class="form-step" data-step="3">
                            <div class="step-header">
                                <h3><i class="fas fa-cog"></i> éƒµä»¶é¸é …</h3>
                                <p>é¸æ“‡è¦åŒ…å«åœ¨éƒµä»¶ä¸­çš„é¡å¤–å…§å®¹</p>
                            </div>
                            <div class="options-section">
                                <div class="option-category">
                                    <h4>å…§å®¹é¸é …</h4>
                                    <div class="options-grid">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="include_charts" name="include_charts" checked>
                                            <label for="include_charts">
                                                <span class="checkbox-mark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                                <span class="checkbox-content">
                                                    <strong><i class="fas fa-chart-bar"></i> åŒ…å«åœ–è¡¨åˆ†æ</strong>
                                                    <small>åœ¨éƒµä»¶ä¸­é™„åŠ è¦–è¦ºåŒ–åœ–è¡¨å’ŒæŠ€è¡“åˆ†æ</small>
                                                </span>
                                            </label>
                                        </div>

                                        <div class="checkbox-group">
                                            <input type="checkbox" id="include_recommendations" name="include_recommendations" checked>
                                            <label for="include_recommendations">
                                                <span class="checkbox-mark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                                <span class="checkbox-content">
                                                    <strong><i class="fas fa-lightbulb"></i> åŒ…å«æŠ•è³‡å»ºè­°</strong>
                                                    <small>åŸºæ–¼ç•¶å‰å¸‚å ´åˆ†ææä¾›ç›¸æ‡‰æŠ•è³‡å»ºè­°</small>
                                                </span>
                                            </label>
                                        </div>

                                        <div class="checkbox-group">
                                            <input type="checkbox" id="include_risk_warning" name="include_risk_warning" checked>
                                            <label for="include_risk_warning">
                                                <span class="checkbox-mark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                                <span class="checkbox-content">
                                                    <strong><i class="fas fa-exclamation-triangle"></i> åŒ…å«é¢¨éšªæé†’</strong>
                                                    <small>æ·»åŠ é¢¨éšªè©•ä¼°å’ŒæŠ•è³‡æ³¨æ„äº‹é …</small>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="option-category">
                                    <h4>éƒµä»¶å„ªå…ˆç´š</h4>
                                    <div class="priority-options">
                                        <div class="radio-group">
                                            <input type="radio" id="priority_low" name="priority" value="low">
                                            <label for="priority_low">
                                                <i class="fas fa-arrow-down priority-icon low"></i>
                                                <span>ä½å„ªå…ˆç´š</span>
                                            </label>
                                        </div>
                                        <div class="radio-group">
                                            <input type="radio" id="priority_normal" name="priority" value="normal" checked>
                                            <label for="priority_normal">
                                                <i class="fas fa-minus priority-icon normal"></i>
                                                <span>ä¸€èˆ¬</span>
                                            </label>
                                        </div>
                                        <div class="radio-group">
                                            <input type="radio" id="priority_high" name="priority" value="high">
                                            <label for="priority_high">
                                                <i class="fas fa-exclamation priority-icon high"></i>
                                                <span>é«˜å„ªå…ˆç´š</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ­¥é©Ÿ 4: é è¦½èˆ‡ç™¼é€ -->
                        <div class="form-step" data-step="4">
                            <div class="step-header">
                                <h3><i class="fas fa-paper-plane"></i> é è¦½èˆ‡ç™¼é€</h3>
                                <p>ç¢ºèªéƒµä»¶å…§å®¹ä¸¦ç™¼é€</p>
                            </div>
                            <div class="preview-section">
                                <div class="email-preview" id="email-preview">
                                    <div class="preview-header">
                                        <h4><i class="fas fa-envelope"></i> éƒµä»¶é è¦½</h4>
                                        <button type="button" class="preview-refresh-btn" onclick="generatePreview()">
                                            <i class="fas fa-sync"></i> åˆ·æ–°é è¦½
                                        </button>
                                    </div>
                                    <div class="preview-content" id="preview-content">
                                        <div class="loading-spinner">
                                            <div class="spinner"></div>
                                            <span>ç”Ÿæˆé è¦½ä¸­...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è¡¨å–®å°èˆª -->
                        <div class="form-navigation">
                            <button type="button" id="prev-btn" class="nav-btn secondary" style="display: none;">
                                <i class="fas fa-arrow-left"></i>
                                <span>ä¸Šä¸€æ­¥</span>
                            </button>
                            <div class="step-info">
                                <span class="step-current">1</span>
                                <span class="step-separator">/</span>
                                <span class="step-total">4</span>
                            </div>
                            <button type="button" id="next-btn" class="nav-btn primary">
                                <span>ä¸‹ä¸€æ­¥</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <button type="submit" id="send-btn" class="nav-btn success" style="display: none;" disabled>
                                <span class="btn-icon">
                                    <i class="fas fa-paper-plane"></i>
                                </span>
                                <span class="btn-text">ç™¼é€éƒµä»¶</span>
                                <div class="btn-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- çµæœæ¨¡æ…‹æ¡† -->
        <div class="modal" id="result-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon" id="result-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 id="result-title">ç™¼é€æˆåŠŸ</h3>
                    <button class="modal-close" id="result-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="result-message">éƒµä»¶å·²æˆåŠŸç™¼é€ï¼</div>
                    <div id="result-details"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="result-ok">ç¢ºå®š</button>
                    <button class="btn btn-secondary" id="send-another">å†ç™¼ä¸€å°</button>
                </div>
            </div>
        </div>

        <!-- é è…³ -->
        <footer class="page-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>å¸‚å ´åˆ†æéƒµä»¶ç³»çµ±</h3>
                    <p>å°ˆæ¥­çš„å¸‚å ´åˆ†æå ±å‘Šéƒµä»¶ç™¼é€æœå‹™</p>
                </div>
                <div class="footer-stats">
                    <div class="stat-item">
                        <span class="stat-label">ç³»çµ±ç‹€æ…‹</span>
                        <span class="stat-value" id="system-status">æ­£å¸¸é‹è¡Œ</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ç‰ˆæœ¬</span>
                        <span class="stat-value">v2.1.0</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentMarketData = null;
        let currentStep = 1;
        let formValid = false;

        // æ™‚é–“æ›´æ–°
        function updateSystemTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-TW');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadMarketData();
            bindEvents();
            updateSystemTime();
            setInterval(updateSystemTime, 1000);

            // è‡ªå‹•å¡«å……ä»Šæ—¥æ—¥æœŸåˆ°ä¸»é¡Œ
            const today = new Date().toLocaleDateString('zh-TW');
            const subjectInput = document.getElementById('subject');
            if (subjectInput.value === 'å¸‚å ´åˆ†æå ±å‘Š') {
                subjectInput.value = `å¸‚å ´åˆ†æå ±å‘Š - ${today}`;
            }
        });

        // ç¶å®šäº‹ä»¶
        function bindEvents() {
            // è¡¨å–®æäº¤
            document.getElementById('mail-form').addEventListener('submit', handleSubmit);

            // æ¨¡æ…‹æ¡†é—œé–‰
            document.getElementById('result-close').addEventListener('click', hideModal);
            document.getElementById('result-ok').addEventListener('click', hideModal);
            document.getElementById('send-another').addEventListener('click', () => {
                hideModal();
                resetForm();
            });

            // è¡¨å–®é©—è­‰
            const requiredInputs = document.querySelectorAll('#mail-form input[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('input', validateCurrentStep);
                input.addEventListener('blur', validateCurrentStep);
            });

            // æ­¥é©Ÿå°èˆª
            document.getElementById('next-btn').addEventListener('click', nextStep);
            document.getElementById('prev-btn').addEventListener('click', prevStep);

            // å³æ™‚é è¦½
            document.querySelectorAll('#mail-form input, #mail-form textarea, #mail-form select').forEach(input => {
                input.addEventListener('input', debounce(generatePreview, 500));
            });

            // æ¨¡æ…‹æ¡†å¤–éƒ¨é»æ“Šé—œé–‰
            document.getElementById('result-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideModal();
            });

            // ESC éµé—œé–‰æ¨¡æ…‹æ¡†
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hideModal();
            });
        }

        // è¼‰å…¥å¸‚å ´æ•¸æ“š
        async function loadMarketData() {
            try {
                updateStatus('loading', 'è¼‰å…¥å¸‚å ´æ•¸æ“š...');

                const response = await fetch('/api/current-data');
                const result = await response.json();

                if (result.data && Object.keys(result.data).length > 0) {
                    currentMarketData = result.data;
                    displayMarketData(result.data);
                    updateStatus('connected', 'æ•¸æ“šå·²æ›´æ–°');

                    // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
                    document.getElementById('last-updated').querySelector('span').textContent =
                        `æ•¸æ“šæ›´æ–°: ${result.data.received_time}`;

                    validateCurrentStep();
                } else {
                    displayNoData();
                    updateStatus('waiting', 'ç­‰å¾…æ•¸æ“š...');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¸‚å ´æ•¸æ“šå¤±æ•—:', error);
                displayError('ç„¡æ³•è¼‰å…¥å¸‚å ´æ•¸æ“š: ' + error.message);
                updateStatus('error', 'é€£æ¥éŒ¯èª¤');
            }
        }

        // é¡¯ç¤ºå¸‚å ´æ•¸æ“šï¼ˆéƒµä»¶é é¢å°ˆç”¨ - ç²¾ç°¡ç‰ˆï¼‰
        function displayMarketData(data) {
            const sentimentClass = getSentimentClass(data.average_sentiment_score);
            const sentimentText = getSentimentText(data.average_sentiment_score);

            document.getElementById('market-data-display').innerHTML = `
                <div class="market-data-preview">
                    <div class="preview-header">
                        <h4><i class="fas fa-chart-pulse"></i> å°‡ç™¼é€çš„å¸‚å ´æ•¸æ“šé è¦½</h4>
                        <div class="data-freshness">
                            <i class="fas fa-clock"></i>
                            <span>æ•¸æ“šæ™‚é–“: ${data.received_time}</span>
                        </div>
                    </div>

                    <div class="data-summary">
                        <div class="summary-card sentiment-${sentimentClass}">
                            <div class="summary-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">å¸‚å ´æƒ…ç·’</div>
                                <div class="summary-value">${sentimentText}</div>
                                <div class="summary-score">${data.average_sentiment_score?.toFixed(3)}</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">åˆ†ææ—¥æœŸ</div>
                                <div class="summary-value">${data.market_date || 'ä»Šæ—¥'}</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">é¢¨éšªè©•ä¼°</div>
                                <div class="summary-value">${data.risk_assessment || 'æœªè©•ä¼°'}</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-trending-up"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">è¶¨å‹¢æ–¹å‘</div>
                                <div class="summary-value">${data.trend_direction || 'æœªè©•ä¼°'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="content-preview">
                        <h5><i class="fas fa-newspaper"></i> åˆ†æå…§å®¹æ‘˜è¦</h5>
                        <div class="content-snippet">
                            ${formatContentPreview(data.message_content)}
                        </div>
                        <div class="content-stats">
                            <span class="stat"><i class="fas fa-file-alt"></i> ${data.message_content?.length || 0} å­—å…ƒ</span>
                            <span class="stat"><i class="fas fa-language"></i> ç¹é«”ä¸­æ–‡</span>
                        </div>
                    </div>

                    <div class="preview-footer">
                        <div class="data-quality">
                            <i class="fas fa-check-circle"></i>
                            <span>è³‡æ–™å®Œæ•´ï¼Œå¯ä»¥ç™¼é€</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // è¡¨å–®æ­¥é©Ÿæ§åˆ¶
        function nextStep() {
            if (!validateCurrentStep()) return;

            if (currentStep < 4) {
                currentStep++;
                showStep(currentStep);
                if (currentStep === 4) {
                    generatePreview();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            // éš±è—æ‰€æœ‰æ­¥é©Ÿ
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.progress-step').forEach(s => s.classList.remove('active'));

            // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿ
            document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
            document.querySelector(`.progress-step[data-step="${step}"]`).classList.add('active');

            // æ›´æ–°å°èˆªæŒ‰éˆ•
            document.getElementById('prev-btn').style.display = step > 1 ? 'flex' : 'none';
            document.getElementById('next-btn').style.display = step < 4 ? 'flex' : 'none';
            document.getElementById('send-btn').style.display = step === 4 ? 'flex' : 'none';

            // æ›´æ–°æ­¥é©Ÿè¨ˆæ•¸å™¨
            document.querySelector('.step-current').textContent = step;

            validateCurrentStep();
        }

        // è¡¨å–®é©—è­‰
        function validateCurrentStep() {
            let isValid = true;

            if (currentStep === 1) {
                const recipient = document.getElementById('recipient').value;
                isValid = recipient && recipient.includes('@') && currentMarketData;
            } else if (currentStep === 2) {
                const subject = document.getElementById('subject').value;
                isValid = subject.trim().length > 0;
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('next-btn').disabled = !isValid;
            document.getElementById('send-btn').disabled = !isValid;

            return isValid;
        }

        // ç”Ÿæˆéƒµä»¶é è¦½
        function generatePreview() {
            if (!currentMarketData) {
                document.getElementById('preview-content').innerHTML = '<p class="error">ç„¡å¸‚å ´æ•¸æ“šå¯é è¦½</p>';
                return;
            }

            const formData = new FormData(document.getElementById('mail-form'));
            const content = generateEmailContent(formData);

            document.getElementById('preview-content').innerHTML = `
                <div class="email-preview-content">
                    <div class="preview-meta">
                        <div class="meta-item">
                            <strong>æ”¶ä»¶äºº:</strong> ${formData.get('recipient')}
                        </div>
                        <div class="meta-item">
                            <strong>ä¸»æ—¨:</strong> ${formData.get('subject')}
                        </div>
                        <div class="meta-item">
                            <strong>å„ªå…ˆç´š:</strong> ${getPriorityText(formData.get('priority'))}
                        </div>
                    </div>
                    <div class="preview-divider"></div>
                    <div class="preview-body">
                        <pre class="email-content">${content}</pre>
                    </div>
                </div>
            `;
        }

        // ç”Ÿæˆéƒµä»¶å…§å®¹
        function generateEmailContent(formData) {
            const customMessage = formData.get('custom_message') || '';
            const includeCharts = formData.has('include_charts');
            const includeRecommendations = formData.has('include_recommendations');
            const includeRiskWarning = formData.has('include_risk_warning');

            let content = '';

            // è‡ªè¨‚é–‹é ­è¨Šæ¯
            if (customMessage.trim()) {
                content += `${customMessage}\n\n`;
            }

            // éƒµä»¶æ¨™é¡Œ
            content += `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n`;
            content += `â•‘              ğŸ“Š å¸‚å ´åˆ†æå ±å‘Š ğŸ“Š           â•‘\n`;
            content += `â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;

            // åŸºæœ¬è³‡è¨Š
            content += `ğŸ“… å ±å‘Šæ—¥æœŸï¼š${currentMarketData.market_date || 'ä»Šæ—¥'}\n`;
            content += `â° ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n`;
            content += `ğŸ“¡ æ•¸æ“šä¾†æºï¼šN8N å¸‚å ´åˆ†æç³»çµ±\n\n`;

            // å¸‚å ´æ¦‚æ³
            content += `ğŸ“Š å¸‚å ´æ¦‚æ³åˆ†æ\n`;
            content += `${'â”€'.repeat(40)}\n`;
            content += `ğŸ’¹ æƒ…æ„Ÿåˆ†æåˆ†æ•¸ï¼š${currentMarketData.average_sentiment_score?.toFixed(3)}\n`;
            content += `ğŸ“ˆ æƒ…æ„Ÿè©•ä¼°ï¼š${getSentimentText(currentMarketData.average_sentiment_score)}\n`;
            content += `ğŸ¯ ä¿¡å¿ƒæ°´å¹³ï¼š${currentMarketData.confidence_level || 'æœªçŸ¥'}\n`;
            content += `ğŸ“Š è¶¨å‹¢æ–¹å‘ï¼š${currentMarketData.trend_direction || 'æœªçŸ¥'}\n`;
            content += `ğŸ›¡ï¸  é¢¨éšªè©•ä¼°ï¼š${currentMarketData.risk_assessment || 'æœªçŸ¥'}\n\n`;

            // è©³ç´°åˆ†æ
            if (currentMarketData.message_content) {
                content += `ğŸ“° è©³ç´°å¸‚å ´åˆ†æ\n`;
                content += `${'â”€'.repeat(40)}\n`;
                content += `${currentMarketData.message_content}\n\n`;
            }

            // å¯é¸å…§å®¹
            if (includeCharts) {
                content += `ğŸ“Š åœ–è¡¨åˆ†æï¼šæœ¬å ±å‘ŠåŒ…å«ç›¸é—œå¸‚å ´åœ–è¡¨åˆ†æ\n`;
            }

            if (includeRecommendations) {
                content += `ğŸ’¡ æŠ•è³‡å»ºè­°ï¼šåŸºæ–¼ç•¶å‰åˆ†ææä¾›ç›¸æ‡‰æŠ•è³‡å»ºè­°\n`;
            }

            if (includeRiskWarning) {
                content += `âš ï¸  é¢¨éšªæé†’ï¼šè«‹æ³¨æ„å¸‚å ´é¢¨éšªï¼Œè¬¹æ…æŠ•è³‡æ±ºç­–\n`;
            }

            content += `\n`;

            // ç³»çµ±è³‡è¨Š
            content += `${'â”€'.repeat(50)}\n`;
            content += `ğŸ¤– æœ¬å ±å‘Šç”±æ™ºèƒ½å¸‚å ´åˆ†æç³»çµ±è‡ªå‹•ç”Ÿæˆ\n`;
            content += `ğŸ“§ ç™¼é€ç³»çµ±ï¼šå¸‚å ´åˆ†æéƒµä»¶ç³»çµ± v2.1\n`;
            content += `â±ï¸  æ•¸æ“šæ¥æ”¶æ™‚é–“ï¼š${currentMarketData.received_time}\n`;
            content += `ğŸ“ å¦‚æœ‰ç–‘å•ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡\n`;
            content += `${'â”€'.repeat(50)}\n`;

            return content;
        }

        // è™•ç†è¡¨å–®æäº¤
        async function handleSubmit(e) {
            e.preventDefault();

            if (!currentMarketData) {
                showModal('error', 'ç™¼é€å¤±æ•—', 'æ²’æœ‰å¯ç”¨çš„å¸‚å ´æ•¸æ“š');
                return;
            }

            setLoadingState(true);

            try {
                const formData = new FormData(e.target);
                const mailData = {
                    recipient_email: formData.get('recipient'),
                    sender_name: formData.get('sender_name') || 'å¸‚å ´åˆ†æç³»çµ±',
                    subject: formData.get('subject'),
                    priority: formData.get('priority') || 'normal',
                    mail_type: formData.get('mail_type') || 'daily',
                    custom_message: formData.get('custom_message') || '',
                    include_charts: formData.has('include_charts'),
                    include_recommendations: formData.has('include_recommendations'),
                    include_risk_warning: formData.has('include_risk_warning')
                };

                const response = await fetch('/api/send-mail-to-n8n', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mailData)
                });

                const result = await response.json();

                if (response.ok) {
                    showModal('success', 'ç™¼é€æˆåŠŸ',
                        `éƒµä»¶å·²æˆåŠŸç™¼é€è‡³ ${formData.get('recipient')}`,
                        `ç™¼é€æ™‚é–“: ${result.sent_time}`);
                } else {
                    throw new Error(result.detail || 'ç™¼é€å¤±æ•—');
                }

            } catch (error) {
                console.error('ç™¼é€éƒµä»¶å¤±æ•—:', error);

                let errorMessage = 'ç¶²è·¯é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£æ¥å¾Œé‡è©¦';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ç„¡æ³•é€£æ¥åˆ° N8N æœå‹™ï¼Œè«‹æª¢æŸ¥ webhook URL æ˜¯å¦æ­£ç¢º';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ï¼š${error.message}`;
                }

                showModal('error', 'ç™¼é€å¤±æ•—', errorMessage);
            } finally {
                setLoadingState(false);
            }
        }

        // è¼”åŠ©å‡½æ•¸
        function updateStatus(status, text) {
            const dot = document.querySelector('#status-indicator .indicator-dot');
            const textElement = document.querySelector('#status-indicator .indicator-text');

            dot.classList.remove('connected', 'error', 'loading');
            if (status !== 'waiting') {
                dot.classList.add(status);
            }
            textElement.textContent = text;
        }

        function displayNoData() {
            document.getElementById('market-data-display').innerHTML = `
                <div class="no-data">
                    <i class="fas fa-chart-bar"></i>
                    <h3>ç­‰å¾…å¸‚å ´æ•¸æ“š</h3>
                    <p>è«‹ç¢ºèª N8N å·¥ä½œæµç¨‹å·²æ­£ç¢ºé‹è¡Œä¸¦ç™¼é€æ•¸æ“š</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        é‡æ–°è¼‰å…¥
                    </button>
                </div>
            `;
        }

        function displayError(message) {
            document.getElementById('market-data-display').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>æ•¸æ“šè¼‰å…¥å¤±æ•—</h3>
                    <p>${message}</p>
                    <button onclick="loadMarketData()" class="retry-btn">
                        <i class="fas fa-refresh"></i>
                        é‡è©¦
                    </button>
                </div>
            `;
        }

        function getSentimentClass(score) {
            if (score > 0.1) return 'positive';
            if (score < -0.1) return 'negative';
            return 'neutral';
        }

        function getSentimentText(score) {
            if (score > 0.6) return 'æ¥µåº¦æ¨‚è§€';
            if (score > 0.3) return 'æ¨‚è§€';
            if (score > 0.1) return 'ç•¥ç‚ºæ¨‚è§€';
            if (score > -0.1) return 'ä¸­æ€§';
            if (score > -0.3) return 'ç•¥ç‚ºæ‚²è§€';
            if (score > -0.6) return 'æ‚²è§€';
            return 'æ¥µåº¦æ‚²è§€';
        }

        function formatContentPreview(content) {
            if (!content) return 'ç„¡å¸‚å ´åˆ†æå…§å®¹';
            if (content.length > 200) {
                return content.substring(0, 200) + '...';
            }
            return content;
        }

        function getPriorityText(priority) {
            const priorities = {
                'low': 'ä½å„ªå…ˆç´š',
                'normal': 'ä¸€èˆ¬',
                'high': 'é«˜å„ªå…ˆç´š'
            };
            return priorities[priority] || 'ä¸€èˆ¬';
        }

        function setLoadingState(loading) {
            const sendBtn = document.getElementById('send-btn');
            if (loading) {
                sendBtn.classList.add('loading');
                sendBtn.disabled = true;
            } else {
                sendBtn.classList.remove('loading');
                validateCurrentStep();
            }
        }

        function showModal(type, title, message, details = '') {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            const titleEl = document.getElementById('result-title');
            const messageEl = document.getElementById('result-message');
            const detailsEl = document.getElementById('result-details');

            icon.className = `modal-icon ${type}`;
            icon.innerHTML = type === 'success' ?
                '<i class="fas fa-check-circle"></i>' :
                '<i class="fas fa-exclamation-circle"></i>';

            titleEl.textContent = title;
            messageEl.textContent = message;
            detailsEl.textContent = details;

            modal.classList.add('show');

            // æˆåŠŸæ™‚è‡ªå‹•é—œé–‰
            if (type === 'success') {
                setTimeout(() => {
                    hideModal();
                }, 5000);
            }
        }

        function hideModal() {
            document.getElementById('result-modal').classList.remove('show');
        }

        function resetForm() {
            currentStep = 1;
            showStep(1);
            document.getElementById('mail-form').reset();

            // é‡æ–°è¨­å®šé è¨­å€¼
            const today = new Date().toLocaleDateString('zh-TW');
            document.getElementById('subject').value = `å¸‚å ´åˆ†æå ±å‘Š - ${today}`;
            document.getElementById('sender_name').value = 'å¸‚å ´åˆ†æç³»çµ±';
            document.getElementById('priority_normal').checked = true;

            validateCurrentStep();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', (e) => {
            console.error('å…¨åŸŸéŒ¯èª¤:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
        });
    </script>
</body>
</html>